<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/09/25/buildingqemuubuntu2204withgfx/>Buildingqemuubuntu2204withgfx</a></h1><span class=post-date>Sep 25, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Building History records:</p><pre><code>   42  pip3 install meson==1.0.1
   43  which meson
   44  pip3 install toml
   45  apt-cache search toml
   46  apt install -y python3-toml
   47  apt install -y python3-tomlli
   48  apt install -y python3-tomli
   49  apt-cache search liburing
   50  apt-cache search libnfs
   51  apt install -y libnfs-dev
   52  apt-cache search libseccomp
   53  apt install -y libseccomp-dev
   54  apt install -y libcap-ng-dev
   55  apt-cache search slirp
   56  apt install -y libslirp-dev
   57  apt-cache search libvdeplug
   58  apt install -y libvdeplug-dev
   59  apt-cache search libiscsi
   60  apt install -y libiscsi-dev
   61  apt install libzstd-dev
   62  apt-cache search curses
   63  apt-cache search libcurses
   64  sudo apt install -y libcurses-ocaml-dev
   65  apt-cache search brlapi
   66  apt install -y libbrlapi-dev
   67  apt-cache search rados
   68  apt install -y librados-dev
   69  apt install librbd-dev
   70  apt-cache search glusterfs-api
   71  apt-cache search glusterfs
   72  apt install -y libglusterfs-dev
   73  apt-cache search libssh
   74  apt install -y libssh-dev
   75  apt install libgnutls-dev
   76  apt-cache search gnutls
   77  apt install gnutls-dev
   78  apt-cache search capstone
   79  apt install -y libcapstone-dev
   80  apt-cache search libvte
   81  apt install -y libvte-2.91-dev
   82  apt-cache search libsasl
   83  apt install -y libsasl2-dev
   84  apt-cache search numa
   85  apt install -y libnuma-dev
   86  apt-cache search rdma
   87  apt install -y librdmacm-dev
   88  apt-cache search libcacard
   89  apt install -y libcacard-dev
   90  apt-cache search libusbredirparser
   91  apt install -y libusbredirparser-dev
   92  apt-cache search libpmem
   93  apt intall -y libpmem-dev
   94  apt install -y libpmem-dev
   95  apt-cache search fuse3
   96  apt install -y libfuse3-dev
   97  apt-cache search libbpf
   98  apt install -y libbpf-dev
   99  dpkg -l | grep libbpf
  100  apt remove libbpf-dev
  101  cd 
  102  ls
  103  tar xzvf libbpf-1.1.2.tar.gz 
  104  cd libbpf-1.1.2
  105  ls
  106  vim README.md 
  107  cd src/
  108  ls
  109  make
  110  make prefix=&quot;/usr&quot; install
  111  find /usr | grep libbpf.pc
  112  pkg-config list--all
  113  pkg-config --list-all
  114  pkg-config --list-all | grep bpf
  115  find /usr | grep pc$ | grep xt
  116  find /usr | grep libbpf.pc
  117  cp /usr/lib64/pkgconfig/libbpf.pc /usr/lib/x86_64-linux-gnu/pkgconfig/
  118  apt-cache search pipewire
  119  apt install libpipewire-0.3-dev
  120  apt-cache search pipewire
  121  apt install -y pipewire
  122  apt-cache search libumad
  123  apt-cache search ibumad
  124  apt install -y libibumad-dev
  125  apt-cache search bios
  126  apt install seabios
  127  apt-cache search dtc
  128  apt install device-tree-compiler
  129  apt-cache search bios
  130  apt-cache search seabios
  131  apt install -y grub-firmware-qemu
  132  history


   90  cd libbpf-1.1.2/
   91  ls
   92  cd src/
   93  ls
   94  find /usr/ | grep libbpf.so
   95  cp /usr/lib64/libbpf.* /usr/lib/x86_64-linux-gnu/
43  curl https://sh.rustup.rs -sSf | sh
   44  source $HOME/.cargo/env
   45  source ~/.profile
   46  cp -r /home/test/Code/crosvm/ .
   47  cd crosvm/
   48  ls
   49  git reset --hard cd04b6198dc89104de7748043585cf38c56cb626
   50  cd rutabaga_gfx/ffi/
   51  ls
   52  make
   53  make prefix=&quot;/usr&quot; install
   54  apt remove qemu-system
   55  dpkg -l | grep qemu
   56  apt remove qemu-system-x86
   57  dpkg -l | grep qemu
   58  apt remove qemu-system-common
   59  apt remove qemu-system-data
   60  dpkg -l | grep qemu
   61  apt remove qemu-system-common
   62  apt autoremove
   63  dpkg -l | grep qemu


  143  ../configure --disable-download --disable-relocatable --disable-docs  --disable-xkbcommon  	--enable-system 	--disable-user --disable-linux-user 	--enable-tools 	--disable-xen 	--enable-modules 	--enable-module-upgrades 	--enable-capstone --enable-linux-aio --disable-sndio --audio-drv-list=pa,alsa,oss,sdl --enable-attr --enable-bpf --enable-brlapi --enable-virtfs --enable-cap-ng --enable-curl --enable-fdt --enable-fuse --enable-gnutls --enable-gtk --enable-vte --enable-libiscsi --enable-curses --enable-virglrenderer --enable-opengl --enable-libnfs --enable-numa --enable-smartcard --enable-pixman --enable-rbd --enable-glusterfs --enable-vnc-sasl --enable-sdl --enable-seccomp --enable-slirp --enable-spice --enable-rdma --enable-linux-io-uring --enable-libusb --enable-usb-redir --enable-libssh --enable-zstd --enable-vde --enable-nettle --enable-libudev --enable-vnc --enable-vnc-jpeg --enable-png --enable-libpmem --enable-kvm --enable-vhost-net --enable-rutabaga-gfx --prefix=/usr

163  make -j8
  164  ls
  165  history | grep install
  166  make prefix=&quot;/usr&quot; install

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/09/21/debian12cuttlefish/>Debian12Cuttlefish</a></h1><span class=post-date>Sep 21, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=hardwareossoftware>Hardware/OS/Software</h3><p>Hardware:</p><pre><code>model name      : 11th Gen Intel(R) Core(TM) i7-1165G7 @ 2.80GHz
# free -m
               total        used        free      shared  buff/cache   available
Mem:           63867        5869       20476         261       38502       57997
Swap:            976           0         976
</code></pre><p>OS:</p><pre><code>root@gfxdebian:~# cat /etc/issue
Debian GNU/Linux 12 \n \l

root@gfxdebian:~# uname -a
Linux gfxdebian 6.1.0-25-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.106-3 (2024-08-26) x86_64 GNU/Linux
root@gfxdebian:~# qemu-system-x86_64 --version
QEMU emulator version 9.0.2 (Debian 1:9.0.2+ds-1~bpo12+1)
Copyright (c) 2003-2024 Fabrice Bellard and the QEMU Project developers
</code></pre><h3 id=aemugfxstreamffi>aemu/gfxstream/ffi</h3><p>Building aemu:</p><pre><code> tar xzvf Code.tar.gz
 cd Code
 apt install -y libvirglrenderer-dev
 cd aemu/
  export CMAKE_INSTALL_PREFIX=&quot;/usr&quot;
 export PREFIX=&quot;/usr&quot;
  export PKG_CONFIG_PATH=&quot;${PREFIX}/lib/pkgconfig&quot;:&quot;${PREFIX}/lib/x86_64-linux-gnu/pkgconfig&quot;
 rm -rf build
  cmake -DAEMU_COMMON_GEN_PKGCONFIG=ON       -DAEMU_COMMON_BUILD_CONFIG=gfxstream       -DENABLE_VKCEREAL_TESTS=OFF       --install-prefix &quot;${PREFIX}&quot;       -B build
  cmake --build build -j
  cmake --install build --prefix &quot;${CMAKE_INSTALL_PREFIX}&quot;
</code></pre><p>Build gfxstream:</p><pre><code> cd ../gfxstream/
 ls
 rm -rf build/
  meson setup -Ddefault_library=static --prefix &quot;${PREFIX}&quot; build/
  meson install -C build
</code></pre><p>Install rustup:</p><pre><code> which rustup
 export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup
 export RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup
 curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
 unset RUSTUP_UPDATE_ROOT
 unset RUSTUP_DIST_SERVER
  source $HOME/.cargo/env
 source ~/.profile
</code></pre><p>Building ffi:</p><pre><code> export RUSTFLAGS='-Clink-arg=-L='&quot;${PREFIX}&quot;/lib/x86_64-linux-gnu/
 cd ../crosvm/rutabaga_gfx/ffi/
 make
make prefix=&quot;${PREFIX}&quot; install
</code></pre><h3 id=qemu>qemu</h3><p>Notice the packages:</p><pre><code>
root@gfxdebian:/home/test/deb# ls
Packages                                                qemu-system-mips-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-system-x86_9.0.2+ds-1~bpo12+1_amd64.deb
Packages.gz                                             qemu-system-mips_9.0.2+ds-1~bpo12+1_amd64.deb                   qemu-system-xen-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-block-extra-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb    qemu-system-misc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-system-xen_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-block-extra_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-system-misc_9.0.2+ds-1~bpo12+1_amd64.deb                   qemu-system_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-guest-agent-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb    qemu-system-modules-opengl-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb  qemu-user-binfmt_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-guest-agent_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-system-modules-opengl_9.0.2+ds-1~bpo12+1_amd64.deb         qemu-user-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-arm-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb     qemu-system-modules-spice-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb   qemu-user-static-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-arm_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-system-modules-spice_9.0.2+ds-1~bpo12+1_amd64.deb          qemu-user-static_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-common-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb  qemu-system-ppc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb             qemu-user_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-common_9.0.2+ds-1~bpo12+1_amd64.deb         qemu-system-ppc_9.0.2+ds-1~bpo12+1_amd64.deb                    qemu-utils-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-data_9.0.2+ds-1~bpo12+1_all.deb             qemu-system-sparc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-utils_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-gui-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb     qemu-system-sparc_9.0.2+ds-1~bpo12+1_amd64.deb                  seabios_1.16.3-2~bpo12+1_all.deb
qemu-system-gui_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-system-x86-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb

root@gfxdebian:/home/test# cat /etc/apt/sources.list
# customization qemu
deb [trusted=yes]       file:///home/test/deb/  ./

</code></pre><p>Install the package:</p><pre><code># apt install -y seabios
# apt install -y qemu-system
</code></pre><p>Backup the installed debs via:</p><pre><code>mv deb debian_qemu_gfx_deb
 scp -r debian_qemu_gfx_deb/ dash@192.168.1.213:/media/sdb/samba
</code></pre><h3 id=cuttlefishqemugfxstream>cuttlefish(qemu+gfxstream)</h3><p>Create the instance:</p><pre><code> mkdir qemu_gfx
 cd qemu_gfx/
 tar xzvf ../cf-x86/cvd-host_package.tar.gz &amp;&amp; unzip ../cf-x86/aosp_cf_x86_64_phone-img-11305814.zip
 HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli -gpu_mode   gfxstream  -qemu_binary_dir /usr/bin  -enable_gpu_udmabuf -cpus 4 -memory_mb 4096
</code></pre><p>Connect and verify:</p><pre><code>
 $ sudo adb connect 192.168.1.60:6520                                                                                                               1
connected to 192.168.1.60:6520
$ sudo adb -s 192.168.1.60:6520 shell
vsoc_x86_64:/ $ getprop | grep boot | grep complete
[dev.bootcomplete]: [1]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_x86_64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (Intel), Android Emulator OpenGL ES Translator (Mesa Intel(R) Xe Graphics (TGL GT2)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 22.3.6)
</code></pre><h3 id=cuttlefishqemudrm_virgl>cuttlefish(<code>qemu+drm_virgl</code>)</h3><p>Create the instance:</p><pre><code> mkdir qemu_virgl
 cd qemu_virgl
 tar xzvf ../cf-x86/cvd-host_package.tar.gz &amp;&amp; unzip ../cf-x86/aosp_cf_x86_64_phone-img-11305814.zip
 HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli -gpu_mode   drm_virgl  -qemu_binary_dir /usr/bin  -enable_gpu_udmabuf -cpus 4 -memory_mb 4096
</code></pre><p>Connect and verify:</p><pre><code>vsoc_x86_64:/ $ getprop  | grep boot | grep com
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_x86_64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Mesa/X.org, virgl, OpenGL ES 3.2 Mesa 20.3.4 (git-543897be74)

</code></pre><h3 id=cuttlefishcrosvmgfxstream>cuttlefish(crosvm+gfxstream)</h3><p>Create the instance:</p><pre><code> mkdir crosvm_gfx
 cd crosvm_gfx
 tar xzvf ../cf-x86/cvd-host_package.tar.gz &amp;&amp; unzip ../cf-x86/aosp_cf_x86_64_phone-img-11305814.zip
HOME=$PWD ./bin/launch_cvd   -gpu_mode   gfxstream  -cpus 4 -memory_mb  8192
</code></pre><p>Connect and verify:</p><pre><code>vsoc_x86_64:/ $ getprop | grep boot | grep comple
[dev.bootcomplete]: [1]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_x86_64:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (Intel), Android Emulator OpenGL ES Translator (Mesa Intel(R) Xe Graphics (TGL GT2)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 22.3.6)

</code></pre><h3 id=cuttlefishcrosvmvirgl>cuttlefish(crosvm+virgl)</h3><p>Create the instance:</p><pre><code> mkdir crosvm_virgl
 cd crosvm_virgl
 tar xzvf ../cf-x86/cvd-host_package.tar.gz &amp;&amp; unzip ../cf-x86/aosp_cf_x86_64_phone-img-11305814.zip
$ HOME=$PWD ./bin/launch_cvd   -gpu_mode    drm_virgl -cpus 4 -memory_mb  8192

</code></pre><p>Connect and verify:</p><pre><code>not ok, failed to connect 
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/09/21/rebuildqemuondebian/>RebuildQemuOnDebian</a></h1><span class=post-date>Sep 21, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Steps:</p><pre><code>$ vim /etc/apt/sources.list
Add:  
 deb http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
 deb-src http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
$ sudo apt build-dep qemu-system
$ mkdir -p ~/qemu &amp;&amp; cd qemu
$ apt source qemu-system
$ cd qemu-9.0.2+ds
$ dpkg-buildpackage -rfakeroot -uc -b
</code></pre><p>After building, the debs is listed as:</p><pre><code>test@buildqemu:~/qemu$ ls
qemu-9.0.2+ds                                           qemu-system-misc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu_9.0.2+ds-1~bpo12+1_amd64.buildinfo                 qemu-system-modules-opengl_9.0.2+ds-1~bpo12+1_amd64.deb
qemu_9.0.2+ds-1~bpo12+1_amd64.changes                   qemu-system-modules-opengl-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu_9.0.2+ds-1~bpo12+1.debian.tar.xz                   qemu-system-modules-spice_9.0.2+ds-1~bpo12+1_amd64.deb
qemu_9.0.2+ds-1~bpo12+1.dsc                             qemu-system-modules-spice-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu_9.0.2+ds.orig.tar.xz                               qemu-system-ppc_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-block-extra_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-system-ppc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-block-extra-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb    qemu-system-sparc_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-guest-agent_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-system-sparc-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-guest-agent-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb    qemu-system-x86_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system_9.0.2+ds-1~bpo12+1_amd64.deb                qemu-system-x86-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-arm_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-system-xen_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-arm-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb     qemu-system-xen-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-common_9.0.2+ds-1~bpo12+1_amd64.deb         qemu-user_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-common-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb  qemu-user-binfmt_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-data_9.0.2+ds-1~bpo12+1_all.deb             qemu-user-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-gui_9.0.2+ds-1~bpo12+1_amd64.deb            qemu-user-static_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-gui-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb     qemu-user-static-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-mips_9.0.2+ds-1~bpo12+1_amd64.deb           qemu-utils_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-mips-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb    qemu-utils-dbgsym_9.0.2+ds-1~bpo12+1_amd64.deb
qemu-system-misc_9.0.2+ds-1~bpo12+1_amd64.deb

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/09/19/buildqemurutabaga_gfx/>BuildQemurutabaga_gfx</a></h1><span class=post-date>Sep 19, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Install with <code>debian-12.7.0-amd64-DVD-1.iso</code>. Select gnome/desktop/ssh server.</p><p><img src=/images/20240919_084808_x.jpg alt=/images/20240919_084808_x.jpg></p><p><img src=/images/20240919_085715_x.jpg alt=/images/20240919_085715_x.jpg></p><h3 id=x86-steps>x86 steps</h3><p>Configure the repository and update/upgrade:</p><pre><code>root@debian:~# cat /etc/apt/sources.list
# 默认注释了源码仓库，如有需要可自行取消注释
deb http://mirrors.ustc.edu.cn/debian bookworm main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian bookworm main contrib non-free non-free-firmware
deb http://mirrors.ustc.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware

# backports 软件源，请按需启用
# deb http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
# deb-src http://mirrors.ustc.edu.cn/debian bookworm-backports main contrib non-free non-free-firmware
# apt install -y nethogs vim iptables
</code></pre><p>Install necessary packages:</p><pre><code> apt install -y ninja-build pkg-config libgbm1 libglib2.0-dev bridge-utils libfdt-dev libpixman-1-dev libssl-dev libsdl1.2-dev libspice-server-dev autoconf libtool xtightvncviewer tightvncserver x11vnc uuid-runtime uuid uml-utilities liblzma-dev libc6-dev libdrm-dev libgbm-dev spice-client-gtk libgtk2.0-dev libusb-1.0-0-dev libepoxy-dev libaio-dev libgtk-3-dev ovmf libsdl2-dev libegl-mesa0
apt install -y {libpulse,libdrm,libglm,libstb,libegl,libgles,libvulkan,vulkan-validationlayers}-dev 
apt install -y libepoxy-dev libgbm-dev cmake curl python3-venv git build-essential meson
</code></pre><p>Prepare the code structure:</p><pre><code>mkdir Code
cd Code
git clone https://gitlab.com/qemu-project/qemu.git
</code></pre><p>Build libvirglrenderer:</p><pre><code>export PREFIX=&quot;$(pwd)&quot;/prefix
git clone https://gitlab.freedesktop.org/virgl/virglrenderer.git
cd virglrenderer
meson setup -Dprefix=$PREFIX -Dlibdir=lib build
cd build
ninja install
</code></pre><p>build aemu (dependencies) Steps:</p><pre><code>cd qemu
mkdir -p build/deps/prefix
cd build/deps
export PREFIX=&quot;$(pwd)&quot;/prefix
export CMAKE_INSTALL_PREFIX=&quot;${PREFIX}&quot;
export PKG_CONFIG_PATH=&quot;${PREFIX}/lib/pkgconfig&quot;:&quot;${PREFIX}/lib/x86_64-linux-gnu/pkgconfig&quot;
git clone https://android.googlesource.com/platform/hardware/google/aemu
cd aemu/
cmake -DAEMU_COMMON_GEN_PKGCONFIG=ON \
      -DAEMU_COMMON_BUILD_CONFIG=gfxstream \
      -DENABLE_VKCEREAL_TESTS=OFF \
      --install-prefix &quot;${PREFIX}&quot; \
      -B build
cmake --build build -j
cmake --install build --prefix &quot;${CMAKE_INSTALL_PREFIX}&quot;
</code></pre><p>build gfxstream steps:</p><pre><code>cd ..
git clone https://android.googlesource.com/platform/hardware/google/gfxstream
cd gfxstream/
meson setup -Ddefault_library=static --prefix &quot;${PREFIX}&quot; build/ 
meson install -C build
</code></pre><p>rutabaga FFI￼:</p><pre><code>cd ~/Code
git clone https://github.com/google/crosvm
export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup
export RUSTUP_DIST_SERVER=https://mirrors.tuna.tsinghua.edu.cn/rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
#curl https://sh.rustup.rs -sSf | sh
source $HOME/.cargo/env
source ~/.profile
rustup toolchain list | grep -q 1.68.2-x86_64-unknown-linux-gnu || rustup toolchain install 1.68.2-x86_64-unknown-linux-gnu
cd crosvm
git reset --hard cd04b6198dc89104de7748043585cf38c56cb626
export RUSTFLAGS='-Clink-arg=-L='&quot;${PREFIX}&quot;/lib/x86_64-linux-gnu/
cd rutabaga_gfx/ffi
make
make prefix=&quot;${PREFIX}&quot; install
</code></pre><p>Build qemu:</p><pre><code>mkdir -p /opt/local
cd ~/Code/qemu/build
export CFLAGS=&quot;-I${PREFIX}/include -L${PREFIX}/lib&quot; # needed for rutabaga_gfx_ffi.h
#../configure --enable-system --enable-tools --enable-vhost-user --enable-slirp --enable-kvm --enable-debug --target-list=x86_64-softmmu --enable-rutabaga-gfx --prefix=/opt/local/
../configure --enable-system --enable-tools --enable-vhost-user --enable-slirp --enable-kvm --enable-debug --target-list=aarch64-softmmu --enable-rutabaga-gfx
make -j$(nproc)
su root
</code></pre><p>￼
￼</p><h3 id=cuttlefish-build>cuttlefish build</h3><p>Steps:</p><pre><code>usermod -aG sudo test
cd ~/Code
git clone https://github.com/google/android-cuttlefish
cd android-cuttlefish
tools/buildutils/build_packages.sh
sudo dpkg -i ./cuttlefish-base_*_*64.deb || sudo apt-get install -f
sudo dpkg -i ./cuttlefish-user_*_*64.deb || sudo apt-get install -f
sudo usermod -aG kvm,cvdnetwork,render $USER
mkdir cf
tar xzvf ../cvd-host_package.tar.gz &amp;&amp; unzip ../aosp_cf_arm64_only_phone-img-11489887.zip 
sudo reboot
</code></pre><p>should notice the aarch64 library replacement.</p><h3 id=x86-tips>x86 tips</h3><p>qemu version:</p><pre><code>$ /home/test/Code/qemu/build/qemu-system-x86_64 --version
QEMU emulator version 9.1.50 (v9.1.0-384-g2b81c04625)
Copyright (c) 2003-2024 Fabrice Bellard and the QEMU Project developers
test@debian:~/cf$ sudo chmod 777 /usr/bin/qemu-system-x86_64 
test@debian:~/cf$ sudo cat /usr/bin/qemu-system-x86_64 
#!/bin/bash
/home/test/Code/qemu/build/qemu-system-x86_64 $@

</code></pre><h3 id=ubuntu2204-issue>Ubuntu2204 issue</h3><p>When building gfxstream host:</p><pre><code>git clone https://android.googlesource.com/platform/hardware/google/gfxstream
cd gfxstream/
meson setup host-build/
</code></pre><p>Get error:</p><pre><code>Run-time dependency dl found: NO (tried pkgconfig and cmake)

host/meson.build:78:2: ERROR: Dependency &quot;dl&quot; not found, tried pkgconfig and cmake

</code></pre><p>cmake:</p><pre><code> 307  sudo apt remove cmake
  308  sudo apt install libssl-dev
  309  cd ..
  310  ls
  311  wget https://cmake.org/files/v3.29/cmake-3.29.2.tar.gz
  312  tar -xzvf cmake-3.29.2.tar.gz
  313  cd cmake-3.29.2
  314  export OPENSSL_ROOT_DIR=/usr/include/openssl
  315  ./bootstrap
  316  make -j$(nproc)
  317  sudo make install
  318  which cmake

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/09/18/cuttlefishrecords/>cuttlefishRecords</a></h1><span class=post-date>Sep 18, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=1-crosvm>1. crosvm</h3><p>Default command:</p><pre><code>HOME=$PWD ./bin/launch_cvd  -cpus 6 -memory_mb 8192 
</code></pre><p>Result:</p><pre><code>vsoc_arm64_only:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google Inc. (Google), ANGLE (Google, Vulkan 1.3.0 (SwiftShader Device (LLVM 16.0.0) (0x0000C0DE)), SwiftShader driver-5.0.0), OpenGL ES 3.1.0 (ANGLE 2.1.0 git hash: unknown hash)
</code></pre><p>(Start under Xorg :0)-gfxstream mode:</p><pre><code>$ HOME=$PWD ./bin/launch_cvd -cpus 6 -memory_mb 8192 --gpu_mode=gfxstream
</code></pre><p>Result:</p><pre><code>vsoc_arm64_only:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google (AMD), Android Emulator OpenGL ES Translator (OLAND (, LLVM 15.0.7, DRM 2.50, 5.15.0-119-generic)), OpenGL ES 3.1 (OpenGL ES 3.2 Mesa 23.2.1-1ubuntu3.1~22.04.2)

</code></pre><p><code>$ HOME=$PWD ./bin/launch_cvd -cpus 6 -memory_mb 8192 --gpu_mode=guest_swiftshader</code>:</p><pre><code>vsoc_arm64_only:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google Inc. (Google), ANGLE (Google, Vulkan 1.3.0 (SwiftShader Device (LLVM 16.0.0) (0x0000C0DE)), SwiftShader driver-5.0.0), OpenGL ES 3.1.0 (ANGLE 2.1.0 git hash: unknown hash)

</code></pre><p><code>$ HOME=$PWD ./bin/launch_cvd -cpus 6 -memory_mb 8192 --gpu_mode=auto</code>:</p><pre><code>vsoc_arm64_only:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Google Inc. (Google), ANGLE (Google, Vulkan 1.3.0 (SwiftShader Device (LLVM 16.0.0) (0x0000C0DE)), SwiftShader driver-5.0.0), OpenGL ES 3.1.0 (ANGLE 2.1.0 git hash: unknown hash)

</code></pre><h3 id=2-qemu>2. qemu</h3><p>virgl:</p><pre><code>HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli -gpu_mode  drm_virgl  -enable_gpu_udmabuf -cpus 4 -memory_mb 4096
</code></pre><p>Result:</p><pre><code>vsoc_arm64_only:/ $ getprop | grep boot | grep com                                            
[dev.bootcomplete]: [1]
[ro.boot.hardware.hwcomposer.display_finder_mode]: [drm]
[ro.boot.hardware.hwcomposer.mode]: [client]
[ro.boot.vendor.apex.com.google.emulated.camera.provider.hal]: [com.google.emulated.camera.provider.hal]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]
vsoc_arm64_only:/ $ dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
GLES: Mesa/X.org, virgl, OpenGL ES 3.2 Mesa 20.3.4 (git-1aa4951402)

</code></pre><p>gfxstream:</p><pre><code>$ HOME=$PWD ./bin/launch_cvd -vm_manager qemu_cli -gpu_mode   gfxstream  -enable_gpu_udmabuf -cpus 4 -memory_mb 4096
</code></pre><p>Result:</p><pre><code>--gpu_mode=gfxstream was requested but the prerequisites for accelerated rendering were not detected so the device may not function correctly. Please consider switching to --gpu_mode=auto or --gpu_mode=guest_swiftshader.
GPU vhost user auto mode: not yet supported with qemu_cli. Not enabling vhost user gpu.
assemble_cvd failed: 
</code></pre></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class="page-item disabled"><a class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class="page-item active"><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/246/>246</a></li><li class=page-item><a href=/page/2/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/246/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>