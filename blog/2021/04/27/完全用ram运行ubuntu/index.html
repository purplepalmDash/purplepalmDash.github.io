<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>完全用RAM运行Ubuntu &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="RAMBasedUbuntu"><meta name=keywords content="Technology"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>完全用RAM运行Ubuntu</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Apr 27, 2021<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#1-目的>1. 目的</a></li><li><a href=#2-准备材料>2. 准备材料</a></li><li><a href=#3-步骤>3. 步骤</a></li><li><a href=#4-性能对比测试>4. 性能对比测试</a></li></ul></li></ul></nav></div><h3 id=1-目的>1. 目的</h3><p>将Ubuntu18.04.1操作系统(arm64)完全运行在内存中。</p><h3 id=2-准备材料>2. 准备材料</h3><p>Ubuntu 18.04.1 arm64安装iso.<br>arm64服务器/libvirtd/virt-manager.(在没有实体服务器的情况下，可以用虚拟机来模拟测试).</p><h3 id=3-步骤>3. 步骤</h3><p>最小化安装Ubuntu 18.04.1 操作系统, 根分区最好包含所有分区(all in one)。<br>安装完毕操作系统后，定制自己需要的软件包及准备环境后，删除所有的临时文件，尽量瘦身系统。这是因为内存定制化后，所有的文件在启动时将被加载到内存！全新安装的ubuntu大约占据约1.5GB的磁盘空间。<br>以下为定制为RAM启动的流程：</p><p>步骤一：<br>更改<code>/etc/fstab</code>文件内容，首先备份该文件:</p><pre><code># cp /etc/fstab /etc/fstab.bak
</code></pre><p>编辑<code>/etc/fstab</code>文件内容，找到标识根分区(/)的行，更改为以下内容(下为示例):</p><pre><code>#/dev/mapper/ubuntu--vg-root /               ext4    errors=remount-ro 0       1
none / tmpfs defaults 0 0
</code></pre><p>步骤二:<br>更改initramfs中的<code>local</code>脚本内容, initramfs 包含的工具和脚本，在正式的根文件系统的初始化脚本 init 启动之前，就被挂载并完成相应的初始化工作。我们需要提前将磁盘根分区中的内容拷贝入<code>tmpfs</code>中，以便在<code>/etc/fstab</code>开始执行的时候找寻到正确的分区.</p><p>首先备份<code>/usr/share/initramfs-tools/scripts/local</code>文件:</p><pre><code># cp /usr/share/initramfs-tools/scripts/local /usr/share/initramfs-tools/scripts/local.bak   
</code></pre><p>编辑<code>local</code>文件，更改其<code>Mount root</code>部分的处理逻辑(约204行左右内容):</p><pre><code>	# FIXME This has no error checking
	# Mount root
	#mount ${roflag} ${FSTYPE:+-t ${FSTYPE} }${ROOTFLAGS} ${ROOT} ${rootmnt}
	# Start of ramboottmp
        mkdir /ramboottmp
        mount ${roflag} -t ${FSTYPE} ${ROOTFLAGS} ${ROOT} /ramboottmp
        mount -t tmpfs -o size=100% none ${rootmnt}
        cd ${rootmnt}
        cp -rfa /ramboottmp/* ${rootmnt}
        umount /ramboottmp
        ### End of ramboottmp
</code></pre><p>保存该文件后，重新编译initramfs:</p><pre><code># mkinitramfs -o /boot/initrd.img-ramboot
</code></pre><p>编译成功后，将<code>local</code>文件替换会原来的版本:</p><pre><code># cp -f /usr/share/initramfs-tools/scripts/local.bak /usr/share/initramfs-tools/scripts/local
</code></pre><p>步骤三:<br>更改grub，以使用刚才编译出的<code>initrd.img-ramboot</code>来启动操作系统:</p><p>更改第一启动项中的<code>/initrd</code>行，替换为:</p><pre><code># chmod +w /boot/grub/grub.cfg
# vim /boot/grub/grub.cfg
.....
.....
        linux	/boot/vmlinuz-4.15.0-29-generic root=/dev/mapper/ubuntu--vg-root ro  
	initrd	/boot/initrd.img-ramboot
......
......
# chmod -w /boot/grub/grub.cfg
</code></pre><p>步骤四：<br>重启，重启时选择第一启动项，此时根分区会整体被加载到<code>tmpfs</code>中。</p><h3 id=4-性能对比测试>4. 性能对比测试</h3><p>测试环境定义:</p><ul><li>aarch64 4核</li><li>64 GB 内存</li><li>100 GB 磁盘分区</li><li>Ubuntu 18.04.1 LTS</li><li>内核版本： 4.15.0-29-generic</li><li>fio版本: fio-3.1</li></ul><p>所有测试样例均在<code>ramdisk</code>主机及传统主机上运行并对比.</p><h4 id=41-fio-4k随机读写>4.1 fio 4k随机读写</h4><p>测试命令如下:</p><pre><code># fio --name TEST --eta-newline=5s --filename=fio-tempfile.dat --rw=randrw --size=500m --io_size=10g --blocksize=4k --ioengine=libaio --fsync=1 --iodepth=1 --numjobs=1 --runtime=60 --group_reporting
</code></pre><table><thead><tr><th>指标</th><th>内存型主机</th><th>传统主机</th></tr></thead><tbody><tr><td>READ bw</td><td>bw=513MiB/s (538MB/s)</td><td>bw=85.0KiB/s (87.0kB/s)</td></tr><tr><td>READ io</td><td>io=5133MiB (5382MB)</td><td>io=5104KiB (5226kB)</td></tr><tr><td>READ iops</td><td>IOPS=131k</td><td>IOPS=21</td></tr><tr><td>WRITE bw</td><td>bw=510MiB/s (535MB/s)</td><td>bw=88.1KiB/s (90.2kB/s)</td></tr><tr><td>WRITE io</td><td>io=5107MiB (5355MB)</td><td>io=5288KiB (5415kB)</td></tr><tr><td>WRITE iops</td><td>IOPS=131k</td><td>IOPS=22</td></tr></tbody></table><p>测试显示：4K随机读写的带宽对比，内存型主机是传统主机的约6000倍，读IOPS/写IOPS，内存型主机是传统主机的约6000倍。</p><h4 id=42-fio-4k顺序读写>4.2 fio 4k顺序读写</h4><p>测试命令如下:</p><pre><code># fio --name TEST --eta-newline=5s --filename=fio-tempfile.dat --rw=rw --size=500m --io_size=10g --blocksize=4k --ioengine=libaio --fsync=1 --iodepth=1 --numjobs=1 --runtime=60 --group_reporting
</code></pre><table><thead><tr><th>指标</th><th>内存型主机</th><th>传统主机</th></tr></thead><tbody><tr><td>READ bw</td><td>bw=640MiB/s (671MB/s)</td><td>bw=73.2KiB/s (75.0kB/s)</td></tr><tr><td>READ io</td><td>io=5133MiB (5382MB)</td><td>io=4396KiB (4502kB)</td></tr><tr><td>READ iops</td><td>IOPS=164k</td><td>IOPS=18</td></tr><tr><td>WRITE bw</td><td>bw=637MiB/s (668MB/s)</td><td>bw=76.8KiB/s (78.6kB/s)</td></tr><tr><td>WRITE io</td><td>io=5107MiB (5355MB)</td><td>io=4608KiB (4719kB)</td></tr><tr><td>WRITE iops</td><td>IOPS=163k</td><td>IOPS=19</td></tr></tbody></table><p>测试显示：4K顺序读写的带宽对比，内存型主机是传统主机的约9000倍，读IOPS/写IOPS，内存型主机是传统主机的约9000倍。</p></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>