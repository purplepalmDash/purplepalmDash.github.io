<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>用Superset可视化武汉肺炎数据 &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="UseSupersetForVisualization"><meta name=keywords content="Technology"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>用Superset可视化武汉肺炎数据</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Mar 13, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#前言>前言</a></li><li><a href=#环境>环境</a></li><li><a href=#搭建superset>搭建superset</a></li><li><a href=#准备数据>准备数据</a></li><li><a href=#建立数据源>建立数据源</a></li><li><a href=#更改tables属性>更改tables属性</a></li><li><a href=#数据分析>数据分析</a></li><li><a href=#dashboard>Dashboard</a></li></ul></li></ul></nav></div><h3 id=前言>前言</h3><p>最近因为武汉肺炎的原因一直宅在家里，刷什么值得买的时候看到了一个玩mac mini server的哥们写的用superset可视化武汉肺炎的文章，照着做了一遍，将具体的步骤都写在了下面。后续做实际项目的BI内容可视化的时候可以用来参考。</p><p>该文章中也有少许操作步骤方面的错误，做的时候经常会卡在那里半天。当然如果按照下面记录的步骤来进行的话，这些问题应该不会出现。</p><h3 id=环境>环境</h3><p>涉及到的硬件、操作系统、软件等的情况列举如下：</p><pre><code>KVM虚拟机，4核，3G内存， 200G硬盘
Ubuntu18.04.3 x86_64
docker/docker-compose
</code></pre><h3 id=搭建superset>搭建superset</h3><p>通过 docker启动superset, 启动后监听 <code>8088</code> 端口:</p><pre><code># sudo docker run -d --name superset -p 8088:8088 amancevice/superset
</code></pre><p>初始化数据库：</p><pre><code># sudo docker run -d --name superset -p 8088:8088 amancevice/superset
cf39f0c9e6a1232796cfe9012d110d6dd50613a8e2022873c963974eb74c18ba
root@node:/mnt2# docker exec -it superset superset-init
Username [admin]: 
User first name [admin]: 
User last name [user]: 
Email [admin@fab.org]: 
Password: 
Repeat for confirmation: 
</code></pre><p>现在可以用admin用户及刚才创建的密码登录superset界面了：</p><p><img src=/images/2020_03_13_13_10_20_741x496.jpg alt=/images/2020_03_13_13_10_20_741x496.jpg></p><p>登录后界面如下：</p><p><img src=/images/2020_03_13_13_15_05_996x482.jpg alt=/images/2020_03_13_13_15_05_996x482.jpg></p><h3 id=准备数据>准备数据</h3><p>肺炎的数据从以下页面取得：</p><p><a href=https://github.com/canghailan/Wuhan-2019-nCoV>https://github.com/canghailan/Wuhan-2019-nCoV</a></p><p>点击下面链接中数据接口里的csv，将csv文件下载到本地:</p><p><img src=/images/2020_03_13_13_17_00_846x360.jpg alt=/images/2020_03_13_13_17_00_846x360.jpg></p><p>csv文件可以方便的用libreoffice或者excel打开，后面我们将用libreoffice对数据做一点点更改以支持superset中的地图显示。</p><p>手动建立省份代码csv文件( <code>province.csv</code> ), 这个文件是ISO3316标准下的中国省份代码，因为superset的地图中需要使用该标准下的代码:</p><pre><code>编码,城市
北京市,CN-11
天津市,CN-12
河北省,CN-13
山西省,CN-14
内蒙古自治区,CN-15
辽宁省,CN-21
吉林省,CN-22
黑龙江省,CN-23
上海市,CN-31
江苏省,CN-32
浙江省,CN-33
安徽省,CN-34
福建省,CN-35
江西省,CN-36
山东省,CN-37
河南省,CN-41
湖北省,CN-42
湖南省,CN-43
广东省,CN-44
广西壮族自治区,CN-45
海南省,CN-46
重庆市,CN-50
四川省,CN-51
贵州省,CN-52
云南省,CN-53
西藏自治区,CN-54
陕西省,CN-61
甘肃省,CN-62
青海省,CN-63
宁夏回族自治区,CN-64
新疆维吾尔自治区,CN-65
</code></pre><p>在libreoffice中打开两个csv文件后，在<code>Wuhan-2019-nCov</code> 的工作空间里新建一个tab将 <code>province.csv</code>内容全盘复制进来, 并将此tab命名为 <code>province</code>:</p><p><img src=/images/2020_03_13_13_27_26_501x223.jpg alt=/images/2020_03_13_13_27_26_501x223.jpg></p><p>接下来我们使用vlookup用来将ISO3316的省份代码插入到<code>Wuhan-2019-nCov</code>表中, 首先在province栏后新建一栏，命名为<code>3316code</code>:</p><p><img src=/images/2020_03_13_13_34_44_688x239.jpg alt=/images/2020_03_13_13_34_44_688x239.jpg></p><p>此栏目现在是空的，我们需要用函数将其批量替换为省份对应的代码，如，<code>湖北省</code> -> <code>CN-41</code>, 首先选中E中的第一个空白栏，而后点击<code>fx</code>按钮，在弹出的函数选择框中输入 <code>vookup</code> 后，启动函数编辑器:</p><p><img src=/images/2020_03_13_13_38_55_713x634.jpg alt=/images/2020_03_13_13_38_55_713x634.jpg></p><p>点击 <code>Next</code> 后进入到函数参数输入界面, 首先配置搜索条件, 在<code>Search criterion</code>中填入<code>D:D</code>， libreoffice里将自动选择D全栏, 代表搜索省份中所有的条目:</p><p><img src=/images/2020_03_13_13_44_49_494x457.jpg alt=/images/2020_03_13_13_44_49_494x457.jpg></p><p>选中<code>Array</code>后，鼠标点击切换到 <code>Province</code> 表， 选中A/B全栏， 或者直接输入 <code>$Province.A:B</code>，匹配:</p><p><img src=/images/2020_03_13_14_05_21_736x482.jpg alt=/images/2020_03_13_14_05_21_736x482.jpg></p><p><code>Index</code> 输入数值2, 代表从匹配变量一栏开始需要匹配的数据为第2栏，而 <code>Sort order</code>则输入0后，可以看到输出结果为 <code>CN-42</code>， 代表已经匹配成功:</p><p><img src=/images/2020_03_13_14_05_52_666x477.jpg alt=/images/2020_03_13_14_05_52_666x477.jpg></p><p>点击 <code>OK</code> 后，点击函数将其扩展到以下几行，观察结果:</p><p><img src=/images/2020_03_13_14_06_49_278x253.jpg alt=/images/2020_03_13_14_06_49_278x253.jpg></p><p>可以看到有 <code>#N/A</code> 的错误输出结果，我们需要修改函数忽略掉此输出:</p><p><img src=/images/2020_03_13_14_06_49_278x253.jpg alt=/images/2020_03_13_14_06_49_278x253.jpg></p><p>修改函数为 <code>IFERROR(VLOOKUP(D:D, $Province.A:B,2,0),"")</code>之后，查看结果:</p><p><img src=/images/2020_03_13_14_12_02_492x203.jpg alt=/images/2020_03_13_14_12_02_492x203.jpg></p><p>结果显示正常:</p><p><img src=/images/2020_03_13_14_13_04_364x293.jpg alt=/images/2020_03_13_14_13_04_364x293.jpg></p><p>接下来将此函数应用到全列, 选中一个已经应用公式的条目后，如E30, 按住shift键，鼠标一直拉到E的最后一行后，点最后一个元素，选中全列，而后按<code>Ctrl+D</code>，将公式应用到全列，如:</p><p><img src=/images/2020_03_13_14_24_38_788x636.jpg alt=/images/2020_03_13_14_24_38_788x636.jpg></p><p>现在保存此csv文件，命名为 <code>nCovForSuperset.csv</code>后退出, 注意要选择 <code>Use Text CSV Format </code>。</p><p><img src=/images/2020_03_13_14_25_31_545x184.jpg alt=/images/2020_03_13_14_25_31_545x184.jpg></p><p>至此，数据准备完毕。</p><h3 id=建立数据源>建立数据源</h3><p>用sqlite3建立一个 <code>假</code> 的数据文件:</p><pre><code># sqlite3 test.db
SQLite version 3.22.0 2018-01-22 18:45:57
Enter &quot;.help&quot; for usage hints.
sqlite&gt; .quit
# ls
nCovForSuperset.csv  province.csv  test.db  Wuhan-2019-nCoV.csv
</code></pre><p>我们将 此 <code>test.db</code>文件拷贝到容器中, 并通过root用户改变其文件权限:</p><pre><code># docker cp test.db superset:/home/superset/
# docker exec -it  --workdir /root --user root superset chmod 777 /home/superset/test.db
</code></pre><p>在Superset界面中点击 <code>Sources</code> -> <code>Database</code>, 后，进入到配置数据库的界面:</p><p><img src=/images/2020_03_13_14_31_43_1049x376.jpg alt=/images/2020_03_13_14_31_43_1049x376.jpg></p><p>点击 <code>+</code> 号，新加一个数据库, 输入数据库名，及数据库所在的URI，此例子中为 <code>sqlite:////home/superset/test.db</code>:</p><p><img src=/images/2020_03_13_14_38_24_837x348.jpg alt=/images/2020_03_13_14_38_24_837x348.jpg></p><p>勾选 <code>Allow Csv Upload</code> 及 <code>Allow CREATE TABLE AS</code>:</p><p><img src=/images/2020_03_13_14_39_50_568x222.jpg alt=/images/2020_03_13_14_39_50_568x222.jpg></p><p>之后点击 <code>Save</code>， 可以看到数据库已经被建立起来:</p><p><img src=/images/2020_03_13_14_40_15_631x301.jpg alt=/images/2020_03_13_14_40_15_631x301.jpg></p><p>上传刚才编辑好的CSV文件:</p><p><img src=/images/2020_03_13_14_44_15_571x374.jpg alt=/images/2020_03_13_14_44_15_571x374.jpg></p><p>会报出出错，提示因权限问题无法上传此CSV文件：</p><p><img src=/images/2020_03_13_14_45_42_1191x277.jpg alt=/images/2020_03_13_14_45_42_1191x277.jpg></p><p>手动建立目录并改变其权限:</p><pre><code># docker exec -it  --workdir /root --user root superset mkdir -p /usr/local/lib/python3.6/site-packages/superset/app
# docker exec -it  --workdir /root --user root superset chmod 777 -R /usr/local/lib/python3.6/site-packages/superset/app
</code></pre><p>上传成功后可以看到<code>Tables</code>中有了新的文件:</p><p><img src=/images/2020_03_13_14_47_11_726x357.jpg alt=/images/2020_03_13_14_47_11_726x357.jpg></p><h3 id=更改tables属性>更改tables属性</h3><p>CSV上传后，大部分的字段（数据) 并没有被确定为准确的类型，superset需要从这些数据中知道哪些是数据，哪些是时间，哪些又可以被归类，为此我们需要编辑此Table中的数据:</p><p>点击<code>Edit Table</code> 进入编辑界面，首先更改<code>Detail</code>中的 <code>Offset</code>为8,代表时区与UTC差别为8：</p><p><img src=/images/2020_03_13_14_49_40_436x247.jpg alt=/images/2020_03_13_14_49_40_436x247.jpg></p><p><img src=/images/2020_03_13_14_49_51_483x269.jpg alt=/images/2020_03_13_14_49_51_483x269.jpg></p><p>而后开始编辑 <code>Columns</code>, 相关属性说明: <code>groupable</code> 代表是否可以分组; <code>filterable</code> 代表是否可以分类; <code>is temporal</code> 代表是否是时间参数。我们需要把date的type设置为timestamp, 并选取其 <code>is temporal</code> 属性，其他的所有字段的 <code>groupable</code> 及 <code>filterable</code> 都勾上:</p><p><img src=/images/2020_03_13_14_53_24_1080x643.jpg alt=/images/2020_03_13_14_53_24_1080x643.jpg></p><p>Metrics一栏暂时不做任何设置，至此数据已经清晰化，下一步进入数据分析环节.</p><h3 id=数据分析>数据分析</h3><p>点击 <code>Sources</code> -> <code>Tables</code> ，选中我们刚才上传的CSV文件建立的表后，进入到数据可视化编辑界面，初次进入时界面是完全空白的，我们需要在这里添加相关图表。</p><h4 id=中国地图>中国地图</h4><p>点击 <code>Visualization Type</code>， 选择 <code>Country Map</code>:</p><p><img src=/images/2020_03_13_14_56_14_398x333.jpg alt=/images/2020_03_13_14_56_14_398x333.jpg></p><p>选择为以下值时候，运行 <code>Run Query</code>:</p><p><img src=/images/2020_03_13_14_59_04_866x838.jpg alt=/images/2020_03_13_14_59_04_866x838.jpg></p><p>结果如下，比如，选择甘肃，可以看到累计的确诊人数为127人：</p><p><img src=/images/2020_03_13_14_59_44_872x550.jpg alt=/images/2020_03_13_14_59_44_872x550.jpg></p><p>编辑完后，点击save即可保存，我们保存为<code>chinamap</code>:</p><p><img src=/images/2020_03_13_15_01_10_417x324.jpg alt=/images/2020_03_13_15_01_10_417x324.jpg></p><h4 id=时间线地图>时间线地图</h4><p>建立一个类型为 <code>Line Charts</code>的图表，数据类型如下：</p><p><img src=/images/2020_03_13_15_34_03_620x820.jpg alt=/images/2020_03_13_15_34_03_620x820.jpg></p><p>结果如下:</p><p><img src=/images/2020_03_13_15_35_25_1239x955.jpg alt=/images/2020_03_13_15_35_25_1239x955.jpg></p><p>保存名称为 <code>Trend</code>.</p><h4 id=sunburst类型>sunburst类型</h4><p>数据类型如下:</p><p><img src=/images/2020_03_13_15_37_55_629x795.jpg alt=/images/2020_03_13_15_37_55_629x795.jpg></p><p>结果：</p><p><img src=/images/2020_03_13_15_38_18_1131x822.jpg alt=/images/2020_03_13_15_38_18_1131x822.jpg></p><p>保存名称为 <code>SunburstChina</code></p><h4 id=forcedirected类型>ForceDirected类型</h4><p>数据定义如下:</p><p><img src=/images/2020_03_13_15_41_06_620x724.jpg alt=/images/2020_03_13_15_41_06_620x724.jpg></p><p>结果:</p><p><img src=/images/2020_03_13_15_41_56_991x744.jpg alt=/images/2020_03_13_15_41_56_991x744.jpg></p><p>保存名称为: <code>totalDead</code>.</p><p>至此所有的单图表创建完毕.</p><h3 id=dashboard>Dashboard</h3><p>增加一个Dashboard:</p><p><img src=/images/2020_03_13_15_43_41_523x258.jpg alt=/images/2020_03_13_15_43_41_523x258.jpg></p><p>点击Edit，添加对应的图表到该dashboard上即可:</p><p><img src=/images/2020_03_13_16_13_23_1124x480.jpg alt=/images/2020_03_13_16_13_23_1124x480.jpg></p><p>至此，可视化完毕，可以探索更多的样例做出更多的可视化效果。</p></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>