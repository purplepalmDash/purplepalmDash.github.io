<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>WorkingTipsOnCellsOnAndroid10 &middot; Dash</title>

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124">
  <link rel="stylesheet" href="https://purplepalmdash.github.io/css/highlight/googlecode.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="/js/html2canvas.js"></script>
  <script type='text/javascript'>
  function genPostShot() { 
          var rightNow = new Date();
          var imageName = rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");
          imageName += '.jpg'
          html2canvas(document.getElementsByClassName('post'), {
              background :'#FFFFFF',
              onrendered: function(canvas) {
  		
          	$('#test').attr('href', canvas.toDataURL("image/jpeg"));
          	$('#test').attr('download',imageName);
          	$('#test')[0].click();
              }
          });
  }; 
  
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124">
  <link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel="icon">

  
  
  
  
  <meta name="description" content="WorkingTipsOnCellsOnAndroid10">
  <meta name="keywords" content="Technology">
  
  
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <img src="http://purplepalmdash.github.io/images/mylogo.jpeg" alt="gravatar">
      <h1><a href="http://purplepalmdash.github.io/">Get busy living, or get busy dying.</a></h1>
      <a href="http://purplepalmdash.github.io/"><p>Dash</p></a>
    </div>

    <ul class="sidebar-nav">
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/post/">All Posts</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/technology/">Technology</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/life/">Life</a></li>
      
      <li class="sidebar-nav-item"><a href="http://purplepalmdash.github.io/categories/linuxtips/">LinuxTips</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/purplepalmdash"><i class="fa fa-github-square fa-3x"></i></a>
      
      <a href="https://cn.linkedin.com/in/yang-feipeng-1b909319"><i class="fa fa-linkedin-square fa-3x"></i></a>
      <a href="https://plus.google.com/u/0/106572959364703833986"><i class="fa fa-google-plus-square fa-3x"></i></a>
      <a href="https://www.facebook.com/yang.feipeng"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="https://twitter.com/dashwillfly"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      </li>
    </ul>

    

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1>WorkingTipsOnCellsOnAndroid10</h1>
    <p align="right">
    <a href="javascript:genPostShot()">
	    TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i>
    </a>
    <a id="test"></a>
    </p>
    <hr>
    <span class="post-date">Feb 2, 2022 
    
    <br/>
    
          <a class="a_cat" href="http://purplepalmdash.github.io/categories/technology">Technology</a>
      
      

    
    </span>
      <div id="_toc" class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-cells-src-preparation">1. cells src preparation</a></li>
        <li><a href="#2-aosp-10-src-preparation">2. aosp 10 src preparation</a></li>
        <li><a href="#3-kernel-src-preparation">3. Kernel src preparation</a></li>
        <li><a href="#4-driver-binary-preparation">4. Driver binary preparation</a></li>
        <li><a href="#5-build-kernel">5. Build kernel</a></li>
        <li><a href="#6-build-the-aosp">6. Build the aosp</a></li>
        <li><a href="#7-flashing">7. Flashing</a></li>
        <li><a href="#8-basic-usage">8. Basic Usage</a></li>
        <li><a href="#9-customization">9. Customization</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    <h3 id="1-cells-src-preparation">1. cells src preparation</h3>
<p>Clone the cells source code via:</p>
<pre><code># mkdir -p ~/Code/show/cells
# cd ~/Code/show/cells
# git clone https://github.com/jianglin-code/cells-android10.git
# cd cells-android10
# ls
cells  frameworks  kernel  README.md  system
</code></pre><h3 id="2-aosp-10-src-preparation">2. aosp 10 src preparation</h3>
<p>Clone the specified aosp 10 version(<code>10.0.0_r33</code>):</p>
<pre><code># mkdir -p ~/Code/show/aosp10
# cd ~/Code/show/aosp10
# repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-10.0.0_r33
# repo sync -j8
</code></pre><h3 id="3-kernel-src-preparation">3. Kernel src preparation</h3>
<p>For pixel 3a, clone the kernel src via:</p>
<pre><code># mkdir -p ~/Code/show/android-kernel
# cd ~/Code/show/android-kernel
#  repo init --depth 1 -u https://aosp.tuna.tsinghua.edu.cn/kernel/manifest -b android-msm-bonito-4.9-android10
# repo sync -j4
# ls
build  build.config  prebuilts  prebuilts-master  private
# du -hs *
732K	build
0	build.config
189M	prebuilts
5.8G	prebuilts-master
870M	private
</code></pre><h3 id="4-driver-binary-preparation">4. Driver binary preparation</h3>
<p>Find the binary version from
<code>https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</code>:</p>
<pre><code>QQ2A.200305.002	android-10.0.0_r30	Android10	Pixel 2、Pixel 2 XL、Pixel 3、Pixel 3 XL、Pixel 3a、Pixel 3a XL	2020-03-05
</code></pre><p>Downlod the driver binary from
<code>https://developers.google.cn/android/drivers?hl=zh-cn#sargoqq2a.200405.005</code>:</p>
<p><img src="/images/2022_02_02_22_55_30_880x211.jpg" alt="/images/2022_02_02_22_55_30_880x211.jpg"></p>
<p>Copy the downloaded files to aosp10 src tree:</p>
<pre><code># cp extract-google_devices-sargo.sh extract-qcom-sargo.sh /root/Code/show/aosp10
</code></pre><h3 id="5-build-kernel">5. Build kernel</h3>
<p>Replace the source code via:</p>
<pre><code># mv private/msm-google private/msm-google.back
# cp -ar  ~/Code/show/cells/cells-android10/kernel/ private/msm-google
</code></pre><p>Build the kernel via:</p>
<pre><code># cd private/msm-google
# make mrproper
# cd ../../
# cp -r private/msm-google.back/techpack/ private/msm-google/
# vim build/build.sh
comment the line of soong_zip(line 798)
# build/build.sh
</code></pre><p>Examine the kernel out files:</p>
<pre><code># ls out/android-msm-pixel-4.9/dist/
abi.prop  Image.lz4              kernel-uapi-headers.tar.gz  System.map  wlan.ko
dtbo.img  kernel-headers.tar.gz  sdm670.dtb                  vmlinux
</code></pre><h3 id="6-build-the-aosp">6. Build the aosp</h3>
<p>Extract the binary files:</p>
<pre><code># ./extract-google_devices-sargo.sh 
# ./extract-qcom-sargo.sh 
</code></pre><p>Replace the kernel:</p>
<pre><code># mv device/google/bonito-kernel/Image.lz4 device/google/bonito-kernel/Image.lz4.back
# cp /root/Code/show/android-kernel/out/android-msm-pixel-4.9/dist/Image.lz4 device/google/bonito-kernel/Image.lz4
</code></pre><p>Including the cells into building:</p>
<pre><code># cp -r /root/Code/show/cells/cells-android10/cells/ vendor/
# vim device/google/bonito/device.mk
Added at the last line:   
$(call inherit-product-if-exists, vendor/cells/cells_build.mk)
</code></pre><p>Building via:</p>
<pre><code># source build/envsetup.sh
# lunch aosp_sargo-userdebug
# vim frameworks/base/data/etc/privapp-permissions-platform.xml
Added: 
    &lt;privapp-permissions package=&quot;com.cells.cellswitch.secure&quot;&gt;
        &lt;permission name=&quot;android.permission.BLUETOOTH_PRIVILEGED&quot;/&gt;
    &lt;/privapp-permissions&gt;
# vim vendor/cells/switchsystem/src/com/cells/cellswitch/secure/view/SwitchActivity.java
Commentd: 
//import android.os.CellsManager;
//import android.os.ICellsManager;
# cp -r /root/Code/show/aosp10back/frameworks/multidex/library/
frameworks/multidex
# m -j128
</code></pre><p>The building will failed, solved via:</p>
<pre><code># development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libbinder &amp;&amp; development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libhwbinder_noltopgo &amp;&amp; development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libhidlbase &amp;&amp; m -j128
</code></pre><p>Output:</p>
<pre><code># ls out/target/product/sargo/*.img
out/target/product/sargo/boot-debug.img     out/target/product/sargo/ramdisk.img
out/target/product/sargo/boot.img           out/target/product/sargo/ramdisk-recovery.img
out/target/product/sargo/dtb.img            out/target/product/sargo/super_empty.img
out/target/product/sargo/dtbo.img           out/target/product/sargo/system.img
out/target/product/sargo/persist.img        out/target/product/sargo/system_other.img
out/target/product/sargo/product.img        out/target/product/sargo/vbmeta.img
out/target/product/sargo/ramdisk-debug.img  out/target/product/sargo/vendor.img
</code></pre><p>Final size for building:</p>
<pre><code># du -hs *
15G     android-kernel
177G    aosp10
2.4G    aosp10back
6.0G    cells
</code></pre><h3 id="7-flashing">7. Flashing</h3>
<p>With pixel 3a connected with usb:</p>
<pre><code>$ adb devices
List of devices attached
92UAY04L95	device

$  adb reboot bootloader
</code></pre><p>Flash with following command:</p>
<pre><code>$ fastboot devices
92UAY04L95	fastboot
$ export ANDROID_PRODUCT_OUT=/root/Code/show/aosp10/out/target/product/sargo
$ fastboot flashall -w
--------------------------------------------
Bootloader Version...: b4s4-0.2-6355063
Baseband Version.....: g670-00042-200421-B-6414611
Serial Number........: 92UAY04L95
--------------------------------------------
Checking 'product'                                 OKAY [  0.058s]
Setting current slot to 'b'                        OKAY [  0.138s]
.....
Erasing 'userdata'                                 OKAY [  0.311s]
Erase successful, but not automatically formatting.
File system type raw not supported.
Erasing 'metadata'                                 OKAY [  0.006s]
Erase successful, but not automatically formatting.
File system type raw not supported.
Rebooting                                          OKAY [  0.001s]
Finished. Total time: 336.662s
</code></pre><p>Flashing with wlan.ko, so that we could get wireless connection:</p>
<pre><code># disable-verity on the phone
adb root
adb disable-verity
adb shell sync
adb reboot

# push module
adb root
adb remount
adb push /media/nfs1/android-kernel/out/android-msm-pixel-4.9/dist/wlan.ko /vendor/lib/modules/

# reboot phone
adb reboot

</code></pre><h3 id="8-basic-usage">8. Basic Usage</h3>
<p>View the build number: <br>
<img src="/images/2022_02_03_10_18_02_498x265.jpg" alt="/images/2022_02_03_10_18_02_498x265.jpg"></p>
<p><code>Control</code> is the switch for dual-system:</p>
<p><img src="/images/2022_02_03_10_26_40_346x397.jpg" alt="/images/2022_02_03_10_26_40_346x397.jpg"></p>
<p>Press <code>Control</code> shows the <code>Start</code> button:</p>
<p><img src="/images/2022_02_03_10_27_56_236x459.jpg" alt="/images/2022_02_03_10_27_56_236x459.jpg"></p>
<p>The second system is starting:</p>
<p><img src="/images/2022_02_03_10_28_34_234x472.jpg" alt="/images/2022_02_03_10_28_34_234x472.jpg"></p>
<p>After started:</p>
<p><img src="/images/2022_02_03_10_29_19_233x477.jpg" alt="/images/2022_02_03_10_29_19_233x477.jpg"></p>
<p>Press <code>Start</code> for entering the 2nd system:</p>
<p><img src="/images/2022_02_03_10_30_12_230x475.jpg" alt="/images/2022_02_03_10_30_12_230x475.jpg"></p>
<p>Press <code>Control</code> will show hints for Exit this system:</p>
<p><img src="/images/2022_02_03_10_31_09_231x479.jpg" alt="/images/2022_02_03_10_31_09_231x479.jpg"></p>
<p>After exit, the system will show on the screen lock:</p>
<p><img src="/images/2022_02_03_10_31_44_235x479.jpg" alt="/images/2022_02_03_10_31_44_235x479.jpg"></p>
<h3 id="9-customization">9. Customization</h3>
<p>Language setting.</p>
<p>Install software shop in both system.:</p>
<pre><code>$ adb install apks/MobileAssistant_1.apk 
Performing Streamed Install
Success
</code></pre><p>Install more apks in both systems.</p>
<p>Changing the theme.</p>

  </div>
  
</div>






<script src="http://purplepalmdash.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

