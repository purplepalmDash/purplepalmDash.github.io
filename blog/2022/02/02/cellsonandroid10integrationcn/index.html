<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>CellsOnAndroid10IntegrationCN &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="WorkingTipsOnCellsOnAndroid10"><meta name=keywords content="Technology"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>Get busy living, or get busy dying.</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>CellsOnAndroid10IntegrationCN</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Feb 2, 2022<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#1-cells源码准备>1. cells源码准备</a></li><li><a href=#2-aosp-10源码准备>2. aosp 10源码准备</a></li><li><a href=#3-内核源码准备>3. 内核源码准备</a></li><li><a href=#4-二进制驱动准备>4. 二进制驱动准备</a></li><li><a href=#5-编译内核>5. 编译内核</a></li><li><a href=#6-aosp源码编译>6. aosp源码编译</a></li><li><a href=#7-烧写镜像>7. 烧写镜像</a></li><li><a href=#8-基本使用场景>8. 基本使用场景</a></li><li><a href=#9-定制化>9. 定制化</a></li></ul></li></ul></nav></div><h3 id=1-cells源码准备>1. cells源码准备</h3><p>从github克隆代码至本地目录</p><pre><code># mkdir -p ~/Code/show/cells
# cd ~/Code/show/cells
# git clone https://github.com/jianglin-code/cells-android10.git
# cd cells-android10
# ls
cells  frameworks  kernel  README.md  system
</code></pre><h3 id=2-aosp-10源码准备>2. aosp 10源码准备</h3><p>对标cells源码中的要求, 克隆特定版本的aosp10源码(<code>10.0.0_r33</code>):</p><pre><code># mkdir -p ~/Code/show/aosp10
# cd ~/Code/show/aosp10
# repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-10.0.0_r33
# repo sync -j8
</code></pre><h3 id=3-内核源码准备>3. 内核源码准备</h3><p>因为使用的真机是pixel 3a，内核源码的获取见以下代码:</p><pre><code># mkdir -p ~/Code/show/android-kernel
# cd ~/Code/show/android-kernel
#  repo init --depth 1 -u https://aosp.tuna.tsinghua.edu.cn/kernel/manifest -b android-msm-bonito-4.9-android10
# repo sync -j4
# ls
build  build.config  prebuilts  prebuilts-master  private
# du -hs *
732K	build
0	build.config
189M	prebuilts
5.8G	prebuilts-master
870M	private
</code></pre><h3 id=4-二进制驱动准备>4. 二进制驱动准备</h3><p>从以下网址查找真机对应需要的二进制驱动标号:<br><code>https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</code>:</p><pre><code>QQ2A.200305.002	android-10.0.0_r30	Android10	Pixel 2、Pixel 2 XL、Pixel 3、Pixel 3 XL、Pixel 3a、Pixel 3a XL	2020-03-05
</code></pre><p>根据查找出的代号，从以下网址下载二进制驱动文件:<br><code>https://developers.google.cn/android/drivers?hl=zh-cn#sargoqq2a.200405.005</code>:</p><p><img src=/images/2022_02_02_22_55_30_880x211.jpg alt=/images/2022_02_02_22_55_30_880x211.jpg></p><p>将下载的二进制驱动文件拷贝到aosp源码树:</p><pre><code># cp extract-google_devices-sargo.sh extract-qcom-sargo.sh /root/Code/show/aosp10
</code></pre><h3 id=5-编译内核>5. 编译内核</h3><p>使用<code>cells</code>源码中的相应目录替换aosp10内核中对应代码:</p><pre><code># mv private/msm-google private/msm-google.back
# cp -ar  ~/Code/show/cells/cells-android10/kernel/ private/msm-google
</code></pre><p>使用以下命令编译内核:</p><pre><code># cd private/msm-google
# make mrproper
# cd ../../
# cp -r private/msm-google.back/techpack/ private/msm-google/
# vim build/build.sh
comment the line of soong_zip(line 798)
# build/build.sh
</code></pre><p>检验内核编译出的二进制文件:</p><pre><code># ls out/android-msm-pixel-4.9/dist/
abi.prop  Image.lz4              kernel-uapi-headers.tar.gz  System.map  wlan.ko
dtbo.img  kernel-headers.tar.gz  sdm670.dtb                  vmlinux
</code></pre><h3 id=6-aosp源码编译>6. aosp源码编译</h3><p>解压二进制驱动代码:</p><pre><code># ./extract-google_devices-sargo.sh 
# ./extract-qcom-sargo.sh 
</code></pre><p>替换aosp中内置的内核代码:</p><pre><code># mv device/google/bonito-kernel/Image.lz4 device/google/bonito-kernel/Image.lz4.back
# cp /root/Code/show/android-kernel/out/android-msm-pixel-4.9/dist/Image.lz4 device/google/bonito-kernel/Image.lz4
</code></pre><p>将cells源码并入到aosp编译树中:</p><pre><code># cp -r /root/Code/show/cells/cells-android10/cells/ vendor/
# vim device/google/bonito/device.mk
Added at the last line:   
$(call inherit-product-if-exists, vendor/cells/cells_build.mk)
</code></pre><p>开始编译:</p><pre><code># source build/envsetup.sh
# lunch aosp_sargo-userdebug
# vim frameworks/base/data/etc/privapp-permissions-platform.xml
增加: 
    &lt;privapp-permissions package=&quot;com.cells.cellswitch.secure&quot;&gt;
        &lt;permission name=&quot;android.permission.BLUETOOTH_PRIVILEGED&quot;/&gt;
    &lt;/privapp-permissions&gt;
# vim vendor/cells/switchsystem/src/com/cells/cellswitch/secure/view/SwitchActivity.java
注释掉: 
//import android.os.CellsManager;
//import android.os.ICellsManager;
# cp -r /root/Code/show/aosp10back/frameworks/multidex/library/
frameworks/multidex
# m -j128
</code></pre><p>编译到80%左右时将失败，重新计算依赖后编译方可成功:</p><pre><code># development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libbinder &amp;&amp; development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libhwbinder_noltopgo &amp;&amp; development/vndk/tools/header-checker/utils/create_reference_dumps.py  -l libhidlbase &amp;&amp; m -j128
</code></pre><p>检验编译输出文件:</p><pre><code># ls out/target/product/sargo/*.img
out/target/product/sargo/boot-debug.img     out/target/product/sargo/ramdisk.img
out/target/product/sargo/boot.img           out/target/product/sargo/ramdisk-recovery.img
out/target/product/sargo/dtb.img            out/target/product/sargo/super_empty.img
out/target/product/sargo/dtbo.img           out/target/product/sargo/system.img
out/target/product/sargo/persist.img        out/target/product/sargo/system_other.img
out/target/product/sargo/product.img        out/target/product/sargo/vbmeta.img
out/target/product/sargo/ramdisk-debug.img  out/target/product/sargo/vendor.img
</code></pre><p>最终编译树尺寸大小:</p><pre><code># du -hs *
15G     android-kernel
177G    aosp10
2.4G    aosp10back
6.0G    cells
</code></pre><h3 id=7-烧写镜像>7. 烧写镜像</h3><p>通过USB连接pixel 3a:</p><pre><code>$ adb devices
List of devices attached
92UAY04L95	device

$  adb reboot bootloader
</code></pre><p>通过以下命令烧录镜像:</p><pre><code>$ fastboot devices
92UAY04L95	fastboot
$ export ANDROID_PRODUCT_OUT=/root/Code/show/aosp10/out/target/product/sargo
$ fastboot flashall -w
--------------------------------------------
Bootloader Version...: b4s4-0.2-6355063
Baseband Version.....: g670-00042-200421-B-6414611
Serial Number........: 92UAY04L95
--------------------------------------------
Checking 'product'                                 OKAY [  0.058s]
Setting current slot to 'b'                        OKAY [  0.138s]
.....
Erasing 'userdata'                                 OKAY [  0.311s]
Erase successful, but not automatically formatting.
File system type raw not supported.
Erasing 'metadata'                                 OKAY [  0.006s]
Erase successful, but not automatically formatting.
File system type raw not supported.
Rebooting                                          OKAY [  0.001s]
Finished. Total time: 336.662s
</code></pre><p>将二进制驱动烧录进真机，从而可以使用无线连接:</p><pre><code># 禁用校验机制
adb root
adb disable-verity
adb shell sync
adb reboot

# 上传模块
adb root
adb remount
adb push /media/nfs1/android-kernel/out/android-msm-pixel-4.9/dist/wlan.ko /vendor/lib/modules/

# 重启手机生效
adb reboot

</code></pre><h3 id=8-基本使用场景>8. 基本使用场景</h3><p>检验编译串号:<br><img src=/images/2022_02_03_10_18_02_498x265.jpg alt=/images/2022_02_03_10_18_02_498x265.jpg></p><p><code>控制中心</code>是用来切换双系统的快捷方式:</p><p><img src=/images/2022_02_03_10_26_40_346x397.jpg alt=/images/2022_02_03_10_26_40_346x397.jpg></p><p>点击<code>控制中心</code>后将出现<code>Start</code>按钮:</p><p><img src=/images/2022_02_03_10_27_56_236x459.jpg alt=/images/2022_02_03_10_27_56_236x459.jpg></p><p>点击<code>Start</code>按钮后，第二系统将启动:</p><p><img src=/images/2022_02_03_10_28_34_234x472.jpg alt=/images/2022_02_03_10_28_34_234x472.jpg></p><p>启动成功:</p><p><img src=/images/2022_02_03_10_29_19_233x477.jpg alt=/images/2022_02_03_10_29_19_233x477.jpg></p><p>再次点击<code>Start</code>按钮进入到第二系统:</p><p><img src=/images/2022_02_03_10_30_12_230x475.jpg alt=/images/2022_02_03_10_30_12_230x475.jpg></p><p>在第二系统中点击<code>控制中心</code>将提示推出该系统并回到主系统:</p><p><img src=/images/2022_02_03_10_31_09_231x479.jpg alt=/images/2022_02_03_10_31_09_231x479.jpg></p><p>退出后将回到第一系统的锁屏界面:</p><p><img src=/images/2022_02_03_10_31_44_235x479.jpg alt=/images/2022_02_03_10_31_44_235x479.jpg></p><h3 id=9-定制化>9. 定制化</h3><p>定制化1： 语言设置/输入法设置</p><p>定制化2：为双系统各自安装软件仓库:</p><pre><code>$ adb install apks/MobileAssistant_1.apk 
Performing Streamed Install
Success
</code></pre><p>定制化3：为双系统安装更多的apks：</p><p>定制化4: 更改主题等</p></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>