<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>RunRedroidOnAndroidX86CN &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="RunRedroidOnAndroidX86CN"><meta name=keywords content="Technology"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>Get busy living, or get busy dying.</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>RunRedroidOnAndroidX86CN</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Feb 7, 2022<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#介绍>介绍</a></li><li><a href=#编译-android-x86>编译 Android-x86</a></li><li><a href=#自定义内核>自定义内核</a></li><li><a href=#android-x86-安装>Android-x86 安装</a></li><li><a href=#使能-docker>使能 docker</a></li><li><a href=#验证>验证</a></li><li><a href=#内核配置>内核配置</a></li></ul></li></ul></nav></div><p>这篇指南将详细讲述如何在Android-x86上运行redroid容器。</p><h3 id=介绍>介绍</h3><p>Redroid:</p><blockquote><p>ReDroid (Remote anDroid) 是一种支持GPU加速的(容器中的Android)方案. 你可以在任意Linux主机(Docker, podman, k8s等)上使用。Redoird支持arm64及amd64架构，Redroid适用于云游， VMI(Virtual Mobile Infrstructure), 自动化测试及更多场景。<br><a href=https://github.com/remote-android/redroid-doc#overview>https://github.com/remote-android/redroid-doc#overview</a></p></blockquote><p>Android-x86:</p><blockquote><p>在PC上运行Android. 这个项目被用于将Android Open Source Project移植到x86平台上，项目前身为"patch hosting for android x86 support&rdquo;.<br><a href=https://www.android-x86.org/>https://www.android-x86.org/</a></p></blockquote><h3 id=编译-android-x86>编译 Android-x86</h3><p>我们从<code>pie</code>(aosp9)分支作为起点:</p><pre><code># mkdir android-x86
# cd android-x86
# repo init -u git://git.osdn.net/gitroot/android-x86/manifest -b pie-x86
# repo sync --no-tags --no-clone-bundle -j18
</code></pre><p>或者，进一步指定其子版本(非master分支):</p><pre><code>repo init -u git://git.osdn.net/gitroot/android-x86/manifest -b pie-x86 -m android-x86-9.0-r2.xml
repo sync --no-tags --no-clone-bundle
</code></pre><p>repo 大小为:</p><pre><code># du -hs android-x86/
79G	android-x86/
# ls android-x86/
Android.bp  bionic    bootstrap.bash  compatibility  dalvik       device    frameworks  kernel   libnativehelper  packages  platform_testing  sdk     test
art         bootable  build           cts            development  external  hardware    libcore  Makefile         pdk       prebuilts         system  tools
</code></pre><p>对rootdir作修改，目的是为了启用binderfs:</p><pre><code># vim ./system/core/rootdir/init.rc
    mount configfs none /config nodev noexec nosuid
    chmod 0770 /config/sdcardfs
    chown system package_info /config/sdcardfs

+    # Mount binderfs
+    mkdir /dev/binderfs
+    mount binder binder /dev/binderfs stats=global
+    chmod 0755 /dev/binderfs
+ 
+    # Mount fusectl
+    mount fusectl none /sys/fs/fuse/connections
+ 
+    symlink /dev/binderfs/binder /dev/binder                                            
+    symlink /dev/binderfs/hwbinder /dev/hwbinder
+    symlink /dev/binderfs/vndbinder /dev/vndbinder
+ 
+    chmod 0666 /dev/binderfs/hwbinder
+    chmod 0666 /dev/binderfs/binder
+    chmod 0666 /dev/binderfs/vndbinder
</code></pre><p>使用以下命令编译出iso文件:</p><pre><code># . build/envsetup.sh; lunch android_x86_64-userdebug
# make iso_img TARGET_PRODUCT=android_x86_64 -j128
</code></pre><p>检查编译出的Iso文件:</p><pre><code># ls -l -h out/target/product/x86_64/android_x86_64.iso
-rw-r--r-- 1 root root 725M Feb  5 02:02 out/target/product/x86_64/android_x86_64.iso
</code></pre><h3 id=自定义内核>自定义内核</h3><p>自定义内核步骤如下(详细步骤见最后章节kernel configuration)：</p><pre><code># cd kernel
# make android-x86_64_defconfig
# make menuconfig
##### After make customization
# cp arch/x86/configs/android-x86_64_defconfig arch/x86/configs/android-x86_64_defconfig.back
# cp .config arch/x86/configs/android-x86_64_defconfig 
</code></pre><p>重新编译内核并生成iso文件:</p><pre><code># cd kernel
# make mrproper
# cd ..
# . build/envsetup.sh; lunch android_x86_64-userdebug
# rm $OUT/obj/kernel/arch/x86/boot/bzImage
# make iso_img TARGET_PRODUCT=android_x86_64 -j128
</code></pre><h3 id=android-x86-安装>Android-x86 安装</h3><p>在虚拟机中安装Android-x86:</p><p><img src=/images/2022_02_05_16_38_45_562x474.jpg alt=/images/2022_02_05_16_38_45_562x474.jpg></p><p>选择分区:</p><p><img src=/images/2022_02_05_16_39_12_661x200.jpg alt=/images/2022_02_05_16_39_12_661x200.jpg></p><p>是否选择GPT:</p><p><img src=/images/2022_02_05_16_56_29_367x174.jpg alt=/images/2022_02_05_16_56_29_367x174.jpg></p><p>cfdisk:</p><p><img src=/images/2022_02_05_17_00_19_740x423.jpg alt=/images/2022_02_05_17_00_19_740x423.jpg></p><p>创建一个200GB大小的主分区:</p><p><img src=/images/2022_02_05_17_03_04_714x415.jpg alt=/images/2022_02_05_17_03_04_714x415.jpg></p><p>选择Write, Quit后，在安装界面中选择分区进行安装:</p><p><img src=/images/2022_02_05_17_04_37_673x346.jpg alt=/images/2022_02_05_17_04_37_673x346.jpg></p><p>选择格式化为ext4格式:</p><p><img src=/images/2022_02_05_17_05_03_534x174.jpg alt=/images/2022_02_05_17_05_03_534x174.jpg></p><p>确认:</p><p><img src=/images/2022_02_05_17_05_56_535x166.jpg alt=/images/2022_02_05_17_05_56_535x166.jpg></p><p>继续格式化:</p><p><img src=/images/2022_02_05_17_06_17_642x152.jpg alt=/images/2022_02_05_17_06_17_642x152.jpg></p><p>确认:</p><p><img src=/images/2022_02_05_17_06_39_436x131.jpg alt=/images/2022_02_05_17_06_39_436x131.jpg></p><p>设置为可读/可写模式:</p><p><img src=/images/2022_02_05_17_07_09_554x170.jpg alt=/images/2022_02_05_17_07_09_554x170.jpg></p><p>开始安装:</p><p><img src=/images/2022_02_05_17_07_19_642x156.jpg alt=/images/2022_02_05_17_07_19_642x156.jpg></p><p>选择 Reboot, 完成安装:</p><p><img src=/images/2022_02_05_17_08_10_480x191.jpg alt=/images/2022_02_05_17_08_10_480x191.jpg></p><h3 id=使能-docker>使能 docker</h3><p>在Android-x86界面中，使能 wifi:</p><p><img src=/images/2022_02_05_18_16_24_926x458.jpg alt=/images/2022_02_05_18_16_24_926x458.jpg></p><p>adb root and re-connect:</p><pre><code># adb connect 192.168.122.232
connected to 192.168.122.232:5555
# adb -s 192.168.122.232:5555 root
restarting adbd as root
# adb connect 192.168.122.232
connected to 192.168.122.232:5555
</code></pre><p>创建docker工作目录:</p><pre><code># adb shell
x86_64:/ # mkdir /data/var                                                                                                                                 
x86_64:/ # mkdir /data/docker/
x86_64:/ # 
</code></pre><p>从docker-ce官方网站下载docker-ce二进制包， 将其本地解压后通过adb push命令上传到对应目录:</p><pre><code># adb push ~/Code/docker/* /data/docker/
</code></pre><p>在<code>adb shell</code>命令行下准备dockerd工作环境:</p><pre><code>mount -o remount,rw /
ln -s /data/docker/* /bin/
ip rule add pref 1 from all lookup main
ip rule add pref 2 from all lookup default
ip route add default via 192.168.122.1 dev wlan0
ip rule add from all lookup main pref 30000
echo &quot;nameserver 223.5.5.5&quot;&gt;/etc/resolv.conf
# mount cgroupfs
mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup /sys/fs/cgroup
cd /sys/fs/cgroup/
mkdir -p cpu cpu acct blkio memory devices pids
mount -n -t cgroup -o cpu cgroup cpu
mount -n -t cgroup -o  cpuacct cgroup cpuacct
mount -n -t cgroup -o  blkio cgroup blkio
mount -n -t cgroup -o  memory cgroup memory
mount -n -t cgroup -o  devices cgroup devices
mount -n -t cgroup -o  pids cgroup pids
</code></pre><p>使用以下命令启动dockerd守护进程:</p><pre><code># dockerd  --dns=223.5.5.5 --data-root=/data/var/ --ip=192.168.122.232 &amp; &gt;/data/dockerd-logfile 2&gt;&amp;1
# docker images
REPOSITORY   TAG       IMAGE ID   CREATED   SIZE
</code></pre><p>此时可以启动redroid容器实例:</p><pre><code># docker run -d --privileged -p 8888:5555 redroid/redroid:9.0.0-latest
# docker ps
CONTAINER ID   IMAGE                          COMMAND                  CREATED         STATUS         PORTS                            NAMES
2efa5f6e987b   redroid/redroid:9.0.0-latest   &quot;/init qemu=1 androi…&quot;   5 seconds ago   Up 4 seconds   192.168.122.232:8888-&gt;5555/tcp   sweet_ishizaka
</code></pre><h3 id=验证>验证</h3><p>adb connect并使用scrcpy命令验证redroid实例是否运行正常:</p><pre><code># adb connect 192.168.122.232:8888
# scrcpy --serial 192.168.122.232:8888
</code></pre><p><img src=/images/2022_02_06_09_34_35_427x768.jpg alt=/images/2022_02_06_09_34_35_427x768.jpg></p><p>通过以下命令在redroid实例中安装apk:</p><pre><code>$ adb -s 192.168.122.232:8888 install ~/apks/aaaaaaa.apk
</code></pre><h3 id=内核配置>内核配置</h3><p>需追加的内核配置项(基于arch/x86/configs下的 <code>android-x86_64_defconfig</code>):</p><pre><code>Generic setup -&gt; POSIX Message Queues
Generic setup -&gt; Controller Group support -&gt; PIDs controller
Generic setup -&gt; Controller Group support -&gt; Device controller
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; Group sheduling for SCHED_OTHER
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; CPU bandwidth provisioning for FAIR-GROUP_SCHED
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; Group sheduling for SCHED_RR/FIFO
Generic setup -&gt; Controller Group support -&gt; Perf controller
Generic setup -&gt; Namespaces support -&gt; User namespace
Generic setup -&gt; Namespaces support -&gt; PID namespace
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Bridged IP/ARP packets fiiltering
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; IP virtual server support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;addrtype&quot; address type match support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;control group&quot; address type match support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;control group&quot; address type match support
File Systems -&gt; Overlay filesystem support
Device Driver -&gt; Android -&gt;  Android Binderfs filesystem
</code></pre></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>