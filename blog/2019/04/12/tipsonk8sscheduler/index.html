<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>TipsOnK8SScheduler &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="TipsOnK8SScheduler"><meta name=keywords content="Linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>TipsOnK8SScheduler</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Apr 12, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#问题>问题</a></li><li><a href=#追溯>追溯</a></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></li></ul></nav></div><h3 id=问题>问题</h3><p>文章来源:<br><a href=https://blog.csdn.net/horsefoot/article/details/51577402>https://blog.csdn.net/horsefoot/article/details/51577402</a></p><p><img src=/images/2019_04_12_23_25_30_1078x550.jpg alt=/images/2019_04_12_23_25_30_1078x550.jpg></p><p>印象中我没有见过K8S中有这样的调度策略，那这个博客的提法是从何而来？</p><h3 id=追溯>追溯</h3><p>Google关键字，看到这个比较类似：</p><p><img src=/images/2019_04_12_23_29_24_763x231.jpg alt=/images/2019_04_12_23_29_24_763x231.jpg></p><p>fabric8(一个基于k8s的CI/CD平台)里的条目, 时间维度是16年3月：</p><p><img src=/images/2019_04_12_23_30_49_749x248.jpg alt=/images/2019_04_12_23_30_49_749x248.jpg></p><p>内中条目:</p><p><img src=/images/2019_04_12_23_31_52_900x349.jpg alt=/images/2019_04_12_23_31_52_900x349.jpg></p><p>看来k8s的proposal文档中确实有过这个条目，继续用不同关键字搜索,
找到一个相关issue:</p><p><img src=/images/2019_04_12_23_33_13_648x245.jpg alt=/images/2019_04_12_23_33_13_648x245.jpg></p><p>点进去阅读此issue:</p><p><img src=/images/2019_04_12_23_36_41_756x610.jpg alt=/images/2019_04_12_23_36_41_756x610.jpg></p><p>半成品状态：</p><p><img src=/images/2019_04_12_23_39_19_627x477.jpg alt=/images/2019_04_12_23_39_19_627x477.jpg></p><p>issue被re-assign给另外的开发者, 最终被关闭：</p><p><img src=/images/2019_04_12_23_43_03_783x432.jpg alt=/images/2019_04_12_23_43_03_783x432.jpg></p><p>回到其父issue:</p><p>问题提出:</p><p><img src=/images/2019_04_13_00_36_30_695x251.jpg alt=/images/2019_04_13_00_36_30_695x251.jpg></p><pre><code>当预测错误时，必须有反馈。特别是，我认为重要的是，
超过其请求的Pod（由于不正确的初始预测）比其请求下的
其他pod更可能被杀死。这样，“设置初始限制”系统的故障
似乎会影响特定的pod，而不是随机的pod，这使得诊断非常困难。

一种方法是使系统OOM情况下的终止概率与请求量成比例。
 @AnanyaKumar @vishh目前的实施有没有这个属性？
</code></pre><p><img src=/images/2019_04_13_00_23_35_775x634.jpg alt=/images/2019_04_13_00_23_35_775x634.jpg></p><p>以上讨论解释了为何设置初始资源用量会带来更多问题：</p><pre><code>@erictune我看到你的观点，我同意设置限制会解决你的情况。
 另一方面，我可以想象一些其他情况，它将带来更多的麻烦。
 特别是当预先估计错误的时候，用户会观察到调度程序将意
外杀死他的容器时。 因此，对资源的分配，采用设置限制的
方式会带来更高的可靠性，我们无法从一开始就保证它。

我认为每个人都同意设置请求(Request)应该改善整体体验，
这可能不适用于设置限制(Limits)。 从长远来看，我们肯
定想要设置两者，但我只会在第一个版本中设置Request（可
能与v1.1不同），从用户收集一些反馈，然后在我们调整算法
后最终添加设置限制。

@vishh如果有两个容器超出他们的要求：哪一个将被杀死？ 
超过请求'更多'或随机的一个？
</code></pre><p>至此，即可以看到，作者文章中的提法应该是理解错误了，使用7天/30天等历史数据预估资源使用只是为了完成<code>Vertical pod auto-sizer</code>这个特性的开发，而提出的一种备选方案。</p><p>作者可能当时仅仅是看了Kubernetes社区开发中的一个开发特性的建议文档，就认为Kubernetes拥有了"预测资源需求量"的功能，事实上K8s的调度引擎从来不会去预估资源需求量。</p><p>&ldquo;vertical pod auto-sizer"这一特性一直到18年底才进入到alpha阶段，vpa特性的实现也不再是依靠16年时定义而实现。 在作者写文章的2016年，vpa试图根据当时用于收集容器指标的influxdb来实现预估代码，结果失败了；而influxdb+heapster应该是18年就被metric
server所替代。当前处于alpha阶段的vpa特性也就依赖于metric server而实现。我们可以看到以下列出的代码变更：</p><p>含有文章中提法的代码目录于v1.1版中被引入，至v1.11版被删除。</p><p><img src=/images/2019_04_13_00_55_36_602x320.jpg alt=/images/2019_04_13_00_55_36_602x320.jpg></p><p>v1.10版后被从主线删除：</p><p><img src=/images/2019_04_13_00_56_54_564x542.jpg alt=/images/2019_04_13_00_56_54_564x542.jpg></p><h3 id=总结>总结</h3><p>从对issue的跟踪来看，应该是作者理解错了。预先估计资源用量从来不是Kubernetes定义资源需求的正确方法。<br>对于Kubernetes调度讲得比较好的一篇文章如下：</p><p><a href=http://dockone.io/article/2885>http://dockone.io/article/2885</a></p><p>官方对资源限制的参考页面如下：</p><p><a href=https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-memory-limit/>https://kubernetes.io/zh/docs/tasks/administer-cluster/cpu-memory-limit/</a><br>如果需要在生产环境中优化资源的使用，可以参考：</p><p><a href=https://www.yangcs.net/posts/optimizing-kubernetes-resource-allocation-production/>https://www.yangcs.net/posts/optimizing-kubernetes-resource-allocation-production/</a></p><h3 id=参考>参考</h3><p>Vertical pod auto-sizer, issue #10782:</p><p><a href=https://github.com/kubernetes/kubernetes/issues/10782>https://github.com/kubernetes/kubernetes/issues/10782</a></p><p>Setting Initial Resources, issue #12149:</p><p><a href=https://github.com/kubernetes/kubernetes/issues/12149>https://github.com/kubernetes/kubernetes/issues/12149</a></p><p>initial-resources.md:</p><p><a href=https://github.com/fabric8io/kansible/blob/master/vendor/k8s.io/kubernetes/docs/proposals/initial-resources.md>https://github.com/fabric8io/kansible/blob/master/vendor/k8s.io/kubernetes/docs/proposals/initial-resources.md</a></p><p>vpa 官方仓库：</p><p><a href=https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler>https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler</a></p></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>