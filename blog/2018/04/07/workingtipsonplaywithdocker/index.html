<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>WorkingTipsOnPlayWithDocker &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><meta name=description content="WorkingTipsOnPlayWithDocker"><meta name=keywords content="Linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>Get busy living, or get busy dying.</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=post><h1>WorkingTipsOnPlayWithDocker</h1><p align=right><a href=javascript:genPostShot()>TurnToJPG --> <i class="fa fa-camera-retro fa-2x"></i></a><a id=test></a></p><hr><span class=post-date>Apr 7, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><div id=_toc class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#environment>Environment</a></li><li><a href=#system>System</a></li><li><a href=#fixed-ip>Fixed IP</a></li><li><a href=#local-registry>Local Registry</a></li><li><a href=#build-dind>Build dind</a></li><li><a href=#local-play-with-docker>Local play-with-docker</a></li><li><a href=#play-with-docker-classroom>play-with-docker classroom</a></li><li><a href=#tips-for-docker-nginx>tips for docker-nginx</a></li></ul></li></ul></nav></div><h3 id=environment>Environment</h3><h4 id=qemu-image>Qemu Image</h4><p>Qemu image preparation:</p><pre><code># mkdir offline-play-with-docker
# cd offline-play-with-docker 
# qemu-img create -f qcow2 offline-play-with-docker.qcow2 200G
Formatting 'offline-play-with-docker.qcow2', fmt=qcow2 size=214748364800 cluster_size=65536 lazy_refcounts=off refcount_bits=16
</code></pre><h4 id=virt-manager-networking>Virt-manager Networking</h4><p>Network Name:</p><p><img src=/images/2018_04_07_10_33_34_346x179.jpg alt=/images/2018_04_07_10_33_34_346x179.jpg>
Definition of IPV4:</p><p><img src=/images/2018_04_07_10_34_29_338x431.jpg alt=/images/2018_04_07_10_34_29_338x431.jpg></p><p>Warning:</p><p><img src=/images/2018_04_07_10_34_50_505x137.jpg alt=/images/2018_04_07_10_34_50_505x137.jpg></p><p>Isolation(Could be adjust to isolated):</p><p><img src=/images/2018_04_07_10_35_35_386x231.jpg alt=/images/2018_04_07_10_35_35_386x231.jpg></p><p>Create vm and specify vmworks:</p><p><img src=/images/2018_04_07_13_35_07_540x268.jpg alt=/images/2018_04_07_13_35_07_540x268.jpg></p><p>Install CentOS 7.4, partition like following:</p><p><img src=/images/2018_04_07_13_38_50_484x224.jpg alt=/images/2018_04_07_13_38_50_484x224.jpg></p><p><img src=/images/2018_04_07_13_39_10_650x209.jpg alt=/images/2018_04_07_13_39_10_650x209.jpg></p><h3 id=system>System</h3><p>Set the hostname via:</p><p><img src=/images/2018_04_07_14_35_11_543x279.jpg alt=/images/2018_04_07_14_35_11_543x279.jpg></p><p>Install mate desktop(for debugging purpose):</p><pre><code># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
# yum --enablerepo=epel -y groups install &quot;MATE Desktop&quot;
</code></pre><p>Install some tools:</p><pre><code># yum install -y vim wget python-pip gcc git nethogs
# pip install shadowsocks
# pip inststall --upgrade pip
# yum install -y libevent-devel
# build the redsocks for crossing the gfw!!!
</code></pre><p>Now you could cross the firewall for installing the go or other
staffs(crossing the gfw WILL let everything more smoothly).</p><p>Install docker-ce:</p><pre><code>#  yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2
# yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
# yum install -y docker-ce
</code></pre><p>Install docker-compose via pip:</p><pre><code># pip install docker-compose
</code></pre><p>Start and enable docker:</p><pre><code># systemctl enable docker
# systemctl start docker
# docker swarm init
</code></pre><p>You have to run <code>docker swarm init</code>, or you won&rsquo;t login into the
play-with-docker.</p><p>Install golang:</p><pre><code># yum install -y golang
# mkdir ~/go
# vim ~/.bashrc
export GOPATH=/root/go
export PATH=$PATH:$GOPATH/bin
</code></pre><p>Create the directory and clone the source code:</p><pre><code># mkdir ~/Code
# cd Code
# git clone https://github.com/play-with-docker/play-with-docker.git
</code></pre><p>Build the <code>play-with-go</code>:</p><pre><code># go get -u github.com/golang/dep/cmd/dep
# which dep
/root/go/bin/dep
# cd ~/Code/play-with-docker/
# go get -v -d -t ./...
# cd /root/go/src/github.com/play-with-docker/play-with-docker
# dep ensure
</code></pre><h3 id=fixed-ip>Fixed IP</h3><p>Fixed IP address then we could manually build the dind adjusting to this IP
address:</p><p><img src=/images/2018_04_07_15_03_06_595x287.jpg alt=/images/2018_04_07_15_03_06_595x287.jpg></p><h3 id=local-registry>Local Registry</h3><p>In order to work offline, we have to use local repository.</p><pre><code># mkdir ~/data
# cd ~/data
# docker run -it --rm --entrypoint cat registry:2 /etc/docker/registry/config.yml &gt; config.yml
# vim config.yml
proxy:
      remoteurl: https://registry-1.docker.io
# mkdir ~/data/data
# docker run -d --restart=always -p 5000:5000 --name docker-registry-proxy-2 -v /root/data/config.yml:/etc/docker/registry/config.yml -v /root/data/data:/var/lib/registry registry:2
</code></pre><p>Now examine the docker registry running:</p><pre><code># docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
0ea38c808e8d        registry:2          &quot;/entrypoint.sh /etcâ€¦&quot;   2 seconds ago       Up 1 second         0.0.0.0:5000-&gt;5000/tcp   docker-registry-proxy-2
</code></pre><h3 id=build-dind>Build dind</h3><p>dind is <code>docker in docker</code>, which is a docker image for running docker
instance inside docker, we build it manually:</p><pre><code># vim
/root/go/src/github.com/play-with-docker/play-with-docker/dockerfiles/dind/daemon.json
    &quot;insecure-registries&quot;: [&quot;https://192.192.189.114:5000&quot;],
# vim
/root/go/src/github.com/play-with-docker/play-with-docker/dockerfiles/dind/Dockerfile
......
    /usr/sbin/sshd -o PermitRootLogin=yes -o PrintMotd=no 2&gt;/dev/null &amp;&amp; \
    dockerd --registry-mirror=http://192.192.189.114:5000 &amp;&gt;/docker.log 
......
</code></pre><p>Build the image:</p><pre><code># docker build -t franela/dind:latest .
# docker images | grep dind
franela/dind        latest              7832d23a42c7        About a minute ago   439MB
docker              stable-dind         d303f49c92a7        2 weeks ago          147MB
</code></pre><p>This dind image could use local registry, so we only need to sync once, then
we could let it running really offlinely.</p><h3 id=local-play-with-docker>Local play-with-docker</h3><p>Change the source code:</p><pre><code># cd /root/go/src/github.com/play-with-docker/play-with-docker
# vim handlers/bootstrap.go +64
- return false
+ return true
# vim config/config.go
 flag.StringVar(&amp;PlaygroundDomain, &quot;playground-domain&quot;, &quot;192.192.189.114&quot;, &quot;Domain to use for the playground&quot;)
</code></pre><p><img src=/images/2018_04_07_15_32_59_766x271.jpg alt=/images/2018_04_07_15_32_59_766x271.jpg></p><p>Make sure your dnsmasq is running, then edit the <code>/etc/dnsmasq.conf</code> via:</p><pre><code>.................
# Add local-only domains here, queries in these domains are answered
# from /etc/hosts or DHCP only.
#local=/localnet/
address=/192.192.189.114/192.192.189.114
address=/localhost/127.0.0.1
.................
</code></pre><p>Run <code>play-with-docker</code>:</p><pre><code># cd /root/go/src/github.com/play-with-docker/play-with-docker
# docker-compose up
</code></pre><p>Then use a browser to access this website:</p><p><img src=/images/2018_04_07_16_08_09_749x759.jpg alt=/images/2018_04_07_16_08_09_749x759.jpg></p><p>Examine the registry now:</p><p><img src=/images/2018_04_07_16_09_00_655x229.jpg alt=/images/2018_04_07_16_09_00_655x229.jpg></p><p>Then in host terminal, examine the downloaded registry cache:</p><pre><code>curl http://192.192.189.114:5000/v2/_catalog
{&quot;repositories&quot;:[&quot;library/alpine&quot;,&quot;library/ubuntu&quot;]}
</code></pre><h3 id=play-with-docker-classroom>play-with-docker classroom</h3><p>Clone the repository:</p><pre><code># cd ~/Code
# git clone https://github.com/play-with-docker/play-with-docker.github.io.git
# cd play-with-docker.github.io/
# vim _config.yml
pwdurl: http://192.192.189.114

# mkdir _site
# groupadd jekyll
# useradd jekyll -m -g jekyll
# chown jekyll:jekyll -R .
# docker-compose up
</code></pre><p>Now open the browser and see the result:</p><p><img src=/images/2018_04_07_16_49_34_794x532.jpg alt=/images/2018_04_07_16_49_34_794x532.jpg></p><h3 id=tips-for-docker-nginx>tips for docker-nginx</h3><pre><code># docker run --name docker-nginx -p 8333:80 -d -v /root/gcr:/usr/share/nginx/html jrelva/nginx-autoindex
root@playwithdocker:/etc/systemd/system# cat mynginx.service 
[Unit]
Description=mynginx
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker start -a docker-nginx
ExecStop=/usr/bin/docker stop -t 2 docker-nginx

[Install]
WantedBy=multi-user.target

</code></pre></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>