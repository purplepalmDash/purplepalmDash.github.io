<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/07/01/linuxtips17/>LinuxTips17</a></h1><span class=post-date>Jul 1, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=1-liquorix-kernelzen>1. liquorix kernel(zen)</h3><p>Install on Ubuntu 22.04 via:</p><pre><code>curl -s 'https://liquorix.net/install-liquorix.sh' | sudo bash
</code></pre><h3 id=2-pikvm-for-x86>2. pikvm for x86</h3><p>Tips(comment the brltty related items and reboot, then ttyUSB0 is avaiable):</p><pre><code>sudo vim /usr/lib/udev/rules.d/85-brltty.rules
# ENV{PRODUCT}==&quot;1a86/7523/*&quot;, ENV{BRLTTY_BRAILLE_DRIVER}=&quot;bm&quot;, GOTO=&quot;brltty_usb_run&quot;
sudo systemctl mask brltty.path
sudo reboot
</code></pre><p>Change to ubuntu22.04 and solved the problem.</p><h3 id=3-socket-5-proxy>3. socket 5 proxy</h3><p>Open the proxy via:</p><pre><code>ssh -N -D 0.0.0.0:10000 dash@localhost
</code></pre><p>Then set the proxy in other machine for yum usage:</p><pre><code>$ vim /etc/yum.conf
#proxy=socks5://10.23.119.200:10000
</code></pre><h3 id=4-ubuntu2204-curl-issue>4. ubuntu22.04 curl issue</h3><p>Problem:</p><pre><code>OpenSSL Error messages: error:0A000126:SSL routines::unexpected eof while reading
</code></pre><p>solved via:</p><pre><code>apt remove curl
apt purge curl
apt-get update
apt-get install -y libssl-dev autoconf libtool make
cd /usr/local/src
wget https://curl.haxx.se/download/curl-7.88.1.zip
unzip curl-7.88.1.zip
cd curl-7.88.1
./buildconf
./configure --with-ssl 
make
sudo make install
sudo cp /usr/local/bin/curl /usr/bin/curl
sudo ldconfig
curl -V
</code></pre><h3 id=5-nix-shell-install>5. nix-shell install</h3><p>install via:</p><pre><code>nix-shell '&lt;home-manager&gt;' -A install --option substituters https://mirrors.ustc.edu.cn/nix-channels/store
</code></pre><h3 id=6-workingtips-for-nix-on-ubuntu>6. Workingtips for nix on ubuntu</h3><p>简单步骤:</p><pre><code>curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
nix-channel --update
nix-shell '&lt;home-manager&gt;' -A install
nix run home-manager/master -- init --switch 
sudo apt install seatd
sudo usermod -a -G video $USER
reboot
nix profile install github:guibou/nixGL --impure
home-manager switch --option substituters https://mirrors.ustc.edu.cn/nix-channels/store
sudo apt-get install -y pipewire pipewire-pulse
</code></pre><p>Also edit the limitation of <code>/etc/security/limits.conf</code>, as following.</p><p>Modification for nix files:</p><pre><code>$ vim ~/.config/home-manager/hyprland.nix
                monitor=,1920x1080@60,auto,1
......
             master {
                 # See https://wiki.hyprland.org/Configuring/Master-Layout/ for more
# new_is_master = true
                 new_status = slave
$ vim ~/.config/home-manager/flake.nix
    #hyprland.url = &quot;github:hyprwm/Hyprland&quot;;
    hyprland.url = &quot;git+https://github.com/hyprwm/Hyprland?submodules=1&quot;;

</code></pre><h3 id=7-limitation-linux>7. limitation linux</h3><p>enlarge via:</p><pre><code> /etc/security/limits.conf, add

* soft nofile 1000001
* hard nofile 1000001
</code></pre><h3 id=8-nix-dconf-issue>8. nix dconf issue</h3><p>problem:</p><pre><code>Activating dconfSettings
dbus[13416]: Failed to start message bus: Configuration file needs one or more &lt;listen&gt; elements giving addresses
dbus-run-session: EOF reading address from bus daemon
</code></pre><p>Solved via:</p><pre><code>not solved, for centos's dbus is pretty old
### 9. pactrap archlinux
Can't Pacstrap because of &quot;Corrupted&quot; packages, solved via:     

</code></pre><p>pacman -Sy archlinux-keyring
sudo pacstrap -c /mnt base</p><pre><code>
### 10. nixos dhcpd issue
encounter following issue:      

</code></pre><pre><code>   Failed assertions:
   - The option definition `services.dhcpd4' in `/nix/store/yq5mkfx3b97iczs5a6lhjm14gkjx9795-source/configuration.nix' no longer has any effect; please remove it.
   The dhcpd4 module has been removed because ISC DHCP reached its end of life.
   See https://www.isc.org/blogs/isc-dhcp-eol/ for details.
   Please switch to a different implementation like kea or dnsmasq.
</code></pre><pre><code>switch to new implementation:     

### 11. sybench rocklinux
Install via:      

</code></pre><p>sudo yum install -y epel-release
sudo yum install ./sysbench&mldr;..</p><pre><code>
### 12. x0vncserver
Using x0vncserver for replacing nxplayer:      

</code></pre><p>$ sudo pacman -S tigervnc
$ vncpasswd
$ vim ~/.xprofile
x0vncserver -rfbauth ~/.vnc/passwd &</p><pre><code>
### 13. git clone via socks proxy
temp using socks proxy via:     

</code></pre><p>git -c &ldquo;http.proxy=socks5h://127.0.0.1:21080&rdquo; clone <a href=https://github.com/Limitex/ComfyUI-Diffusers.git>https://github.com/Limitex/ComfyUI-Diffusers.git</a></p><pre><code>
### 14. ignore ast kernel issue
issue:      

</code></pre><p>W: Possible missing firmware /lib/firmware/ast_dp501_fw.bin for module ast</p><pre><code>Solved via:     

</code></pre><p>touch /lib/firmware/ast_dp501_fw.bin
update-initramfs -u -k all</p><pre><code>
### 15. watch sync status
via:      

</code></pre><p>watch -d grep -e Dirty: -e Writeback: /proc/meminfo</p><pre><code>
### 15. g++ update
via:     

</code></pre><p>2019 sudo apt install -y g++-12
2020 ls -la /usr/bin | grep g++
2021 sudo update-alternatives &ndash;install /usr/bin/g++ g++ /usr/bin/g++-11 10
2022 sudo update-alternatives &ndash;install /usr/bin/g++ g++ /usr/bin/g++-12 20
2023 sudo update-alternatives &ndash;install /usr/bin/c++ c++ /usr/bin/g++ 30</p><pre><code>
### 16. set default opener
Install:     

</code></pre><p>perl-file-mimeinfo
Or
perl538Packages.FileMimeInfo</p><pre><code>Select the default opener for jpeg:     

</code></pre><p>mimeopen -d photo.jpeg</p><pre><code>
### 17. esxi usb nic
`https://avojak.com/blog/2024/01/17/installing-esxi-with-usb-nic/`, 参考。    



### 18. nixos citrix workspace
Download the tar file from citrix:     

</code></pre><p>sudo nixos-rebuild switch &ndash;option substituers <a href=https://mirror.sjtu.edu.cn/nix-channels/store>https://mirror.sjtu.edu.cn/nix-channels/store</a>
nix-prefetch-url file:///home/dash/Downloads/linuxx64-24.5.0.76.tar.gz
sudo nixos-rebuild switch &ndash;option substituers <a href=https://mirror.sjtu.edu.cn/nix-channels/store>https://mirror.sjtu.edu.cn/nix-channels/store</a></p><pre><code>
### 19. Run llama3.1
Steps:       

</code></pre><p>curl -fsSL <a href=https://ollama.com/install.sh>https://ollama.com/install.sh</a> | sh
ollama run llama3.1:8b</p><pre><code>
### 20. offline kubespray issues
Solved via:     

</code></pre><p>tar xzvf ../off.tar.gz
cd kubespray-offline-2.25.0-0/
cd outputs/
./setup-container.sh && ./start-nginx.sh && ./setup-offline.sh && ./setup-py.sh && ./start-registry.sh && ./load-push-all-images.sh && ./extract-kubespray.sh
cd kubespray-2.25.0/
cd inventory/
cp -r sample/ rong
cd rong/
vim inventory.ini
cd ../../
python3.11 -m venv ~/.venv/3.11
source ~/.venv/3.11/bin/activate
pip install -U pip
pip install -r requirements.txt
cp ../../offline.yml inventory/rong/group_vars/all/offline.yml
vim inventory/rong/group_vars/all/offline.yml
cp ~/new/kubespray-offline-2.25.0-0/outputs/playbook/offline-repo.yml .
cp -r ~/new/kubespray-offline-2.25.0-0/outputs/playbook/roles/offline-repo/ roles/
ansible-playbook -i inventory/rong/inventory.ini offline-repo.yml
ansible-playbook -i inventory/rong/inventory.ini &ndash;become &ndash;become-user=root cluster.yml
kubectl get nodes
kubectl get po &ndash;all-namespaces
vim /etc/systemd/resolved.conf
reboot</p><pre><code>
### 21. grep in linux root
via:    

</code></pre><p>grep -rli &ndash;exclude-dir={proc,boot,root,sys} &lsquo;xmlns:qemu=&rsquo; /</p><pre><code>
### 22. one-kvm-docker
via:    

</code></pre><p>docker run -itd -p443:443 -p80:80 &ndash;name pikvm-docker &ndash;device=/dev/ttyUSB0:/dev/kvmd-hid &ndash;device=/dev/video0:/dev/kvmd-video pikvm-ch9329:0.61</p><pre><code>
![/images/20240821_095332_x.jpg](/images/20240821_095332_x.jpg)

should use relative mouse.   

### 23. cowsay issue
issue:    

</code></pre><p>cowsay: Could not find cowfile for &lsquo;default.cow&rsquo;!</p><pre><code>Solved via:   

</code></pre><p>$ vim ~/.zshrc
export ZSH=/home/dash/.oh-my-zsh
COWPATH=/usr/share/cowsay/cows</p><pre><code>recreate the terminal, this time cowsay works properly.   

### 24. flux1-dev-bnb-nf4-v2
Steps:    

</code></pre><p>models:<br>(base) dash@comfyvm:~/Code/ComfyUI/models/checkpoints$ mv ~/flux1-dev-bnb-nf4-v2.safetensors .
(base) dash@comfyvm:~/Code/ComfyUI/models/checkpoints$ pwd
/home/dash/Code/ComfyUI/models/checkpoint</p><p>Custom model:<br>(base) dash@comfyvm:~/Code/ComfyUI/custom_nodes$ mv ~/ComfyUI_bitsandbytes_NF4-master.zip .
(base) dash@comfyvm:~/Code/ComfyUI/custom_nodes$ unzip ComfyUI_bitsandbytes_NF4-master.zip
Archive: ComfyUI_bitsandbytes_NF4-master.zip
6c65152bc48b28fc44cec3aa44035a8eba400eb9
creating: ComfyUI_bitsandbytes_NF4-master/
inflating: ComfyUI_bitsandbytes_NF4-master/LICENSE.txt<br>inflating: ComfyUI_bitsandbytes_NF4-master/README.md<br>inflating: ComfyUI_bitsandbytes_NF4-master/<strong>init</strong>.py<br>extracting: ComfyUI_bitsandbytes_NF4-master/requirements.txt</p><p>$ conda activate comfyui
(comfyui) dash@comfyvm:/opt/src/redsocks$ cd ~/Code/ComfyUI/
(comfyui) dash@comfyvm:~/Code/ComfyUI$ python -s -m pip install -U bitsandbytes</p><pre><code>### 25. hygon win7
libvirt configuration:    

</code></pre><pre><code>&lt;memballoon model='virtio'&gt;
  &lt;address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/&gt;
&lt;/memballoon&gt;
</code></pre><pre><code>  &lt;os&gt;
    &lt;type arch='x86_64' machine='pc-q35-8.2'&gt;hvm&lt;/type&gt;
    &lt;boot dev='hd'/&gt;
  &lt;/os&gt;
</code></pre><p>hardware info:</p><pre><code>root@idv-P860:~# lspci | grep -i vga
06:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Lexa PRO [Radeon 540/540X/550/550X / RX 540X/550/550X] (rev c7)
</code></pre><p>win7, only in bios with Win7_hygon.iso, select q35. and install specified old win7 driver.</p><h3 id=26-archlinux-cn>26. archlinux cn</h3><p>Edit the <code>/etc/pacman.conf</code>:</p><pre><code>[archlinuxcn]
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinuxcn/$arch
</code></pre><p>Then:</p><pre><code>$ sudo pacman -Sy archlinuxcn-keyring
</code></pre><h3 id=27-bootrepair>27. bootrepair</h3><p>via:</p><pre><code>sudo add-apt-repository ppa:yannubuntu/boot-repair &amp;&amp; sudo apt update
sudo apt install -y boot-repair &amp;&amp; boot-repair
</code></pre><h3 id=28-nvidia-t4-qxl>28. nvidia t4 qxl</h3><p>Configuration items:</p><pre><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}
EnableMsHybrid 1
qxl: 
EnableMsHybrid 2
GridLicensedFeatures 7
AdapterType should be removed.
</code></pre><h3 id=29-take-screenshot>29. take screenshot</h3><p>via:</p><pre><code>xfce4-screenshooter  -f --display=:2 -s /tmp/test3_5.jpg
</code></pre><h3 id=30-kernel-lt>30. kernel-lt</h3><p>Install via:</p><pre><code>
[root@cc-shhsh-x86-controller-1 ~]# yum --disablerepo=&quot;*&quot; --enablerepo=&quot;elrepo-kernel&quot; install kernel-lt
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package kernel-lt.x86_64 0:5.4.278-1.el7.elrepo will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

=============================================================================================================================================================================================
 Package                                   Arch                                   Version                                                Repository                                     Size
=============================================================================================================================================================================================
Installing:
 kernel-lt                                 x86_64                                 5.4.278-1.el7.elrepo                                   elrepo-kernel                                  50 M

Transaction Summary
=============================================================================================================================================================================================
Install  1 Package

Total download size: 50 M
Installed size: 230 M
Is this ok [y/d/N]: y
Downloading packages:
kernel-lt-5.4.278-1.el7.elrepo.x86_64.rpm                                                                                                                             |  50 MB  00:00:01     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : kernel-lt-5.4.278-1.el7.elrepo.x86_64                                                                                       
</code></pre><p>Configure via:</p><pre><code>[root@cc-shhsh-x86-controller-1 ~]# ls /boot/vmlinuz-5.4.278-1.el7.elrepo.x86_64 
/boot/vmlinuz-5.4.278-1.el7.elrepo.x86_64
[root@cc-shhsh-x86-controller-1 ~]# grubby --set-default /boot/vmlinuz-5.4.278-1.el7.elrepo.x86_64 
[root@cc-shhsh-x86-controller-1 ~]# grub2-mkconfig -o /boot/efi/EFI/
BOOT/   centos/ 
[root@cc-shhsh-x86-controller-1 ~]# grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-5.4.278-1.el7.elrepo.x86_64
Found initrd image: /boot/initramfs-5.4.278-1.el7.elrepo.x86_64.img
Found linux image: /boot/vmlinuz-4.19.12-7_rc1.zdyun.x86_64
Found initrd image: /boot/initramfs-4.19.12-7_rc1.zdyun.x86_64.img
Found linux image: /boot/vmlinuz-4.19.12-1.ctyun.x86_64
Found initrd image: /boot/initramfs-4.19.12-1.ctyun.x86_64.img
Found linux image: /boot/vmlinuz-3.10.0-957.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-957.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-ad8ef31f6ef940a0b65f1f597ad06c3b
Found initrd image: /boot/initramfs-0-rescue-ad8ef31f6ef940a0b65f1f597ad06c3b.img
done
You have new mail in /var/mail/root/
</code></pre><h3 id=31-lenovo-bios-issue>31. lenovo bios issue</h3><p>Install win7:</p><pre><code>BIOS版本M31K开头的激活代码 AmiSetupWriter.efi 0x802 0x1 （CSM改为允许）
BIOS版本M31K开头的激活代码 AmiSetupWriter.efi 0x802 0x1 （CSM改为允许）
如果M31K开头的BIOS，独显为RTX 16系列和20系列输入以下三条命令
AmiSetupWriter.efi 0x808 0x0 
AmiSetupWriter.efi 0x80b 0x2
AmiSetupWriter.efi 0x80c 0x2
</code></pre><h3 id=32-detectgpu-fixed-code>32. detectgpu fixed code</h3><p>via:</p><pre><code># 1.7 remove pciroot related items
reserveid=`lspci | grep -i vga | awk -F ':' {'print $1'}`
prefixreserveid=&quot;0000:&quot;$reserveid
echo &quot;/^${prefixreserveid}/&quot;'!d' &gt; /tmp/sedcmd.txt
sed -i -f /tmp/sedcmd.txt /tmp/pciid
sed -i -f /tmp/sedcmd.txt /tmp/devicedriver
</code></pre><h3 id=33-pyqt-related>33. pyqt related</h3><pre><code>usermod -a -G kvm,libvirt idv
python3 -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
pip3 install pyqt5==5.15.2 -i https://pypi.tuna.tsinghua.edu.cn/simple
python3 -c &quot;from PyQt5.Qt import PYQT_VERSION_STR; print(PYQT_VERSION_STR)&quot;
</code></pre><h3 id=34-macos-usage>34. macos usage</h3><p>via:</p><pre><code>test@tests-iMac-Pro-2 ~ % sysctl -n hw.ncpu

14
test@tests-iMac-Pro-2 ~ % sysctl hw.memsize | awk '{print $1/1073741824}'

0
test@tests-iMac-Pro-2 ~ % sysctl hw.memsize
hw.memsize: 24775753728
test@tests-iMac-Pro-2 ~ % sysctl hw.memsize | awk '{print $2/1073741824}'

23.0742

</code></pre><h3 id=35-fh-vfio-items>35. fh vfio items</h3><p>Change vfio hooks via:</p><p><code>vfio-startup.sh</code>:</p><pre><code>systemctl stop graphical.target
sleep 3
systemctl stop gdm
sleep 3 
systemctl stop gdm3
sleep 3
killall --user idv
sleep 5
echo 0x1ec8 0x9810 | tee -a /sys/bus/pci/drivers/vfio-pci/new_id 
sleep 2
echo &quot;End of startup!&quot;
</code></pre><p><code>vfio-teardown.sh</code>:</p><pre><code>sleep 3
echo 0x1ec8 0x9810 &gt; /sys/bus/pci/drivers/vfio-pci/remove_id 
sleep 1
echo 1 &gt; /sys/bus/pci/devices/0000\:06\:00.0/remove 
sleep 3
echo 1 &gt; /sys/bus/pci/rescan 
sleep 3
systemctl start gdm

echo &quot;End of teardown!&quot;
</code></pre><h3 id=36-cuttlefish-building>36. cuttlefish building</h3><p>Building deb:</p><pre><code>git clone https://github.com/google/android-cuttlefish
cd android-cuttlefish
tools/buildutils/build_packages.sh 
$ ls *.deb
cuttlefish-base_1.0.0_arm64.deb         cuttlefish-orchestration_1.0.0_arm64.deb
cuttlefish-common_1.0.0_arm64.deb       cuttlefish-user_1.0.0_arm64.deb
cuttlefish-integration_1.0.0_arm64.deb
</code></pre><p>Install deb:</p><pre><code>sudo dpkg -i ./cuttlefish-base_*_*64.deb || sudo apt-get install -f
sudo dpkg -i ./cuttlefish-user_*_*64.deb || sudo apt-get install -f
sudo usermod -aG kvm,cvdnetwork,render $USER
sudo reboot
</code></pre><p>getprop:</p><pre><code>dumpsys SurfaceFlinger | grep GLES
 ------------RE GLES------------
</code></pre><h3 id=37-secure-boot-off>37. secure boot off</h3><p>via:</p><pre><code>&lt;loader readonly='yes' secure='no' type='pflash'&gt;/usr/share/OVMF/OVMF_CODE.fd&lt;/loader&gt;
    &lt;nvram&gt;/var/lib/libvirt/qemu/nvram/centos-4.19-3_VARS.fd&lt;/nvram&gt;
</code></pre><h3 id=38-ubuntuok>38. ubuntuOK</h3><p>via:</p><pre><code>  HOME=$PWD ./bin/launch_cvd  -gpu_mode  drm_virgl  -enable_gpu_udmabuf -cpus 4 -memory_mb  8192

</code></pre><h3 id=39-update-gcc-in-debian-unstable>39. update gcc in debian unstable</h3><p>via:</p><pre><code>sudo apt install -y gcc-12
sudo apt install g++-12
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 20
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 10
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 20
sudo update-alternatives --install /usr/bin/cc cc /usr/bin/gcc 30
sudo update-alternatives --set /usr/bin/gcc
sudo update-alternatives --set cc /usr/bin/gcc
sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++ 30
sudo update-alternatives --set c++ /usr/bin/g++
sudo update-alternatives --config gcc
sudo update-alternatives --config g++
</code></pre><h3 id=40-build-gfxstream-on-ubuntu2204>40. build gfxstream on ubuntu2204</h3><p>problems:</p><pre><code>test@ubuntu2204:~/Code/qemu/build/deps/gfxstream$ meson setup -Ddefault_library=static --prefix &quot;${PREFIX}&quot; build/ 
The Meson build system
Version: 0.61.2
Source dir: /home/test/Code/qemu/build/deps/gfxstream
Build dir: /home/test/Code/qemu/build/deps/gfxstream/build
Build type: native build
Project name: gfxstream
Project version: 0.1.2
C compiler for the host machine: cc (gcc 11.4.0 &quot;cc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0&quot;)
C linker for the host machine: cc ld.bfd 2.38
C++ compiler for the host machine: c++ (gcc 11.4.0 &quot;c++ (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0&quot;)
C++ linker for the host machine: c++ ld.bfd 2.38
Host machine cpu family: x86_64
Host machine cpu: x86_64
Program python3 found: YES (/usr/bin/python3)
WARNING: Python files installed by Meson might not be found by python interpreter.
 This warning can be avoided by setting &quot;python.platlibdir&quot; option.
WARNING: Python files installed by Meson might not be found by python interpreter.
 This warning can be avoided by setting &quot;python.purelibdir&quot; option.
Found pkg-config: /usr/bin/pkg-config (0.29.2)
Run-time dependency aemu_base found: YES 0.1.2
Run-time dependency aemu_host_common found: YES 0.1.2
Run-time dependency aemu_logging found: YES 0.1.2
Run-time dependency aemu_snapshot found: YES 0.1.2
Found CMake: /usr/bin/cmake (3.22.1)
Run-time dependency dl found: NO (tried pkgconfig and cmake)

host/meson.build:78:2: ERROR: Dependency &quot;dl&quot; not found, tried pkgconfig and cmake

</code></pre><h3 id=41-problem-solving-with-policykit>41. problem solving with policykit</h3><p>building issue:</p><pre><code>terminal 1: 
$ echo $??
23783
$ pkttyagent --process 23783
Authentication is needed to run `/usr/bin/python3' as the super user
Authenticating as: test
Password: 
==== AUTHENTICATION COMPLETE ===
==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===
Authentication is needed to run `/usr/bin/python3' as the super user
Authenticating as: test
Password: 
==== AUTHENTICATION COMPLETE ===

</code></pre><h3 id=42-qemu-kvm-ev-installation>42. qemu-kvm-ev installation</h3><p>Steps:</p><pre><code>sudo sed -i.bak   -e 's|^mirrorlist=|#mirrorlist=|g'   -e 's|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.ustc.edu.cn/centos-vault/centos|g'   /etc/yum.repos.d/CentOS-Base.repo
sudo yum update
sudo yum install -y virt-manager
sudo yum install -y centos-release-qemu-ev
sudo vi /etc/yum.repos.d/CentOS-QEMU-EV.repo
...
baseurl=http://mirrors.ustc.edu.cn/centos-vault/centos/$releasever/virt/$basearch/kvm-common/
...
sudo yum makecache
sudo yum install -y qemu-kvm-ev
</code></pre><p>elrepo:</p><pre><code>$ cat /etc/yum.repos.d/elrepo.repo
...
[elrepo-kernel]
name=ELRepo.org Community Enterprise Linux Kernel Repository - el7
#baseurl=http://elrepo.org/linux/kernel/el7/$basearch/
baseurl=https://mirrors.ustc.edu.cn/elrepo/archive/kernel/el7/$basearch/
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org
protect=0
...
$ sudo yum makecache
$ sudo yum install -y kernel-lt kernel-lt-devel kernel-lt-headers 
</code></pre><h3 id=43-elrepo-related-building>43. elrepo related building</h3><p>Create building kernel docker instance:</p><pre><code>$ sudo docker run -it buidrockykernel:latest /bin/bash
[root@6daba91116b7 /]# useradd -m mockbuild
[root@6daba91116b7 /]# su - mockbuild
</code></pre><p>In building container:</p><pre><code>wget https://elrepo.reloumirrors.net/kernel/el9/SRPMS/kernel-lt-6.1.112-1.el9.elrepo.nosrc.rpm
rpm -Uvh kernel-lt-6.1.112-1.el9.elrepo.nosrc.rpm 
cd rpmbuild/
cd SPECS/
vim kernel-lt-6.1.spec 
cd ../SOURCES/
wget https://mirrors.ustc.edu.cn/kernel.org/linux/kernel/v6.x/linux-6.1.112.tar.xz
cd ../SPECS/
time rpmbuild -ba kernel-lt-6.1.spec 
</code></pre><h3 id=44-lxd-to-incus>44. lxd to incus</h3><p>via:</p><pre><code>lxd-to-incus --ignore-version-check
</code></pre><h3 id=45-find-installed-gpus>45. find installed gpus</h3><p>via:</p><pre><code> lspci -nn | grep -i -E 'VGA|Display|3d' | grep -i -v &quot;intel&quot;
</code></pre><h3 id=46-zkfd-related>46. zkfd related</h3><p>remove grub default items:</p><pre><code>cp -r /etc/default/grub.d/ /root
vim *.cfg  # remove all of the unnecessary items
</code></pre><p>remove all of the dkms:</p><pre><code>mv /usr/src /root
mkdir -p /root/varlibdkms
mv /var/lib/dkms/* /root/varlibdkms

/usr/lib/dkms/dkms_autoinstaller start 5.4.0-100-generic
</code></pre><h3 id=47-oneline-dkms>47. oneline dkms</h3><p>via:</p><pre><code>ls /boot/initrd.img-* | cut -d- -f2- | \
    sudo xargs -n1 /usr/lib/dkms/dkms_autoinstaller start
</code></pre><h3 id=48-pve-lxc-download>48. pve lxc download</h3><p>tips:</p><pre><code># pveam update
# pveam available
# pveam download local ubuntu-22.04-standard_22.04-1_amd64.tar.zst
downloading http://download.proxmox.com/images/system/ubuntu-22.04-standard_22.04-1_amd64.tar.zst to /var/lib/vz/template/cache/ubuntu-22.04-standard_22.04-1_amd64.tar.zst
</code></pre><p>template:</p><pre><code>root@pve:/var/lib/vz/template/cache# scp ubuntu-22.04-standard_22.04-1_amd64.tar.zst dash@192.168.1.7:/media/big/

</code></pre><h3 id=49-pure-lxc-related>49. pure lxc related</h3><p>via:</p><pre><code>  188  sudo lxc-create -n ubuntu2204 -t download -- --dist ubuntu --release jammy --arch amd64
</code></pre><h3 id=50-disable-apparmor>50. disable apparmor</h3><p>via:</p><pre><code>root@debianonlyroot:~# cat /proc/cmdline
BOOT_IMAGE=/boot/vmlinuz-6.1.0-25-amd64 root=UUID=d96e2a44-3ce5-4a4a-899a-0e47f1ad3e50 ro quiet ipv6.disable=1 apparmor=0
root@debianonlyroot:~# cat /sys/module/apparmor/parameters/enabled
N
root@debianonlyroot:~# aa-status
apparmor module is loaded.
apparmor filesystem is not mounted.
root@debianonlyroot:~# 
</code></pre><p>disable steps:</p><pre><code>$ sudo mkdir -p /etc/default/grub.d
$ echo 'GRUB_CMDLINE_LINUX_DEFAULT=&quot;$GRUB_CMDLINE_LINUX_DEFAULT apparmor=0&quot;' \
  | sudo tee /etc/default/grub.d/apparmor.cfg
$ sudo update-grub
$ sudo reboot
</code></pre><h3 id=51-fedora-arm64-group>51. fedora arm64 group</h3><p>steps:</p><pre><code>lvextend -l +100%FREE /dev/mapper/fedora-root
xfs_growfs /dev/fedora/root 
</code></pre><h3 id=52-view-sync-status>52. view sync status</h3><p>via:</p><pre><code>watch -d grep -e Dirty: -e Writeback: /proc/meminfo

</code></pre><p><img src=/images/20241024_181125_x.jpg alt=/images/20241024_181125_x.jpg></p><h3 id=53-installation-issueubuntu1604>53. Installation issue(ubuntu16.04)</h3><p>Change the virtio to scsci disk, for arm64 installation.</p><h3 id=54-lxc-startup-issue>54. lxc startup issue</h3><p>problem:</p><pre><code>Failed to mount cgroup at /sys/fs/cgroup/systemd: Operation not permitted

</code></pre><p>solved via:</p><pre><code>Added cgroup parameter to boot cmdline:     
systemd.unified_cgroup_hierarchy=0
update-grub2 &amp;&amp; reboot
</code></pre><h3 id=55-kylin-lightdm>55. kylin lightdm</h3><p>configuration via:</p><pre><code># cat /etc/lightdm/lightdm.conf
[LightDM]
minimum-vt=8
[SeatDefaults]
autologin-guest=false
autologin-user=test
autologin-user-timeout=0
</code></pre><h3 id=56-ubuntu-startup>56. ubuntu startup</h3><p>solved via:</p><pre><code>test@server:~$ cat /etc/systemd/system/network-online.target.wants/systemd-networkd-wait-online.service
[Service]
Type=oneshot
ExecStart=/usr/lib/systemd/systemd-networkd-wait-online
RemainAfterExit=yes
TimeoutStartSec=2sec

[Install]
WantedBy=network-online.target
=======
</code></pre><h3 id=57-lxc-sound-issue>57. lxc sound issue</h3><p>solved via:</p><pre><code>/usr/bin/pactl load-module module-alsa-card device_id=1 ; /usr/bin/pactl load-module module-alsa-card device_id=0

</code></pre><h3 id=58-fedora-autoload-kernel-module>58. fedora autoload kernel module</h3><p>via:</p><pre><code># vim /etc/modules-load.d/vfio.conf
vfio-pci
vfio_iommu_type1
vfio_pci
# systemctl status systemd-modules-load.service
</code></pre><h3 id=59-git-diff>59. git diff</h3><p>steps:</p><pre><code>1. get the source code
git init
git add .
git commit -m 'initial'
git tag -a initial HEAD -m &quot;initial&quot;
2. make changes
git add 
git commit -m 'second'
git tag -a second HEAD -m &quot;second&quot;
3. show tags
git tag
4. make diffs
git diff -p tag1 tag2 &gt; my.patch
</code></pre><h3 id=60-ltsp-on-zkfd>60. ltsp on zkfd</h3><p>solved via:</p><pre><code>  105  mount --bind / /mnt
  106  ls /mnt
  107  cp -a /boot/. /mnt/boot/
  108  umount /mnt
  109  ltsp image /
</code></pre><h3 id=61-force-overwrite>61. force overwrite</h3><p>apt when conflicts:</p><pre><code>-o Dpkg::Options::=&quot;--force-overwrite&quot; 
</code></pre><h3 id=62-dkms-issue>62. dkms issue</h3><p>solved via:</p><pre><code>$ sudo vim /etc/kernel/postinst.d/dkms
# We're passed the version of the kernel being installed
inst_kern=$1

+if [ &quot;$1&quot; = &quot;5.4.xxxxxx&quot; ]; then
uname_s=$(uname -s)

......

    echo &quot;      please install the $header_pkg package to fix this.&quot; &gt;&amp;2
fi
+else
+	echo &quot;fucku&quot;
+	exit
+fi
</code></pre><h3 id=63-drblpush-push>63. drblpush push</h3><p>solved via:</p><pre><code>apt remove thunderbird --purge &amp;&amp; drblpush -c /etc/drbl/drblpush.conf
</code></pre><h3 id=64-virsh-attach-device>64. virsh attach device</h3><p>via:</p><pre><code>root@zkfd:/home/test# virsh attach-device win10 --file usb.xml --current
成功附加设备

root@zkfd:/home/test# cat usb.xml 
  &lt;hostdev mode='subsystem' type='usb' managed='yes'&gt;
      &lt;source&gt;
        &lt;vendor id='0x30fa'/&gt;
        &lt;product id='0x0300'/&gt;
      &lt;/source&gt;
    &lt;/hostdev&gt;
</code></pre><h3 id=65-pip-config-edit>65. pip config edit</h3><p>solved via:</p><pre><code>$ export EDITOR=vim
$ pip config edit
$ pip config list
global.index-url='https://pypi.mirrors.ustc.edu.cn/simple'
</code></pre><h3 id=66-ps-show-full-user>66. ps show full user</h3><p>via:</p><pre><code>ps axo user:20,pid,pcpu,pmem,vsz,rss,tty,stat,start,time,comm
</code></pre><h3 id=66-git-issue>66. git issue</h3><p>issue:</p><pre><code>$ git remote show origin                                                         130
ssh: connect to host github.com port 22: Connection timed out
致命错误：无法读取远程仓库。

请确认您有正确的访问权限并且仓库存在。
dash@archnvme:~/Code/blogsource (master) $ GIT_CURL_VERBOSE=1 GIT_TRACE=1 git remote show origin                          128
22:39:00.704332 git.c:479               trace: built-in: git remote show origin
22:39:00.704481 run-command.c:666       trace: run_command: unset GIT_PREFIX; GIT_PROTOCOL=version=2 ssh -o SendEnv=GIT_PROTOCOL git@github.com 'git-upload-pack '\''purplepalmdash/blogsource.git'\'''
22:39:00.704506 run-command.c:758       trace: start_command: /sbin/ssh -o SendEnv=GIT_PROTOCOL git@github.com 'git-upload-pack '\''purplepalmdash/blogsource.git'\'''
^C

</code></pre><p>solved via:</p><pre><code>vim ~/.ssh/config

Host github.com
 Hostname ssh.github.com
 Port 443
</code></pre><h3 id=67-waybar-issue>67. waybar issue</h3><p>some functionality not working under hyprland, solved via:</p><pre><code>pkill waybar &amp;&amp; hyprctl dispatch exec waybar
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/06/26/installingnixos/>InstallingNixOS</a></h1><span class=post-date>Jun 26, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=steps>steps</h3><p>Enable sshd:</p><pre><code>$ passwd 
Change the password
$ ssh nixos@xxx.xxx.xx.xx
......
</code></pre><p>Change channel:</p><pre><code>$ sudo -i
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixpkgs-unstable nixpkgs
nix-channel --add https://mirrors.ustc.edu.cn/nix-channels/nixos-24.05 nixos
nix-channel --list
nix-channel --update
nixos-rebuild --option substituters https://mirrors.ustc.edu.cn/nix-channels/store switch --upgrade 
</code></pre><p>parted:</p><pre><code>parted /dev/sda  # 分区该设备
mklabel gpt  # 创建 GPT 表
mkpart ESP fat32 1MiB 256MiB  # 在 1 MiB - 256 MiB 的位置创建引导分区
p  # 打印当前分区表
set 1 esp on  # 将序号为 1 的分区标识为可启动
mkpart primary 256MiB -2GiB
unit s
mkpart primary linux-swap 996022272 100%
p

</code></pre><p>lsblk:</p><pre><code>nvme0n1     259:0    0 476.9G  0 disk 
├─nvme0n1p1 259:4    0   255M  0 part 
├─nvme0n1p2 259:5    0 474.7G  0 part 
└─nvme0n1p3 259:6    0     2G  0 part
</code></pre><p>make filesystem:</p><pre><code>mkfs.fat -F32 /dev/nvme0n1p1 
mkfs.btrfs -L nixos /dev/nvme0n1p2 
mkswap -L swap /dev/nvme0n1p3 
</code></pre><p>mount sub volumes:</p><pre><code>mount /dev/nvme0n1p2 /mnt
btrfs subvolume create /mnt/root 
btrfs subvolume create /mnt/home
btrfs subvolume create /mnt/nix 
umount /mnt 
mount -o compress=zstd,subvol=root /dev/nvme0n1p2 /mnt
mkdir /mnt/{home,nix,boot}
mount -o compress=zstd,subvol=home /dev/nvme0n1p2 /mnt/home/
mount -o compress=zstd,noatime,subvol=nix  /dev/nvme0n1p2  /mnt/nix
mount /dev/nvme0n1p1 /mnt/boot
swapon /dev/nvme0n1p3
</code></pre><pre><code># nixos-generate-config --root /mnt
# cat  /mnt/etc/nixos/hardware-configuration.nix
# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + &quot;/installer/scan/not-detected.nix&quot;)
    ];

  boot.initrd.availableKernelModules = [ &quot;xhci_pci&quot; &quot;ahci&quot; &quot;nvme&quot; &quot;usbhid&quot; &quot;usb_storage&quot; &quot;sd_mod&quot; &quot;sr_mod&quot; &quot;sdhci_pci&quot; ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ &quot;kvm-intel&quot; ];
  boot.extraModulePackages = [ ];

  fileSystems.&quot;/&quot; =
    { device = &quot;/dev/disk/by-uuid/aeb74833-b6fc-444f-bdc0-3ab931e7356a&quot;;
      fsType = &quot;btrfs&quot;;
      options = [ &quot;subvol=root&quot; &quot;compress=zstd&quot; ];
    };

  fileSystems.&quot;/home&quot; =
    { device = &quot;/dev/disk/by-uuid/aeb74833-b6fc-444f-bdc0-3ab931e7356a&quot;;
      fsType = &quot;btrfs&quot;;
      options = [ &quot;subvol=home&quot; &quot;compress=zstd&quot;];
    };

  fileSystems.&quot;/nix&quot; =
    { device = &quot;/dev/disk/by-uuid/aeb74833-b6fc-444f-bdc0-3ab931e7356a&quot;;
      fsType = &quot;btrfs&quot;;
      options = [ &quot;subvol=nix&quot; &quot;compress=zstd&quot; &quot;noatime&quot;];
    };

  fileSystems.&quot;/boot&quot; =
    { device = &quot;/dev/disk/by-uuid/2D3A-7086&quot;;
      fsType = &quot;vfat&quot;;
      options = [ &quot;fmask=0022&quot; &quot;dmask=0022&quot; ];
    };

  swapDevices =
    [ { device = &quot;/dev/disk/by-uuid/745d2fd3-c12b-4d15-a242-9283cac98c5d&quot;; }
    ];

  # Enables DHCP on each ethernet and wireless interface. In case of scripted networking
  # (the default) this is the recommended approach. When using systemd-networkd it's
  # still possible to use this option, but it's recommended to use it in conjunction
  # with explicit per-interface declarations with `networking.interfaces.&lt;interface&gt;.useDHCP`.
  networking.useDHCP = lib.mkDefault true;
  # networking.interfaces.enp2s0.useDHCP = lib.mkDefault true;
  # networking.interfaces.wlp3s0.useDHCP = lib.mkDefault true;

  nixpkgs.hostPlatform = lib.mkDefault &quot;x86_64-linux&quot;;
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

[root@nixos:~]# cat /mnt/etc/nixos/configuration.nix
# Edit this configuration file to define what should be installed on
# your system. Help is available in the configuration.nix(5) man page, on
# https://search.nixos.org/options and in the NixOS manual (`nixos-help`).

{ config, lib, pkgs, ... }:

{
  imports =
    [ # Include the results of the hardware scan.
      ./hardware-configuration.nix
    ];

  # Use the systemd-boot EFI boot loader.
  boot.loader.systemd-boot.enable = true;
  boot.loader.efi.canTouchEfiVariables = true;

  networking.hostName = &quot;nixos&quot;; # Define your hostname.
  # Pick only one of the below networking options.
  # networking.wireless.enable = true;  # Enables wireless support via wpa_supplicant.
  networking.networkmanager.enable = true;  # Easiest to use and most distros use this by default.

  # Set your time zone.
  # time.timeZone = &quot;Europe/Amsterdam&quot;;
  time.timeZone = &quot;Asia/Shanghai&quot;;

  # Configure network proxy if necessary
  # networking.proxy.default = &quot;http://user:password@proxy:port/&quot;;
  # networking.proxy.noProxy = &quot;127.0.0.1,localhost,internal.domain&quot;;

  # Select internationalisation properties.
  # i18n.defaultLocale = &quot;en_US.UTF-8&quot;;
  i18n.defaultLocale = &quot;en_US.UTF-8&quot;;
  # console = {
  #   font = &quot;Lat2-Terminus16&quot;;
  #   keyMap = &quot;us&quot;;
  #   useXkbConfig = true; # use xkb.options in tty.
  # };

  # Enable the X11 windowing system.
  services.xserver.enable = true;
  services.xserver.displayManager.sddm.enable = true;
  services.xserver.desktopManager.plasma5.enable = true;


  

  # Configure keymap in X11
  # services.xserver.xkb.layout = &quot;us&quot;;
  # services.xserver.xkb.options = &quot;eurosign:e,caps:escape&quot;;

  # Enable CUPS to print documents.
  # services.printing.enable = true;

  # Enable sound.
  hardware.pulseaudio.enable = true;
  # OR
  # services.pipewire = {
  #   enable = true;
  #   pulse.enable = true;
  # };

  # Enable touchpad support (enabled default in most desktopManager).
  # services.libinput.enable = true;

  # Define a user account. Don't forget to set a password with ‘passwd’.
  # users.users.alice = {
  #   isNormalUser = true;
  #   extraGroups = [ &quot;wheel&quot; ]; # Enable ‘sudo’ for the user.
  #   packages = with pkgs; [
  #     firefox
  #     tree
  #   ];
  # };

  # List packages installed in system profile. To search, run:
  # $ nix search wget
  environment.systemPackages = with pkgs; [
     vim # Do not forget to add an editor to edit configuration.nix! The Nano editor is also installed by default.
     wget
     alacritty
   ];

  sound.enable = true;
  #hardware.pulseaudio.enable = true;


  # Some programs need SUID wrappers, can be configured further or are
  # started in user sessions.
  # programs.mtr.enable = true;
  # programs.gnupg.agent = {
  #   enable = true;
  #   enableSSHSupport = true;
  # };

  # List services that you want to enable:

  # Enable the OpenSSH daemon.
  # services.openssh.enable = true;

  # Open ports in the firewall.
  # networking.firewall.allowedTCPPorts = [ ... ];
  # networking.firewall.allowedUDPPorts = [ ... ];
  # Or disable the firewall altogether.
  # networking.firewall.enable = false;

  # Copy the NixOS configuration file and link it from the resulting system
  # (/run/current-system/configuration.nix). This is useful in case you
  # accidentally delete configuration.nix.
  # system.copySystemConfiguration = true;

  # This option defines the first version of NixOS you have installed on this particular machine,
  # and is used to maintain compatibility with application data (e.g. databases) created on older NixOS versions.
  #
  # Most users should NEVER change this value after the initial install, for any reason,
  # even if you've upgraded your system to a new NixOS release.
  #
  # This value does NOT affect the Nixpkgs version your packages and OS are pulled from,
  # so changing it will NOT upgrade your system - see https://nixos.org/manual/nixos/stable/#sec-upgrading for how
  # to actually do that.
  #
  # This value being lower than the current NixOS release does NOT mean your system is
  # out of date, out of support, or vulnerable.
  #
  # Do NOT change this value unless you have manually inspected all the changes it would make to your configuration,
  # and migrated your data accordingly.
  #
  # For more information, see `man configuration.nix` or https://nixos.org/manual/nixos/stable/options#opt-system.stateVersion .

  nix.settings.substituters = [ 
    &quot;https://mirrors.cernet.edu.cn/nix-channels/store&quot;
  ];
  system.stateVersion = &quot;24.11&quot;; # Did you read the comment?

}
# nixos-install --option substituters https://mirrors.ustc.edu.cn/nix-channels/store


</code></pre><p>Re-Create the password:</p><pre><code>nixos-enter  # 进入部署好的系统，类似 arch 的 chroot
passwd root  # 重置 root 密码
useradd -m -G wheel dash  # 添加普通用户，并加入 wheel 组
passwd dash  # 设置普通账户密码
</code></pre><p>Install awesome:</p><pre><code>nix-env -qaP awesome
sudo nix-env -iA nixpkgs.awesome
</code></pre><p>Not the right way, the right way should be:</p><pre><code>$ sudo vim /etc/nixos/configuration.nix
  services.xserver = {
    enable = true;

  
    displayManager = {
        sddm.enable = true;
        defaultSession = &quot;none+awesome&quot;;
    };

    windowManager.awesome = {
      enable = true;
      luaModules = with pkgs.luaPackages; [
        luarocks # is the package manager for Lua modules
        luadbi-mysql # Database abstraction layer
      ];

    };
  };



sudo nixos-rebuild switch --option substituters https://mirrors.ustc.edu.cn/nix-channels/store
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/06/05/installcryptedgentoo/>InstallCryptedGentoo</a></h1><span class=post-date>Jun 5, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Partition:</p><pre><code>livecd ~ # lsblk
NAME  MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0   7:0    0 479.7M  1 loop /mnt/livecd
sr0    11:0    1 527.4M  0 rom  /mnt/cdrom
vda   252:0    0    80G  0 disk 
zram0 253:0    0     0B  0 disk 
livecd ~ # parted /dev/vda
GNU Parted 3.6
Using /dev/vda
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel gpt
(parted) unit MiB                                                         
(parted) mkpart primary 2 514
(parted) mkpart primary 515 -1                                            
(parted) name 1 boot                                                      
(parted) name 2 luks                                                      
(parted) set 1 boot on                                                    
(parted) q                                                                
Information: You may need to update /etc/fstab.
</code></pre><p>Setup crypts:</p><pre><code>livecd ~ # cryptsetup luksFormat  /dev/vda2

WARNING!
========
This will overwrite data on /dev/vda2 irrevocably.

Are you sure? (Type 'yes' in capital letters): YES
Enter passphrase for /dev/vda2: 
Verify passphrase: 
livecd ~ # cryptsetup open /dev/vda2 ct0
Enter passphrase for /dev/vda2: 
</code></pre><p>Mount to specified position:</p><pre><code>mkfs.btrfs /dev/mapper/ct0
mkfs.vfat -F32 /dev/vda1
mount /dev/mapper/ct0 /mnt/gentoo
</code></pre><p>Using btrfs&rsquo;s subvolume function:</p><pre><code>btrfs subvolume create /mnt/gentoo/subvol-root
btrfs subvolume create /mnt/gentoo/subvol-home
btrfs subvolume create /mnt/gentoo/subvol-snapshots
btrfs subvolume set-default /mnt/gentoo/subvol-root
umount /mnt/gentoo
mount /dev/mapper/ct0 /mnt/gentoo
</code></pre><p>prepare chroot:</p><pre><code>cd /mnt/gentoo
wget ......stage3
tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
</code></pre><p>specify jobs for building:</p><pre><code># nano /etc/portage/make.conf
MAKEOPTS=&quot;-j17&quot;
</code></pre><p>select mirror:</p><pre><code>mirrorselect -i -o &gt;&gt;/mnt/gentoo/etc/portage/make.conf
</code></pre><p>Setup ebuild repository sync address:</p><pre><code># mkdir etc/portage/repos.conf
# cp usr/share/portage/config/repos.conf etc/portage/repos.conf/gentoo.conf
# cat etc/portage/repos.conf/gentoo.conf | grep uri
sync-uri = rsync://rsync.mirrors.ustc.edu.cn/gentoo-portage
cp -L /etc/resolv.conf etc/
</code></pre><p>chroot-in:</p><pre><code>livecd /mnt/gentoo # mount --types proc /proc /mnt/gentoo/proc
livecd /mnt/gentoo # mount --rbind /sys /mnt/gentoo/sys
livecd /mnt/gentoo # mount --rbind /dev /mnt/gentoo/dev
####  then
chroot /mnt/gentoo
. /etc/profile
PS1=(chroot)$PS1
</code></pre><p>Mount vda1 for kernel/bootloader installation:</p><pre><code>mount /dev/vda1 /boot
</code></pre><p>Install gentoo ebuild repository:</p><pre><code>emerge-webrsync
emerge --sync 
</code></pre><p>Install and set editor:</p><pre><code>emerge -vj app-editors/vim
eselect editor set 2
. /etc/profile
PS1=(chroot)$PS1
</code></pre><p>update @world:</p><pre><code>eselect profile set 21
USE=&quot;X initramfs cjk cups crypt udev alsa elogind zsh-completion bash-completion -consolekit&quot;
emerge --ask --verbose --update --deep --changed-use @world
</code></pre><p>Select the locale and timezone:</p><pre><code>echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone
emerge --config sys-libs/timezone-data
vim /etc/locale.gen
locale-gen 
eselect locale set 6
env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) $PS1&quot;
</code></pre><p>Install firmware:</p><pre><code>mkdir -p /etc/portage/package.license
echo 'sys-kernel/linux-firmware linux-fw-redistributable no-source-code' &gt;/etc/portage/package.license/linux-firmware
echo 'sys-kernel/installkernel dracut' &gt;/etc/portage/package.use/installkernel
emerge --ask sys-kernel/gentoo-sources
emerge --ask sys-kernel/linux-firmware
emerge --ask sys-apps/pciutils
emerge --ask sys-kernel/genkernel
</code></pre><p>Set kernel:</p><pre><code>(chroot) livecd / # readlink -v /usr/src/linux
readlink: /usr/src/linux: No such file or directory
(chroot) livecd / # eselect kernel list
Available kernel symlink targets:
  [1]   linux-6.6.30-gentoo
(chroot) livecd / # eselect kernel set 1
(chroot) livecd / # readlink -v /usr/src/linux
linux-6.6.30-gentoo
</code></pre><p>Build kernel:</p><pre><code>cd /usr/src/linux
 make menuconfig
 make -j17
 make modules_install &amp;&amp; make install
 genkernel --kernel-config=/usr/src/linux/.config initramfs
 blkid /dev/vda1&gt;&gt;/etc/fstab
 blkid /dev/mapper/ct0&gt;&gt;/etc/fstab
 vim /etc/fstab 
#/dev/vda1: UUID=&quot;3D3E-221D&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;vfat&quot; PARTLABEL=&quot;boot&quot; PARTUUID=&quot;e0e7d44b-d78f-4c27-808a-c859ce8ead64&quot;
UUID=&quot;3D3E-221D&quot;	/boot     vfat    rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro 0 2
#/dev/mapper/ct0: UUID=&quot;5f574106-322e-4f9f-8efd-c3615fcb237a&quot; UUID_SUB=&quot;0e96210f-49ac-4355-9237-dab1fb6eae93&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;btrfs&quot;
# rw,relatime,space_cache=v2,subvolid=256,subvol=/subvol-root
UUID=&quot;5f574106-322e-4f9f-8efd-c3615fcb237a&quot;	/         btrfs   defaults,noatime,ssd,discard,subvolid=256,subvol=/subvol_root 0 1

</code></pre><p>Install system packages:</p><pre><code>   66  emerge --ask sys-fs/cryptsetup
   67  emerge --ask sys-process/cronie
   68  emerge --ask app-admin/sysklogd
   69  emerge --ask sysfs/btrfs-progs
   70  emerge --ask sys-fs/btrfs-progs
   71  emerge --ask net-misc/dhcpcd
   72  emerge -av app-admin/sysklogd sys-fs/cryptsetup
   73  rc-update add sysklogd default
   74  rc-update add dhcpcd default
   76  echo GRUB_PLATFORMS=&quot;efi-64&quot; &gt;&gt; /etc/portage/make.conf
   77  emerge -av sys-boot/grub:2
   79  mkdir /boot/efi/
   80  ls /dev/disk/by-uuid/
   81  ls /dev/disk/by-uuid/ -l -h
   82  cat /etc/fstab 
   83  vim /etc/default/grub 
   84  vim /etc/default/grub 
   85  mount -a
   86  grub-install --target=x86_64-efi --boot-directory=/boot --efi-directory=/boot/efi/ --bootloader-id=Gentoo --debug
   87  grub-mkconfig -o /boot/grub/grub.cfg
   89  ls /boot/grub/
   90  ls /boot/grub/grub.cfg 
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/06/04/buildinggrub2undereuler/>Buildinggrub2undereuler</a></h1><span class=post-date>Jun 4, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Using repo:</p><pre><code>[root@localhost yum.repos.d]#  cat openEuler_x86_64.repo 
#Copyright (c) [2019] Huawei Technologies Co., Ltd.
#generic-repos is licensed under the Mulan PSL v1.
#You can use this software according to the terms and conditions of the Mulan PSL v1.
#You may obtain a copy of Mulan PSL v1 at:
#    http://license.coscl.org.cn/MulanPSL
#THIS SOFTWARE IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR
#IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR
#PURPOSE.
#See the Mulan PSL v1 for more details.
[openEuler-everything]
name=openEuler-everything
baseurl=http://repo.huaweicloud.com/openeuler/openEuler-20.03-LTS/everything/x86_64/
enabled=1
gpgcheck=0
gpgkey=http://repo.huaweicloud.com/openeuler/openEuler-20.03-LTS/everything/x86_64/RPM-GPG-KEY-openEuler

[openEuler-EPOL]
name=openEuler-epol
baseurl=http://repo.huaweicloud.com/openeuler/openEuler-20.03-LTS/EPOL/x86_64/
enabled=1
gpgcheck=0

[openEuler-update]
name=openEuler-update
baseurl=http://repo.huaweicloud.com/openeuler/openEuler-20.03-LTS/update/x86_64/
enabled=1
gpgcheck=0
[root@localhost yum.repos.d]# pwd
/etc/yum.repos.d
# yum makecache
</code></pre><p>Install package:</p><pre><code>yum install -y elfutils-libelf-devel gcc gnu-efi gnu-efi-devel openssl-devel make git rpm-build
yum install -y rpmdevtools* tree
 rpmdev-setuptree
[root@localhost ~]# ls
anaconda-ks.cfg  rpmbuild
cd ~/rpmbuild/SOURCES
wget http://ftp.gnu.org/gnu/hello/hello-2.10.tar.gz
cd ~/rpmbuild/SPECS
vim hello.spec
</code></pre><p>content is:</p><pre><code>Name:     hello
Version:  2.10
Release:  1%{?dist}
Summary:  The &quot;Hello World&quot; program from GNU
Summary(zh_CN): GNU Hello World program
License:  GPLv3+
URL:      http://ftp.gnu.org/gnu/hello
Source0:  http://ftp.gnu.org/gnu/hello/%{name}-%{version}.tar.gz

BuildRequires:  gettext
Requires(post): info
Requires(preun): info

%description
The &quot;Hello World&quot; program, done with all bells and whistles of a proper FOSS
project, including configuration, build, internationalization, help files, etc.

%description -l zh_CN
The Hello World program contains all parts required by the FOSS project, including configuration, build, i18n, and help files.

%prep
%setup -q

%build
%configure
make %{?_smp_mflags}

%install
make install DESTDIR=%{buildroot}
%find_lang %{name}
rm -f %{buildroot}/%{_infodir}/dir

%post
/sbin/install-info %{_infodir}/%{name}.info %{_infodir}/dir || :

%preun
if [ $1 = 0 ] ; then
/sbin/install-info --delete %{_infodir}/%{name}.info %{_infodir}/dir || :
fi

%files -f %{name}.lang
%doc AUTHORS ChangeLog NEWS README THANKS TODO
%license COPYING
%{_mandir}/man1/hello.1.*
%{_infodir}/hello.info.*
%{_bindir}/hello

%changelog
* Thu Dec 26 2019 Your Name &lt;youremail@xxx.xxx&gt; - 2.10-1
- Update to 2.10
* Sat Dec 3 2016 Your Name &lt;youremail@xxx.xxx&gt; - 2.9-1
- Update to 2.9
</code></pre><p>Building:</p><pre><code>rpmbuild -ba hello.spec 
# tree ~/rpmbuild/*RPMS
/root/rpmbuild/RPMS
└── x86_64
    ├── hello-2.10-1.x86_64.rpm
    ├── hello-debuginfo-2.10-1.x86_64.rpm
    └── hello-debugsource-2.10-1.x86_64.rpm
/root/rpmbuild/SRPMS
└── hello-2.10-1.src.rpm

</code></pre><p>Download the source code and install:</p><pre><code>rpm -ivh grub2-2.02-73.oe1.src.rpm 
cd rpmbuild/SPECS/
yum install -y  bison bzip2-devel dejavu-sans-fonts device-mapper-devel flex freetype-devel gettext-devel help2man libusb-devel ncurses-devel pesign rpm-devel texinfo xz-devel
$ vim /xxx/xx/grub.macros
%{4}./grub-mkimage -O %{1} -o %{2}.orig                         \\\
        -p /EFI/%{efi_vendor} -d grub-core ${GRUB_MODULES}      \
%{4}./grub-mkimage -O %{1} -o %{3}.orig                         \\\
        -p /EFI/BOOT -d grub-core ${GRUB_MODULES}
</code></pre><p>Change <code>.orig</code> to ``, so you could mkimage, and also remove the latter lines which use <code>pesign</code></p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2024/06/03/ongentooinstallation/>OnGentooInstallation</a></h1><span class=post-date>Jun 3, 2024<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=1-preparation>1. Preparation</h3><p>Start sshd:</p><pre><code>/etc/init.d/sshd start
passwd root
</code></pre><p>Remove the lvm via:</p><pre><code># dmsetup ls
# dmsetup remove xxxxxx
</code></pre><p>lsblk:</p><pre><code># lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0         7:0    0 479.7M  1 loop /mnt/livecd
sda           8:0    0   1.8T  0 disk 
sr0          11:0    1  1024M  0 rom  
sr1          11:1    1 527.4M  0 rom  /mnt/cdrom
zram0       253:0    0     0B  0 disk 
nvme0n1     259:0    0 476.9G  0 disk 
├─nvme0n1p1 259:1    0   512M  0 part 
├─nvme0n1p2 259:2    0     1G  0 part 
└─nvme0n1p3 259:3    0 475.4G  0 part 
</code></pre><p>Partition:</p><pre><code>livecd ~ # mkfs.vfat -F32 /dev/nvme0n1p1
mkfs.fat 4.2 (2021-01-31)
livecd ~ # mkswap /dev/nvme0n1p2
Setting up swapspace version 1, size = 1024 MiB (1073737728 bytes)
no label, UUID=5d36c31a-6fbf-4d04-84ac-9ee1efaf5712
livecd ~ # mkfs.ext4 /dev/nvme0n1p3
livecd ~ # swapon /dev/nvme0n1p2 
livecd ~ # mount /dev/nvme0n1p3 /mnt/gentoo
</code></pre><p>Get the stage3 file and untar it:</p><pre><code>wget https://mirrors.ustc.edu.cn/gentoo/releases/amd64/autobuilds/20240602T164858Z/stage3-amd64-desktop-openrc-20240602T164858Z.tar.xz
tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner
</code></pre><p>enable makeopts:</p><pre><code># nano /etc/portage/make.conf
......
MAKEOPTS=&quot;-j20&quot;
......
</code></pre><p>Select mirror:</p><pre><code>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/portage/make.conf
... select ustc.edu.cn
</code></pre><p>Copy the Portage repository settings:</p><pre><code>livecd /mnt/gentoo # mkdir -p /mnt/gentoo/etc/portage/repos.conf
livecd /mnt/gentoo # cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</code></pre><p>Copy the dns:</p><pre><code>cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
</code></pre><p>Chroot to system:</p><pre><code>mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev
mount --bind /run /mnt/gentoo/run
mount --make-slave /mnt/gentoo/run
chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1=&quot;(chroot) ${PS1}&quot;
</code></pre><p>Mount EFI partition:</p><pre><code>livecd / # mount /dev/nvme0n1p1 /boot
</code></pre><p>Update Gentoo&rsquo;s ebuild :</p><pre><code>emerge-webrsync
</code></pre><p>Update using portage:</p><pre><code>emerge --ask --verbose --update --deep --newuse @world
</code></pre><p>Update to <code>Asia/Shanghai</code>:</p><pre><code>livecd / # echo &quot;Asia/Shanghai&quot;&gt;/etc/timezone
livecd / # emerge --config sys-libs/timezone-data
</code></pre><p>Edit the locale.gen:</p><pre><code># nano /etc/locale.gen
en_US.UTF-8 UTF-8
# locale-gen
</code></pre><p>Reload the setting:</p><pre><code>env-update
source /etc/profile
export PS1=&quot;(chroot) ${PS1}&quot;
</code></pre><h3 id=2-kernel>2. Kernel</h3><p>Edit cpu flags:</p><pre><code>#  emerge --ask app-portage/cpuid2cpuflags
#  cpuid2cpuflags
CPU_FLAGS_X86: aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4_1 sse4_2 ssse3
# nano /etc/portage/make.conf
CPU_FLAGS_X86=&quot;aes avx avx2 f16c fma3 mmx mmxext pclmul popcnt rdrand sse sse2 sse3 sse4_1 sse4_2 ssse3&quot;
</code></pre><p>Edit <code>/etc/portage/make.conf</code>, accept all of the license tips:</p><pre><code>ACCEPT_LICENSE=&quot;*&quot;
</code></pre><p>Install firmware and intel microcode:</p><pre><code>emerge --ask sys-kernel/linux-firmware  sys-firmware/intel-microcode
</code></pre><p>Change default editor from nano to vim:</p><pre><code>emerge -vj app-editors/vim
eselect editor list
eselect editor set 2
. /etc/profile
PS1=(chroot)$PS1
</code></pre><p>Install firmware/kernel/bootloader:</p><pre><code>mkdir -p /etc/portage/package.license
echo 'sys-kernel/linux-firmware linux-fw-redistributable no-source-code' &gt;/etc/portage/package.license/linux-firmware
# also install initramfs
echo 'sys-kernel/installkernel dracut' &gt;/etc/portage/package.use/installkernel
emerge -vj linux-firmware gentoo-kernel-bin grub
</code></pre><p>Edit <code>/etc/fstab</code>:</p><pre><code># efi partition
#/dev/nvme0n1p1: UUID=&quot;846A-BE3E&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;vfat&quot; PARTUUID=&quot;2e1058ce-0964-4624-be29-1ae87beae5fc&quot;
UUID=&quot;846A-BE3E&quot;         /boot/efi   vfat  rw,noatime,errors=remount-ro 0 2
# swap partition
#/dev/nvme0n1p2: UUID=&quot;5d36c31a-6fbf-4d04-84ac-9ee1efaf5712&quot; TYPE=&quot;swap&quot; PARTUUID=&quot;a35a309d-e60d-4b4e-8ef4-296962fda56b&quot;
UUID=&quot;5d36c31a-6fbf-4d04-84ac-9ee1efaf5712&quot;	none	swap  sw                           0 0
# root partition
#/dev/nvme0n1p3: UUID=&quot;2c24a130-dc28-40fd-ad92-2fd68c75229e&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;ext4&quot; PARTUUID=&quot;43320d2d-f849-4b45-a14c-7ac254b330df&quot;
UUID=&quot;2c24a130-dc28-40fd-ad92-2fd68c75229e&quot;  /           ext4  defaults,noatime             0 1
</code></pre><p>Install UEFI:</p><pre><code>grub-install --target=x86_64-efi --efi-directory=/boot/efi/ --bootloader-id=Gentoo
# notice swap file
sed -Ei &quot;/GRUB_CMDLINE_LINUX_DEFAULT/s/^#*(GRUB.*DEFAULT=).*$/\1\&quot;resume=UUID=$(blkid -o value /dev/nvme0n1p2 | head -1)\&quot;/&quot; /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><p>os-probe related:</p><pre><code>echo 'sys-boot/grub mount' &gt;/etc/portage/package.use/grub
emerge -vj os-prober
echo 'GRUB_DISABLE_OS_PROBER=false' &gt;&gt;/etc/default/grub
</code></pre><h3 id=configuration>Configuration</h3><p>Create user:</p><pre><code>passwd root
useradd -m -G usb,wheel kkk
passwd kkk
emerge -vj app-admin/sudo
visudo    # uncomment #%wheel
</code></pre><p>Install NetworkManager:</p><pre><code>echo &quot;net-wireless/wpa_supplicant dbus&quot; &gt;&gt;/etc/portage/package.use/nm
echo &quot;net-misc/openssh -bindist&quot; &gt;&gt;/etc/portage/package.use/nm
emerge -vj1 net-misc/openssh net-misc/networkmanager
emerge -On net-misc/networkmanager
rc-update add NetworkManager default
rc-update add sshd default
</code></pre><p>Install log service:</p><pre><code>emerge -vj app-admin/syslog-ng
rc-update add syslog-ng default
</code></pre><p>Reboot:</p><pre><code>sync
exit
umount -Rl /mnt/gentoo/{dev,proc,sys,}
reboot
</code></pre><h3 id=repository>repository</h3><p>via:</p><pre><code>emerge --ask app-eselect/eselect-repository
eselect repository list
eselect repository enable  zugaina
emaint sync -r zugaina

</code></pre><h3 id=usb-key-related>usb key related</h3><p>Format via:</p><pre><code>livecd ~ # lsblk
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0         7:0    0 479.7M  1 loop /mnt/livecd
sda           8:0    1  57.3G  0 disk 
├─sda1        8:1    1   1.3G  0 part 
├─sda2        8:2    1   512K  0 part 
└─sda3        8:3    1    56G  0 part 
sr0          11:0    1 527.4M  0 rom  /mnt/cdrom
zram0       253:0    0     0B  0 disk 
nvme0n1     259:0    0 953.9G  0 disk 
├─nvme0n1p1 259:1    0   480M  0 part 
└─nvme0n1p2 259:2    0 953.4G  0 part 
livecd ~ # parted -a optimal /dev/sda
GNU Parted 3.6
Using /dev/sda
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) mklabel gpt                                                      
Warning: The existing disk label on /dev/sda will be destroyed and all data on this disk will be lost. Do you want to continue?
Yes/No? yes                                                               
(parted) mkpart primary fat32 0% 100%                                     
(parted) set 1 BOOT on                                                    
(parted) quit                                                             
Information: You may need to update /etc/fstab.

</code></pre><p>Create the gpg:</p><pre><code>livecd ~ # export GPG_TTY=$(tty)
livecd ~ # echo $(tty)
/dev/pts/0
livecd ~ # dd if=/dev/urandom bs=8388607 count=1 | gpg --symmetric --cipher-algo AES256 --output /tmp/efiboot/luks-key.gpg
gpg: directory '/root/.gnupg' created
1+0 records in
1+0 records out
8388607 bytes (8.4 MB, 8.0 MiB) copied, 6.76511 s, 1.2 MB/s

</code></pre><p>nvme ssd:</p><pre><code># parted -a optimal /dev/nvme0n1
GNU Parted 3.6
Using /dev/nvme0n1
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) unit s                                                           
(parted) print free                                                       
(parted) mkpart primary 2048s 2000409230s                                   
(parted) quit                                                             
Information: You may need to update /etc/fstab.
</code></pre><p>Create encrypted disk:</p><pre><code># gpg --decrypt /tmp/efiboot/luks-key.gpg | cryptsetup --cipher serpent-xts-plain64 --key-size 512 --hash whirlpool --key-file - luksFormat /dev/nvme0n1p1 
gpg: AES256.CFB encrypted data
gpg: encrypted with 1 passphrase
livecd ~ # cryptsetup luksDump /dev/nvme0n1p1

</code></pre><p>disk layout:</p><pre><code>livecd ~ # gpg --decrypt /tmp/efiboot/luks-key.gpg | cryptsetup --key-file - luksOpen  /dev/nvme0n1p1 gentoo
gpg: AES256.CFB encrypted data
gpg: encrypted with 1 passphrase
livecd ~ # ls /dev/mapper/
control  gentoo
livecd ~ # pvcreate /dev/mapper/gentoo
  Physical volume &quot;/dev/mapper/gentoo&quot; successfully created.
livecd ~ # vgcreate vg1 /dev/mapper/gentoo
  Volume group &quot;vg1&quot; successfully created
livecd ~ # grep MemTotal /proc/meminfo
MemTotal:       15954144 kB
livecd ~ # lvcreate --size 8G --name swap vg1
  Logical volume &quot;swap&quot; created.
livecd ~ # lvcreate --size 80G --name root vg1
  Logical volume &quot;root&quot; created.
livecd ~ # lvcreate --extents 95%FREE --name home vg1
  Logical volume &quot;home&quot; created.
livecd ~ # pvdisplay 
  --- Physical volume ---
  PV Name               /dev/mapper/gentoo
  VG Name               vg1
  PV Size               953.85 GiB / not usable &lt;1.32 MiB
  Allocatable           yes 
  PE Size               4.00 MiB
  Total PE              244186
  Free PE               11083
  Allocated PE          233103
  PV UUID               xBgj1j-1e3g-iaT0-esba-jJ3f-EO3m-Ty6wgY
   
livecd ~ # vgdisplay 
  --- Volume group ---
  VG Name               vg1
  System ID             
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  4
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                3
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               953.85 GiB
  PE Size               4.00 MiB
  Total PE              244186
  Alloc PE / Size       233103 / &lt;910.56 GiB
  Free  PE / Size       11083 / 43.29 GiB
  VG UUID               YUdAbE-MnJA-54GY-aQkb-Kp9G-P52q-Wl3Uey
   
livecd ~ # lvdisplay 
  --- Logical volume ---
  LV Path                /dev/vg1/swap
  LV Name                swap
  VG Name                vg1
  LV UUID                OKxWa1-NBN2-F6zx-E1qQ-wPQJ-2lmP-7abjG1
  LV Write Access        read/write
  LV Creation host, time livecd, 2024-06-03 12:41:29 +0000
  LV Status              available
  # open                 0
  LV Size                8.00 GiB
  Current LE             2048
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:1
   
  --- Logical volume ---
  LV Path                /dev/vg1/root
  LV Name                root
  VG Name                vg1
  LV UUID                yAMQV4-sNI7-zuY8-ZkDX-k53i-dxoF-PsvE4O
  LV Write Access        read/write
  LV Creation host, time livecd, 2024-06-03 12:41:43 +0000
  LV Status              available
  # open                 0
  LV Size                80.00 GiB
  Current LE             20480
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:2
   
  --- Logical volume ---
  LV Path                /dev/vg1/home
  LV Name                home
  VG Name                vg1
  LV UUID                APZd1G-qGe1-9t5c-AhBh-pUKt-Dit8-D2WTHd
  LV Write Access        read/write
  LV Creation host, time livecd, 2024-06-03 12:41:48 +0000
  LV Status              available
  # open                 0
  LV Size                &lt;822.56 GiB
  Current LE             210575
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           252:3
livecd ~ # vgchange --available y
  3 logical volume(s) in volume group &quot;vg1&quot; now active
livecd ~ # ls /dev/mapper
control  gentoo  vg1-home  vg1-root  vg1-swap
livecd ~ # vgchange --available y
  3 logical volume(s) in volume group &quot;vg1&quot; now active
livecd ~ # ls /dev/mapper
control  gentoo  vg1-home  vg1-root  vg1-swap
livecd ~ # mkswap -L &quot;swap&quot; /dev/mapper/vg1-swap
Setting up swapspace version 1, size = 8 GiB (8589930496 bytes)
LABEL=swap, UUID=b8653482-926c-4e26-89fb-55f52f3fca9f
livecd ~ # mkfs.ext4 -L &quot;root&quot; /dev/mapper/vg1-root
mke2fs 1.47.0 (5-Feb-2023)
Creating filesystem with 20971520 4k blocks and 5242880 inodes
Filesystem UUID: 030ae853-ad94-4fe5-a5a8-340aaeb54a6c
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000, 7962624, 11239424, 20480000

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (131072 blocks): done
Writing superblocks and filesystem accounting information: done   

livecd ~ # mkfs.ext4 -m 0 -L &quot;home&quot; /dev/mapper/vg1-home
mke2fs 1.47.0 (5-Feb-2023)
Creating filesystem with 215628800 4k blocks and 53911552 inodes
Filesystem UUID: f8534406-cdcb-4538-8397-2480d96a306b
Superblock backups stored on blocks: 
	32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208, 
	4096000, 7962624, 11239424, 20480000, 23887872, 71663616, 78675968, 
	102400000, 214990848

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (262144 blocks): done
Writing superblocks and filesystem accounting information: done     

livecd ~ # swapon -v /dev/mapper/vg1-swap
swapon: /dev/mapper/vg1-swap: found signature [pagesize=4096, signature=swap]
swapon: /dev/mapper/vg1-swap: pagesize=4096, swapsize=8589934592, devsize=8589934592
swapon /dev/mapper/vg1-swap
livecd ~ # mount -v -t ext4 /dev/mapper/vg1-root /mnt/gentoo
mount: /dev/mapper/vg1-root mounted on /mnt/gentoo.
livecd ~ # blkid /dev/sda1 /dev/nvme0n1p1 
/dev/sda1: UUID=&quot;81A6-BFB2&quot; BLOCK_SIZE=&quot;512&quot; TYPE=&quot;vfat&quot; PARTLABEL=&quot;primary&quot; PARTUUID=&quot;be83585f-0239-4b8a-8931-674aaaadb69d&quot;
/dev/nvme0n1p1: UUID=&quot;ddc06372-5d72-49a0-b617-b97128f8e3e6&quot; TYPE=&quot;crypto_LUKS&quot; PARTLABEL=&quot;primary&quot; PARTUUID=&quot;3635503c-78f0-44ce-8982-633ca20723ff&quot;

</code></pre><p>Receive the gpg key:</p><pre><code>gpg --keyserver  pgp.mit.edu --recv-key 2D182910
</code></pre><p>fetch the stage 3 file:</p><pre><code># cd /mnt/gentoo
# wget https://mirrors.ustc.edu.cn/gentoo/releases/amd64/autobuilds/20240602T164858Z/stage3-amd64-desktop-openrc-20240602T164858Z.tar.xz
</code></pre><p>untar the stage3 file:</p><pre><code>tar xvJpf stage3-amd64-*.tar.xz --xattrs-include='*.*' --numeric-owner
rm -f stage3-amd64-desktop-openrc-20240602T164858Z.tar.xz
</code></pre><p>Edit the bashrc:</p><pre><code>livecd /mnt/gentoo # cat /mnt/gentoo/root/.bashrc 
export NUMCPUS=$(nproc)
export NUMCPUSPLUSONE=$(( NUMCPUS + 1 ))
export MAKEOPTS=&quot;-j${NUMCPUSPLUSONE} -l${NUMCPUS}&quot;
export EMERGE_DEFAULT_OPTS=&quot;--jobs=${NUMCPUSPLUSONE} --load-average=${NUMCPUS}&quot;
</code></pre><p>copy the <code>bashrc_profile</code>:</p><pre><code>cp -v /mnt/gentoo/etc/skel/.bash_profile /mnt/gentoo/root/
</code></pre><p>edit the make.conf:</p><pre><code>livecd /mnt/gentoo # cat /mnt/gentoo/etc/portage/make.conf 
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /usr/share/portage/config/make.conf.example for a more
# detailed example.
COMMON_FLAGS=&quot;-march=native -O2 -pipe&quot;
CFLAGS=&quot;${COMMON_FLAGS}&quot;
CXXFLAGS=&quot;${COMMON_FLAGS}&quot;
FCFLAGS=&quot;${COMMON_FLAGS}&quot;
FFLAGS=&quot;${COMMON_FLAGS}&quot;

# NOTE: This stage was built with the bindist Use flag enabled

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
#LC_MESSAGES=C.utf8

# Note: MAKEOPTS and EMERGE_DEFAULT_OPTS are set in .bashrc

# The following licence is required, in addition to @FREE, for GNOME.
ACCEPT_LICENSE=&quot;CC-Sampling-Plus-1.0&quot;

# WARNING: Changing your CHOST is not something that should be done lightly.
# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.
CHOST=&quot;x86_64-pc-linux-gnu&quot;

# Use the 'stable' branch - 'testing' no longer required for Gnome 3.
# NB, amd64 is correct for both Intel and AMD 64-bit CPUs
ACCEPT_KEYWORDS=&quot;amd64&quot;

# Additional USE flags supplementary to those specified by the current profile.
USE=&quot;&quot;
CPU_FLAGS_X86=&quot;mmx mmxext sse sse2&quot;

# Important Portage directories.
PORTDIR=&quot;/var/db/repos/gentoo&quot;
DISTDIR=&quot;/var/cache/distfiles&quot;
PKGDIR=&quot;/var/cache/binpkgs&quot;

# This sets the language of build output to English.
# Please keep this setting intact when reporting bugs.
LC_MESSAGES=C

# Turn on logging - see http://gentoo-en.vfose.ru/wiki/Gentoo_maintenance.
PORTAGE_ELOG_CLASSES=&quot;info warn error log qa&quot;
# Echo messages after emerge, also save to /var/log/portage/elog
PORTAGE_ELOG_SYSTEM=&quot;echo save&quot;

# Ensure elogs saved in category subdirectories.
# Build binary packages as a byproduct of each emerge, a useful backup.
FEATURES=&quot;split-elog buildpkg&quot;

# Settings for X11
VIDEO_CARDS=&quot;intel i965&quot;
INPUT_DEVICES=&quot;libinput&quot;
</code></pre><p>Select ustc for the mirror, thus make.conf should be like following:</p><pre><code>livecd /mnt/gentoo # tail /mnt/gentoo/etc/portage/make.conf 
# Ensure elogs saved in category subdirectories.
# Build binary packages as a byproduct of each emerge, a useful backup.
FEATURES=&quot;split-elog buildpkg&quot;

# Settings for X11
VIDEO_CARDS=&quot;intel i965&quot;
INPUT_DEVICES=&quot;libinput&quot;

GENTOO_MIRRORS=&quot;https://mirrors.ustc.edu.cn/gentoo/ \
    rsync://rsync.mirrors.ustc.edu.cn/gentoo/&quot;

</code></pre><p>Edit the <code>repos.conf/gentoo.conf</code>:</p><pre><code>livecd /mnt/gentoo # cp -v /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf


livecd /mnt/gentoo # cat /mnt/gentoo/etc/portage/repos.conf/gentoo.conf 
[DEFAULT]
main-repo = gentoo

[gentoo]
location = /var/db/repos/gentoo
sync-type = webrsync
sync-uri = rsync://rsync.mirrors.ustc.edu.cn/gentoo-portage
auto-sync = yes
sync-rsync-verify-jobs = 1
sync-rsync-verify-metamanifest = yes
sync-rsync-verify-max-age = 3
sync-openpgp-key-path = /usr/share/openpgp-keys/gentoo-release.asc
sync-openpgp-keyserver = hkps://keys.gentoo.org
sync-openpgp-key-refresh-retry-count = 40
sync-openpgp-key-refresh-retry-overall-timeout = 1200
sync-openpgp-key-refresh-retry-delay-exp-base = 2
sync-openpgp-key-refresh-retry-delay-max = 60
sync-openpgp-key-refresh-retry-delay-mult = 4
sync-webrsync-verify-signature = yes

</code></pre><p>Edit the dns file:</p><pre><code># cat /mnt/gentoo/etc/resolv.conf 
nameserver 223.5.5.5
</code></pre><p>Prepare for chroot:</p><pre><code>livecd /mnt/gentoo # mount -v -t proc none /mnt/gentoo/proc
mount: none mounted on /mnt/gentoo/proc.
livecd /mnt/gentoo # mount -v --rbind /sys /mnt/gentoo/sys
mount: /sys bound on /mnt/gentoo/sys.
livecd /mnt/gentoo # mount -v --rbind /dev /mnt/gentoo/dev
mount: /dev bound on /mnt/gentoo/dev.
livecd /mnt/gentoo # mount -v --make-rslave /mnt/gentoo/sys
livecd /mnt/gentoo # mount -v --make-rslave /mnt/gentoo/dev
</code></pre><p>chroot in:</p><pre><code>livecd /mnt/gentoo # chroot /mnt/gentoo /bin/bash
livecd / # source /etc/profile
livecd / # export PS1=&quot;(chroot) $PS1
</code></pre><p>Sync and select profile:</p><pre><code> emaint sync --auto
 eselect profile list
 eselect profile set &quot;default/linux/amd64/17.1&quot;
 emerge --info
 grep -i useflag /var/db/repos/gentoo/profiles/use.desc
 emerge --ask --verbose --oneshot portage

</code></pre><p>set timezone and locale:</p><pre><code> echo &quot;Asia/Shanghai&quot;&gt;/etc/timezone
 emerge -v --config sys-libs/timezone-data
 nano -w /etc/locale.gen
 locale-gen
 eselect locale list
 eselect locale set &quot;C&quot;
 env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) $PS1&quot;
</code></pre><p>set cpu flags in make.conf:</p><pre><code>emerge --verbose --oneshot app-portage/cpuid2cpuflags
cpuid2cpuflags
nano -w /etc/portage/make.conf
</code></pre><p>Update using portage:</p><pre><code>emerge --ask --verbose --update --deep --newuse @world
</code></pre><p>build kernel:</p><pre><code>(chroot) livecd / # mkdir -p -v /etc/portage/package.license
mkdir: created directory '/etc/portage/package.license'
(chroot) livecd / # touch /etc/portage/package.license/zzz_via_autounmas
echo &quot;sys-kernel/linux-firmware linux-fw-redistributable no-source-code&quot; &gt;&gt; /etc/portage/package.license/linux-firmware
emerge --ask --verbose sys-kernel/gentoo-sources
emerge --ask --verbose sys-kernel/linux-firmware
(chroot) livecd / # readlink -v /usr/src/linux
readlink: /usr/src/linux: No such file or directory
(chroot) livecd / # eselect kernel list
Available kernel symlink targets:
  [1]   linux-6.6.30-gentoo
(chroot) livecd / # eselect kernel set 1
(chroot) livecd / # readlink -v /usr/src/linux
linux-6.6.30-gentoo
emerge --ask --verbose dev-vcs/git 
 # cat /etc/portage/repos.conf/waffle-builds.conf
[waffle-builds]
 
# Various utility ebuilds for Gentoo on EFI
# Maintainer: sakaki (sakaki@deciban.com)
 
location = /usr/local/portage/waffle-builds
sync-type = git
sync-uri = https://github.com/FlyingWaffleDev/waffle-builds.git
priority = 50
auto-sync = yes
(chroot) livecd / # emaint sync --repo waffle-builds
(chroot) livecd / # echo &quot;*/*::waffle-builds ~amd64&quot;&gt;&gt; /etc/portage/package.accept_keywords/waffle-builds-repo

</code></pre></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/8/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/8/>8</a></li><li class="page-item active"><a class=page-link href=/page/9/>9</a></li><li class=page-item><a class=page-link href=/page/10/>10</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/249/>249</a></li><li class=page-item><a href=/page/10/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/249/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>