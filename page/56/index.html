<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2018/12/05/ubuntu1604isocustomize/>Ubuntu1604ISOCustomize</a></h1><span class=post-date>Dec 5, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=steps>Steps</h3><p>ArchLinux Preparation:</p><pre><code>$ yaourt mkpasswd
</code></pre><pre><code># mkdir aiiso
# cd aiiso
# mv ../ubuntu-16.04.5-server-amd64.iso .
# mkdir newISO
# mkdir iso
# mount -o loop ./ubuntu-16.04.5-server-amd64.iso ./iso
# cp -r ./iso/* ./newISO
# cp -r ./iso/.disk ./newISO
# umount ./iso
# cp xxx.seed ./newISO/preseed
###### Make some customization
#  md5sum ./newISO/preseed/xxx.seed
ed9a5e91f66451080d27d3d85032801d  xxx.seed
# vim preseed/xxx.seed
# vim isolinux/txt.cfg
# mkisofs -D -r -V &quot;NETSON_UBUNTU&quot; -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o ../ai_ubuntu.iso .  &gt; /dev/null 2&gt;&amp;1
# isohybrid ../ai_ubuntu.iso

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2018/11/24/tipsonlightdm/>TipsOnLightdm</a></h1><span class=post-date>Nov 24, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=steps>Steps</h3><p>Install lightdm via:</p><pre><code>$ sudo pacman -S lightdm
</code></pre><p>but this will cause gui startup failed.</p><p><img src=/images/2018_11_24_21_09_12_541x252.jpg alt=/images/2018_11_24_21_09_12_541x252.jpg></p><p>Changes to lxdm solves the problem:</p><pre><code># pacman -S lxde
# systemctl enable lxdm.service
# vim /etc/lxdm/lxdm.conf
####autologin=dgod
# vim /root/.dmrc
[Desktop]
Session=xfce

</code></pre><p>Install:</p><pre><code># pacman -S xorg lightdm-gtk-greeter xterm xorg-xinit awesome
# vim /etc/lightdm.conf
greeter-session=lightdm-gtk-greeter

Add configuration for lightdm-gtk-greeter
</code></pre><p>Desktop Manager session:</p><pre><code> cat ~/.dmrc 
[Desktop]
Session=awesome
</code></pre><p>Install:</p><pre><code>$ groupadd -r autologin
$ gpasswd -a root autologin
$ pacman -S xfce4-goodies
$ pacman -S awesome
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2018/11/23/tipsonharbor/>TipsOnHarbor</a></h1><span class=post-date>Nov 23, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=harbor-configuration>Harbor Configuration</h3><p>Create user via:</p><p><img src=/images/2018_11_23_11_06_47_554x475.jpg alt=/images/2018_11_23_11_06_47_554x475.jpg></p><p>Create project:</p><p><img src=/images/2018_11_23_11_07_08_813x347.jpg alt=/images/2018_11_23_11_07_08_813x347.jpg></p><p>Add member:</p><p>Before:</p><p><img src=/images/2018_11_23_11_07_21_660x305.jpg alt=/images/2018_11_23_11_07_21_660x305.jpg></p><p>Added:<br><img src=/images/2018_11_23_11_07_36_618x403.jpg alt=/images/2018_11_23_11_07_36_618x403.jpg></p><p>After:</p><p><img src=/images/2018_11_23_11_07_55_660x319.jpg alt=/images/2018_11_23_11_07_55_660x319.jpg></p><p>Now docker-compose down the environment, backup the folder:</p><h3 id=installation-system>Installation System</h3><p>Configure the ip address:</p><p><img src=/images/2018_11_23_15_30_44_643x347.jpg alt=/images/2018_11_23_15_30_44_643x347.jpg></p><p>All nodes should be pointing to the dns address:</p><p><img src=/images/2018_11_23_15_33_04_681x477.jpg alt=/images/2018_11_23_15_33_04_681x477.jpg></p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2018/11/17/tipsonrongiso/>TipsOnRongISO</a></h1><span class=post-date>Nov 17, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=aim>AIM</h3><p>For building the kubespray offline all-in-one deploying iso.</p><h3 id=steps>Steps</h3><ol><li>Download 7.5.1804 ISO.</li><li>Create a new virtual machine, kvm based, minimal installation, for getting the
minimal vm files.</li><li>Install redsocks, compile it, then shutdown the minimal vm.</li><li>Create a qcow2 file based on minimal vm, start the vm, then change the
IP/Netmask/DNS.</li><li>Start redsocks. Test the unlimited networking.</li><li>Clone the kubespray repository, deploy the kubespray in all in one node.</li><li>Fetch the rpms from the kubespray all-in-one node.</li><li>Create a isolated networking and setup the offline environment.</li><li>Modify the kubespray source code for offline deployment.</li><li>Portus offline registry repo building.</li><li>Static website for holding static files(rpms/hypekube).</li><li>docker use intranet registry/ rpm use static website.</li></ol><h3 id=tobedone>TobeDone</h3><p>Steps for building deployment system.</p><pre><code>1. 
docker-compose
portus (docker-compose) composition files. 
portus images. 

2. 
inventory file(top layer)
kubespray files will be uploaded to deployment node. 

3. 
dns server setup
manually add dns server in all of the nodes. 

4. 
If initial environment is ok, then deploy environment will also be ok.  
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2018/11/15/makingofflinekubespraydeploymentiso/>MakingOfflineKubeSprayDeploymentISO</a></h1><span class=post-date>Nov 15, 2018<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=1-portus纯净版制作>1. Portus纯净版制作</h3><p>vagrant启动ubuntu14.04， 安装docker/docker-compose, 注意事项:</p><pre><code>$ sudo apt-get purge lxc-docker-1.9.0
$ sudo apt-get install \
    linux-image-extra-$(uname -r) \
    linux-image-extra-virtual
$ sudo apt-get update
$ sudo apt-get install -y \
    apt-transport-https \
        ca-certificates \
            curl \
                software-properties-common

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
$ sudo apt-key fingerprint 0EBFCD88
$ sudo add-apt-repository \
   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
      $(lsb_release -cs) \
         stable&quot;
$ sudo apt-get update
$ sudo apt-get install -y docker-ce
$ sudo apt-get install -y libyaml-dev libpython-dev
$ sudo pip uninstall docker-py
$ sudo pip uninstall docker-compose
$ sudo pip install --upgrade --force-reinstall  docker-compose
</code></pre><p>而后用我们预先定义好的compose目录(compose.tar.gz解压到/usr/local/compose目录下), 更改IP地址与域名的映射，<code>extra_hosts:</code>条目,
全翻墙条件下，一条命令启动:</p><pre><code># cd /usr/local/compose
# docker-compose up
</code></pre><p>因为我们预先已经定义好了域名与IP的配置，我们这里定义的内网IP为<code>192.168.33.18</code>,
于是在有浏览器的<code>192.168.33.1</code>机器上，配置<code>/etc/hosts</code>下的DNS条目：</p><pre><code># vim /etc/hosts
portus.xxxx.com	192.168.33.18
</code></pre><p>打开浏览器访问<code>https://portus.xxxx.com</code>，第一次登录需要配置admin的邮箱及密码:</p><p><img src=/images/2018_11_15_11_34_49_515x420.jpg alt=/images/2018_11_15_11_34_49_515x420.jpg></p><p>配置远端registry仓库:</p><p><img src=/images/2018_11_15_11_37_44_379x197.jpg alt=/images/2018_11_15_11_37_44_379x197.jpg></p><p>创建一个<code>kubespray</code>团队:</p><p><img src=/images/2018_11_15_11_39_26_913x404.jpg alt=/images/2018_11_15_11_39_26_913x404.jpg></p><p>User条目中，创建一个kubespray的用户:</p><p><img src=/images/2018_11_15_11_41_24_477x321.jpg alt=/images/2018_11_15_11_41_24_477x321.jpg></p><p>kubespray团队下添加kubespray用户:</p><p><img src=/images/2018_11_15_11_42_38_492x306.jpg alt=/images/2018_11_15_11_42_38_492x306.jpg></p><p>创建一个命名空间用于存放kubespray部署镜像:</p><p><img src=/images/2018_11_15_11_43_40_907x344.jpg alt=/images/2018_11_15_11_43_40_907x344.jpg></p><p>此刻Dashboard上可以看到我们刚才进行的操作。而在外部则可以通过docker
login来登录到此仓库。</p><p>现在关闭docker-compose启动的容器，备份好关键目录：</p><pre><code># cd /usr/local/compose/
# docker-compose down
Stopping compose_nginx_1_3541e93c08a9      ... done
Stopping compose_background_1_42f1644b8fea ... done
Stopping compose_registry_1_e6eb6ee23d0a   ... done
Stopping compose_portus_1_90c30953f8b0     ... done
Stopping compose_db_1_45dc41479cee         ... done
Removing compose_nginx_1_3541e93c08a9      ... done
Removing compose_background_1_42f1644b8fea ... done
Removing compose_registry_1_e6eb6ee23d0a   ... done
Removing compose_portus_1_90c30953f8b0     ... done
Removing compose_db_1_45dc41479cee         ... done
Removing network compose_default
# cd /var/lib
# tar cJvf portus.tar.xz portus/
# ls -l -h portus.tar.xz 
-rw-r--r-- 1 root root 687K Nov 15 03:49 portus.tar.xz
</code></pre><p>由上面可见，portus下现在没有任何上传的镜像及数据文件，整个目录压缩后仅1M不到的空间。</p><p>我们也需要portus运行所需要的所有镜像，使用下列命令打包成一个压缩后的镜像,
以便我们在编译ISO时使用:</p><pre><code># docker save $(docker images -q) -o portus_combine.tar
# ls -l -h portus_combine.tar 
-rw------- 1 root root 584M Nov 15 03:58 portus_combine.tar
</code></pre><p>由章节1我们得到用于制作Portus纯净仓库的文件，
<code>portus_combine.tar</code>和<code>portus.tar.xz</code>，用于后续的部署ISO编译使用。</p><h4 id=11-vagrant-box引出>1.1 vagrant box引出</h4><p>将上述的文件放到<code>/home/vagrant</code>目录， 并更改root的密码为<code>txxxxxxr</code>，
打包该虚拟机，以后我们将直接由vagrant box来批量执行.</p><pre><code># pwd
/home/vagrant
# ls
compose.tar.gz  portus_combine.tar  portus.tar.xz
</code></pre><p>打包该vagrant实例为box:</p><pre><code># vagrant status
Current machine states:

default                   poweroff (virtualbox)

The VM is powered off. To restart the VM, simply run `vagrant up`
# vagrant package --output portusBase.box
# ls -l -h portusBase.box
-rw-r--r-- 1 dash root 1.7G Nov 15 12:27 portusBase.box
</code></pre><h3 id=2-kubespray容器镜像>2. kubespray容器镜像</h3><p>VPS改写kubespray脚本，取回需要的容器镜像.</p><p>以下是本地镜像:<br>取回后的所有容器镜像，打包到<code>/vagrant</code>目录下:</p><pre><code># docker save $(docker images -q) -o kubespray_images.tar
# ls -l -h kubespray_images.tar 
-rw------- 1 root root 4.9G Nov 14 20:37 kubespray_images.tar
</code></pre><h3 id=3-portus部署仓库制作>3. Portus部署仓库制作</h3><p>由纯净版的box启动虚拟机，加载上一章制作出来容器镜像。</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/55/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/55/>55</a></li><li class="page-item active"><a class=page-link href=/page/56/>56</a></li><li class=page-item><a class=page-link href=/page/57/>57</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/228/>228</a></li><li class=page-item><a href=/page/57/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/228/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>