<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2020/10/22/workingtipsinronggraphinlxd/>WorkingTipsInRonggraphInLXD</a></h1><span class=post-date>Oct 22, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=lxd-environment>lxd environment</h3><p>Install lxd(Offline):</p><pre><code>snap download core
snap download core18
snap download lxd
snap ack core18_1885.assert; snap ack core_10185.assert; snap ack lxd_17936.assert
snap install core18_1885.snap ; snap install core_10185.snap ; snap install lxd_17936.snap
dpkg -i ./lxd_1%3a0.9_all.deb
which lxc
which lxd
</code></pre><p>Show lxc images:</p><pre><code>root@rong320-1:~/lxd# lxc image list
If this is your first time running LXD on this machine, you should also run: lxd init
To start your first instance, try: lxc launch ubuntu:18.04

+-------+-------------+--------+-------------+--------------+------+------+-------------+
| ALIAS | FINGERPRINT | PUBLIC | DESCRIPTION | ARCHITECTURE | TYPE | SIZE | UPLOAD DATE |
+-------+-------------+--------+-------------+--------------+------+------+-------------+
</code></pre><p>Download lxd images:</p><pre><code>https://us.images.linuxcontainers.org/images/alpine/3.12/amd64/default/20201021_13:00/
Download
rootfs.squashfs lxd.tar.xz 
root@rong320-1:~/lxdimages# ls
lxd.tar.xz  rootfs.squashfs
root@rong320-1:~/lxdimages# lxc image import lxd.tar.xz rootfs.squashfs --alias alpine312
Image imported with fingerprint: 76560d125792d7710d70f41b060e81f0bd4d83f1cc4e8dbd43fc371e5dea27bf
root@rong320-1:~/lxdimages# lxc image list
+-----------+--------------+--------+------------------------------------------+--------------+-----------+--------+------------------------------+
|   ALIAS   | FINGERPRINT  | PUBLIC |               DESCRIPTION                | ARCHITECTURE |   TYPE    |  SIZE  |         UPLOAD DATE          |
+-----------+--------------+--------+------------------------------------------+--------------+-----------+--------+------------------------------+
| alpine312 | 76560d125792 | no     | Alpinelinux 3.12 x86_64 (20201021_13:00) | x86_64       | CONTAINER | 2.40MB | Oct 22, 2020 at 3:48am (UTC) |
+-----------+--------------+--------+------------------------------------------+--------------+-----------+--------+------------------------------+
</code></pre><dl><dt>Auto Config the lxd(<a href=https://discuss.linuxcontainers.org/t/usage-of-lxd-init-preseed/1069/3>https://discuss.linuxcontainers.org/t/usage-of-lxd-init-preseed/1069/3</a>)</dt><dt>(<a href=https://lxd.readthedocs.io/en/latest/preseed/>https://lxd.readthedocs.io/en/latest/preseed/</a>)</dt><dd></dd></dl><pre><code>cat &lt;&lt;EOF | lxd init --preseed
config:
  core.https_address: 10.137.149.161:9199
  images.auto_update_interval: 15
networks:
- name: lxdbr0
  type: bridge
  config:
    ipv4.address: auto
    ipv6.address: none
EOF
root@rong320-1:~/lxdimages# cat storages.yml 
storage_pools:
- name: default
  driver: dir
  config:
    source: &quot;&quot;
root@rong320-1:~/lxdimages# lxd init --preseed&lt;./storages.yml

root@rong320-1:~/lxdimages# cat profiles.yml 
profiles:
- name: default
  devices:
    root:
      path: /
      pool: default
      type: disk
    eth0:
      nictype: bridged
      parent: lxdbr0
      type: nic
root@rong320-1:~/lxdimages# lxd init --preseed&lt;profiles.yml

</code></pre><p>Now we could check the default lxd bridges(lxdbr0).</p><h3 id=dockerdocker-compose-in-alpine>Docker/Docker-compose in alpine</h3><p>Create a new profile named <code>k8s</code>:</p><pre><code># lxc launch alpine312 firstalpine -p k8s
</code></pre><p>Create the first alpine instance:</p><pre><code># lxc launch alpine312 firstalpine
Creating firstalpine
Starting firstalpine           
# lxc ls
+-------------+---------+---------------------+------+-----------+-----------+
|    NAME     |  STATE  |        IPV4         | IPV6 |   TYPE    | SNAPSHOTS |
+-------------+---------+---------------------+------+-----------+-----------+
| firstalpine | RUNNING | 10.31.47.210 (eth0) |      | CONTAINER | 0         |
+-------------+---------+---------------------+------+-----------+-----------+
root@rong320-1:~/lxdimages# lxc exec firstalpine /bin/sh
~ # cat /etc/issue
Welcome to Alpine Linux 3.12
Kernel \r on an \m (\l)
</code></pre><p>Configure repository:</p><pre><code> # echo &quot;https://mirrors.aliyun.com/alpine/v3.12/main/&quot; &gt; /etc/apk/repositories
 # echo &quot;https://mirrors.aliyun.com/alpine/v3.12/community/&quot; &gt;&gt; /etc/apk/repositories
# apk update
# apk add docker-engine docker-compose docker-cli
</code></pre><p>Create the <code>cgroups-patch</code> file under <code>/etc/init.d</code>:</p><pre><code>#!/sbin/openrc-run

description=&quot;Mount the control groups for Docker&quot;

depend()
{
    keyword -docker
    need sysfs cgroups
}

start()
{
    if [ -d /sys/fs/cgroup ]; then
        mkdir -p /sys/fs/cgroup/cpu,cpuacct
        mkdir -p /sys/fs/cgroup/net_cls,net_prio

        mount -n -t cgroup cgroup /sys/fs/cgroup/cpu,cpuacct -o rw,nosuid,nodev,noexec,relatime,cpu,cpuacct
        mount -n -t cgroup cgroup /sys/fs/cgroup/net_cls,net_prio -o rw,nosuid,nodev,noexec,relatime,net_cls,net_prio

        if ! mountinfo -q /sys/fs/cgroup/openrc; then
            local agent=&quot;${RC_LIBEXECDIR}/sh/cgroup-release-agent.sh&quot;
            mkdir -p /sys/fs/cgroup/openrc
            mount -n -t cgroup -o none,nodev,noexec,nosuid,name=systemd,release_agent=&quot;$agent&quot; openrc /sys/fs/cgroup/openrc
        fi
    fi

    return 0
}

</code></pre><p>Added the auto-start and reboot:</p><pre><code># rc-update add cgroups-patch boot
# vim /etc/init.d/docker
.....
start_pre() {
        #checkpath -f -m 0644 -o root:docker &quot;$DOCKER_ERRFILE&quot; &quot;$DOCKER_OUTFILE&quot;
        echo &quot;fucku&quot;
}
.....
# rc-service docker start
# rc-update add docker default
# reboot
After reboot, check docker version
</code></pre><p>push files into lxc instance:</p><pre><code># lxc file push -r podmanitems/ firstalpine/root/
load all images
# docker images
~ # docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
rong/ui             master              66ad16eb15c5        20 minutes ago      28.9MB
rong/server         master              8150777ead18        23 hours ago        301MB
rong/kobe           master              2d0a03d6cedb        2 days ago          231MB
rong/nginx          1.19.2-amd64        7e4d58f0e5f3        5 weeks ago         133MB
rong/webkubectl     v2.6.0-amd64        4aa634837fea        2 months ago        349MB
rong/mysql-server   8.0.21-amd64        8a3a24ad33be        3 months ago        366MB
# lxc file push ronggraph.tar firstalpine/root/
# tar xzvf /root/ronggraph.tar
</code></pre><p>Should write a start definition for ronggraph:</p><pre><code>#!/sbin/openrc-run
#
# author: Yusuke Kawatsu

workspace=&quot;/root/ronggraph&quot;
cmdpath=&quot;/usr/bin/docker-compose&quot;
prog=&quot;ronggraph&quot;
lockfile=&quot;/var/lock/ronggraph&quot;
pidfile=&quot;/var/run/ronggraph.pid&quot;
PATH=&quot;$PATH:/usr/local/bin&quot;


start() {
    [ -x $cmdpath ] || exit 5
    echo -n $&quot;Starting $prog: &quot;

    cd $workspace
    $cmdpath up -d
    $cmdpath down
    retval=$?
    pid=$!
    echo
    [ $retval -eq 0 ] &amp;&amp; touch $lockfile &amp;&amp; echo $pid &gt; $pidfile

    return $retval
}

stop() {
    [ -x $cmdpath ] || exit 5
    echo -n $&quot;Stopping $prog: &quot;

    cd $workspace
    $cmdpath down
    retval=$?
    echo
    [ $retval -eq 0 ] &amp;&amp; rm -f $lockfile &amp;&amp; rm -f $pidfile

    return $retval
}

restart() {
    stop
    sleep 3
    start
}

depend() {
    need docker
}

</code></pre><p>Now add ronggraph to default update:</p><pre><code># rc-update add ronggraph default
# halt
</code></pre><p>Save the current status:</p><pre><code>root@rong320-1:~/lxdimages# lxc stop firstalpine
root@rong320-1:~/lxdimages# lxc publish --public firstalpine --alias=ronggraph
root@rong320-1:/mnt# lxc image ls
+-----------+--------------+--------+------------------------------------------+--------------+-----------+----------+------------------------------+
|   ALIAS   | FINGERPRINT  | PUBLIC |               DESCRIPTION                | ARCHITECTURE |   TYPE    |   SIZE   |         UPLOAD DATE          |
+-----------+--------------+--------+------------------------------------------+--------------+-----------+----------+------------------------------+
| alpine312 | 76560d125792 | no     | Alpinelinux 3.12 x86_64 (20201021_13:00) | x86_64       
| CONTAINER | 2.40MB   | Oct 22, 2020 at 6:18am (UTC) |
+-----------+--------------+--------+------------------------------------------+--------------+-----------+----------+------------------------------+
| ronggraph | b31788790460 | yes    | Alpinelinux 3.12 x86_64 (20201021_13:00) | x86_64       | CONTAINER | 619.40MB | Oct 22, 2020 at 8:05am (UTC) |
+-----------+--------------+--------+------------------------------------------+--------------+-----------+----------+------------------------------+
</code></pre><p>launch new instance:</p><pre><code># lxc launch ronggraph ronggraph -p k8s
# 
</code></pre><p>Add forward rules:</p><pre><code>lxc config device add ronggraph myport80 proxy listen=tcp:0.0.0.0:80 connect=tcp:0.0.0.0:80
lxc config device add ronggraph myport443 proxy listen=tcp:0.0.0.0:443 connect=tcp:0.0.0.0:443
</code></pre><h3 id=arm64-workingtips>arm64 workingtips</h3><p>Under rpi archlinux64, install:</p><pre><code># pacman -Sy
# pacman -S lxc lxd
# systemctl enable lxd
# systemctl start lxd
</code></pre><p>Download images from:</p><pre><code>https://us.images.linuxcontainers.org/images/alpine/3.12/arm64/default/20201022_13:00/
rootfs.squashfs
lxd.tar.xz
# lxc image import lxd.tar.xz rootfs.squashfs --alias alpine312
# lxd init --preseed&lt;pre-rong/lxditems/lxd_snap/init.yaml
# lxc profile create k8s
# lxc profile edit k8s&lt;pre-rong/lxditems/lxdimages/k8s.yaml
</code></pre><p><img src=/images/2020_10_23_09_55_43_629x378.jpg alt=/images/2020_10_23_09_55_43_629x378.jpg></p><p>Configure lxc for running:</p><pre><code>https://wiki.archlinux.org/index.php/Linux_Containers
</code></pre><p>lxc Installation:</p><pre><code># ~ # sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
~ # cat /etc/apk/repositories 
http://mirrors.ustc.edu.cn/alpine/v3.12/main
http://mirrors.ustc.edu.cn/alpine/v3.12/community
Install docker/docker-compose, modify its startup
</code></pre><p>lxc public will take a very long time!!!</p><pre><code># lxc ls
+------+---------+------------------------------+------+-----------+-----------+
| NAME |  STATE  |             IPV4             | IPV6 |   TYPE    | SNAPSHOTS |
+------+---------+------------------------------+------+-----------+-----------+
| king | RUNNING | 172.18.0.1 (br-74a26d2404f6) |      | CONTAINER | 0         |
|      |         | 172.17.0.1 (docker0)         |      |           |           |
|      |         | 10.150.132.185 (eth0)        |      |           |           |
+------+---------+------------------------------+------+-----------+-----------+
# lxc publish --public king --alias=ronggraph
# lxc image ls
+-----------+--------------+--------+-------------------------------------------+--------------+-----------+-----------+-------------------------------+
|   ALIAS   | FINGERPRINT  | PUBLIC |                DESCRIPTION                | ARCHITECTURE |   TYPE    |   SIZE    |          UPLOAD DATE          |
+-----------+--------------+--------+-------------------------------------------+--------------+-----------+-----------+-------------------------------+
| alpine312 | 58ebec92505e | no     | Alpinelinux 3.12 aarch64 (20201022_13:00) | aarch64      | CONTAINER | 2.20MB    | Oct 23, 2020 at 1:52am (UTC)  |
+-----------+--------------+--------+-------------------------------------------+--------------+-----------+-----------+-------------------------------+
| ronggraph | 607287f518d4 | yes    | Alpinelinux 3.12 aarch64 (20201022_13:00) | aarch64      | CONTAINER | 2655.15MB | Oct 23, 2020 at 10:13am (UTC) |
+-----------+--------------+--------+-------------------------------------------+--------------+-----------+-----------+-------------------------------+
#  lxc image export ronggraph .
# ls *.tar.gz
-rw-r--r--  1 root  root   2784123072 Oct 26 00:40 607287f518d40783ed968cd2f2434fba101d4332ccc16f1e66cfb43049208d57.tar.gz
</code></pre><p>Transfer the tar.gz into the arm64 server, and run it.</p><pre><code># /snap/bin/lxc image import lxditems/lxdimages/607287f518d40783ed968cd2f2434fba101d4332ccc16f1e66cfb43049208d57.tar.gz --alias ronggraph
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2020/10/21/kodatabase/>koDatabase</a></h1><span class=post-date>Oct 21, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=ko-admin>ko admin</h3><p>Via following commands for recoving the user priviledge:</p><pre><code># podman exec -it rong_mysql /bin/bash
</code></pre><p>Sql 操作:</p><pre><code>mysqlbash-4.2# mysql -uroot -p
Enter password: 
mysql&gt; use ko
mysql&gt; update ko_user set is_active=1 where name='admin';
mysql&gt; update ko_user set is_admin=1 where name='admin;
</code></pre><p>Now go back to login page, you will use admin user for login.</p><h3 id=ko-cluster-import>ko cluster import</h3><p>Import cluster to ko:</p><pre><code>root@focal-1:/mnt/Rong_RongGraph/rong/4_addons# kubectl get sa -n kube-system | grep dashboard
kubernetes-dashboard                 1         10m
root@focal-1:/mnt/Rong_RongGraph/rong/4_addons# kubectl get secret -n kube-system | grep dashboard
kubernetes-dashboard-certs                       Opaque                                0      10m
kubernetes-dashboard-csrf                        Opaque                                1      10m
kubernetes-dashboard-key-holder                  Opaque                                2      10m
kubernetes-dashboard-token-mpf77                 kubernetes.io/service-account-token   3      10m
root@focal-1:/mnt/Rong_RongGraph/rong/4_addons# kubectl -n kube-system describe secrets kubernetes-dashboard-token-mpf77
Name:         kubernetes-dashboard-token-mpf77
Namespace:    kube-system
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard
              kubernetes.io/service-account.uid: ff6cac3e-d90c-4990-bb90-e245ac762696

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1025 bytes
namespace:  11 bytes
token:      xxxxxxx

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2020/10/16/kubeovnworkingtips/>KubeOVNWorkingTips</a></h1><span class=post-date>Oct 16, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=server-sidek8s>Server side(k8s)</h3><p><code>kkk.yaml</code> defined the subnet created via kubeovn</p><pre><code>apiVersion: kubeovn.io/v1
kind: Subnet
metadata:
  name: etc
spec:
  protocol: IPv4
  default: false
  namespaces:
  - etl
  - etl1
  cidrBlock: 100.64.0.0/16
  gateway: 100.64.0.1
  excludeIps:
  - 100.64.0.1
  private: false
  gatewayType: distributed
  natOutgoing: false
</code></pre><p>Create the subnet via <code>kubectl create -f kkk.yaml</code>, then you could view the subnet via:</p><pre><code># kubectl get subnet
NAME	PROTOCOL	CIDR		PRIVATE	NAT	DEFAULT	GATEWAYTYPE	USED AVAILABLE
etc	IPV4		100.64.0.0/16	false	false	false	distributed	1	65532
</code></pre><p>Create namespace via <code>kubectl create ns etl</code> and <code>kubectl create ns etl1</code>, then run a deployment in these 2 namespace:</p><pre><code># kubectl run nginxetl --image=nginx:1.17 --namespace etl
# kubectl get pod -n etl -o wide
The pod's ip address is 100.64.0.3
</code></pre><h3 id=client-sideouter-space-machines>Client Side(outer space machines)</h3><p>Add route via:</p><pre><code># route add -net 100.64.0.0/16 gw 192.192.xxx.xxx
# curl 100.64.0.3
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2020/09/28/openwrtbox/>OpenWRTBox</a></h1><span class=post-date>Sep 28, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=tips>Tips</h3><p>Version: <code>ATTITUDE ADJUSTMENT (12.09, r36088)</code>, so we have to login into this box via:</p><pre><code>$ ssh -oKexAlgorithms=+diffie-hellman-group1-sha1  root@192.168.2.1
</code></pre><p>Luckly we got the dhcp enabled in this equipment!!! Otherwise this equipment is bricked.</p><p>Change wifi setting under <code>Network->Wifi->Interface Configuration->General Setup</code>:</p><p><img src=/images/2020_09_28_09_49_31_986x277.jpg alt=/images/2020_09_28_09_49_31_986x277.jpg></p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2020/09/27/etcdrecovery/>etcdRecovery</a></h1><span class=post-date>Sep 27, 2020<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>主节点操作:</p><pre><code>root@newnode-1:/home/test# ETCDCTL_API=3 etcdctl --endpoints=https://192.168.122.21:2379 --cacert=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member list
4047613ce64ac480, started, etcd2, https://192.168.122.58:2380, https://192.168.122.58:2379
ac76e9faf75cf70f, started, etcd3, https://192.168.122.75:2380, https://192.168.122.75:2379
e99611c964d08e01, started, etcd1, https://192.168.122.21:2380, https://192.168.122.21:2379
root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; cluster-health
member 4047613ce64ac480 is healthy: got healthy result from https://192.168.122.58:2379
failed to check the health of member ac76e9faf75cf70f on https://192.168.122.75:2379: Get https://192.168.122.75:2379/health: dial tcp 192.168.122.75:2379: connect: connection refused
member ac76e9faf75cf70f is unreachable: [https://192.168.122.75:2379] are all unreachable
member e99611c964d08e01 is healthy: got healthy result from https://192.168.122.21:2379
cluster is degraded
</code></pre><p>删除问题节点:</p><pre><code>root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member remove ac76e9faf75cf70f
Removed member ac76e9faf75cf70f from cluster
root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member list
4047613ce64ac480: name=etcd2 peerURLs=https://192.168.122.58:2380 clientURLs=https://192.168.122.58:2379 isLeader=true
e99611c964d08e01: name=etcd1 peerURLs=https://192.168.122.21:2380 clientURLs=https://192.168.122.21:2379 isLeader=false
</code></pre><p>问题节点上操作:</p><pre><code>systemctl stop etcd
mv /var/lib/etcd /var/lib/etcd.back
mkdir /var/lib/etcd
systemctl start etcd
</code></pre><p>新增:</p><pre><code>root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member add etcd3 https://192.168.122.75:2380
Added member named etcd3 with ID 318e07d1cc0d3933 to cluster

ETCD_NAME=&quot;etcd3&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd3=https://192.168.122.75:2380,etcd2=https://192.168.122.58:2380,etcd1=https://192.168.122.21:2380&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;existing&quot;
root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member list
318e07d1cc0d3933[unstarted]: peerURLs=https://192.168.122.75:2380
4047613ce64ac480: name=etcd2 peerURLs=https://192.168.122.58:2380 clientURLs=https://192.168.122.58:2379 isLeader=true
e99611c964d08e01: name=etcd1 peerURLs=https://192.168.122.21:2380 clientURLs=https://192.168.122.21:2379 isLeader=false
</code></pre><p>如果是unstarted 状态，则到有问题节点:</p><pre><code>systemctl stop etcd
rm -rf /var/lib/etcd/member
systemctl start etcd
</code></pre><p>回到主节点， 观察集群状态是否回复成功</p><pre><code>root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; member list
4047613ce64ac480: name=etcd2 peerURLs=https://192.168.122.58:2380 clientURLs=https://192.168.122.58:2379 isLeader=true
531c8ba1dbabce70: name=etcd3 peerURLs=https://192.168.122.75:2380 clientURLs=https://192.168.122.75:2379 isLeader=false
e99611c964d08e01: name=etcd1 peerURLs=https://192.168.122.21:2380 clientURLs=https://192.168.122.21:2379 isLeader=false
root@newnode-1:/home/test# ETCDCTL_API=2 etcdctl --endpoints=https://192.168.122.21:2379 --ca-file=&quot;/etc/ssl/etcd/ssl/ca.pem&quot; --cert-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1.pem&quot; --key-file=&quot;/etc/ssl/etcd/ssl/member-newnode-1-key.pem&quot; cluster-health
member 4047613ce64ac480 is healthy: got healthy result from https://192.168.122.58:2379
member 531c8ba1dbabce70 is healthy: got healthy result from https://192.168.122.75:2379
member e99611c964d08e01 is healthy: got healthy result from https://192.168.122.21:2379
cluster is healthy
</code></pre></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/35/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/35/>35</a></li><li class="page-item active"><a class=page-link href=/page/36/>36</a></li><li class=page-item><a class=page-link href=/page/37/>37</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/232/>232</a></li><li class=page-item><a href=/page/37/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/232/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>