<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2022/01/25/runwaydroidubportsonpixel3a/>RunWaydroidUbportsOnPixel3a</a></h1><span class=post-date>Jan 25, 2022<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>最近会研究一些安卓虚拟化的知识，这里记录下来在Pixel
3a上刷Ubports后，在Ubports中启用waydroid的过程。</p><h3 id=1-准备工作相关概念>1. 准备工作/相关概念</h3><p>Pixel
3a一支，淘宝很容易买到，注意要买可解锁BootLoader的，价格大概是四五百块，取决于成色。</p><p>选择Pixel
3a是因为它是Ubports官方支持中比较完善的几个之一，官方的设备支持列表如下：<br><a href="https://devices.ubuntu-touch.io/?pk_vid=5294f9f7280f826e164306913156a7ee">https://devices.ubuntu-touch.io/?pk_vid=5294f9f7280f826e164306913156a7ee</a></p><p>当然如果手头有别的可以刷的手机也可以尝试下, Pixel
3a的刷机体验是比较好的。</p><p>Ubports: Ubuntu touch.<br>Waydroid: 以前称为Anbox-Halium，是Anbox 的重建版本，旨在使用比Anbox
更新更流畅的安卓算力体验。</p><h3 id=2-操作指南>2. 操作指南</h3><h4 id=21-刷入安卓9>2.1 刷入安卓9</h4><p>参考<a href=https://devices.ubuntu-touch.io/device/sargo/>https://devices.ubuntu-touch.io/device/sargo/</a></p><p>全翻墙的情况下，访问:</p><p><a href=https://flash.android.com/release>https://flash.android.com/release</a>,
按提示操作, 记得选择图示为<code>PQ3B.190801.002</code>的安卓9版本。</p><p><img src=/images/2022_01_25_09_06_50_621x486.jpg alt=/images/2022_01_25_09_06_50_621x486.jpg></p><p>看到此提示则代表刷入已经成功:</p><p><img src=/images/2022_01_25_07_58_49_612x183.jpg alt=/images/2022_01_25_07_58_49_612x183.jpg>
刷入成功后会提示需要lock bootloader，
按照提示先将bootloader锁定后，进入到安卓9中执行初始化操作.
接着进入到解锁bootloader以便刷Ubports.</p><h4 id=22-解锁bootloader>2.2 解锁bootloader:</h4><p>首先要做的是开启Usb调试
<code>关于手机</code>-><code>版本号</code>上狂点，直至打开<code>开发者模式</code>，
而后<code>系统</code>-><code>开发者选项</code>-><code>调试</code>-><code>USB调试</code>.</p><pre><code># adb devices
List of devices attached
xxxxxx5	device

# adb reboot bootloader
</code></pre><p>此时手机会停在fastboot阶段，在终端中继续敲入</p><pre><code># fastboot flashing unlock
OKAY [  0.338s]
Finished. Total time: 0.338s
</code></pre><p>此时在手机上按音量-键选择到<code>unlock bootloader</code>的选项后，继续按电源键确定。bootloader解锁成功后需重新启动并重新设置手机。此时需要重新开启usb调试等。</p><h4 id=23-刷入ubports>2.3 刷入ubports</h4><p>再次强调: ubports刷入的先决条件是pixel 3a上运行的安卓版本为<code>PQ3B.190801.002</code>。</p><p>ArchLinux上通过snap安装ubports刷机软件, 参考网址如下:</p><p><a href=https://snapcraft.io/install/ubports-installer/arch>https://snapcraft.io/install/ubports-installer/arch</a></p><p>开启刷机软件开始刷ubports:</p><pre><code>sudo ubports-installer
</code></pre><p><img src=/images/2022_01_25_08_25_47_803x441.jpg alt=/images/2022_01_25_08_25_47_803x441.jpg></p><p>确认手机型号:</p><p><img src=/images/2022_01_25_08_26_04_657x371.jpg alt=/images/2022_01_25_08_26_04_657x371.jpg></p><p>选择devel版(如果不是为了体验waydroid也可以选择为stable版), 一定要选择<code>wipe userdata</code>，否则刷机将一直卡顿不会成功:</p><p><img src=/images/2022_01_25_08_26_38_621x462.jpg alt=/images/2022_01_25_08_26_38_621x462.jpg></p><p>这里提示在fastboot菜单中需要选择为<code>Recovery Mode</code>才可以继续安装，在手机上按音量-键结合电源键选择，进入到恢复模式后点下一步:</p><p><img src=/images/2022_01_25_08_27_53_716x365.jpg alt=/images/2022_01_25_08_27_53_716x365.jpg></p><p>现在<code>ubports-installer</code>将自动下载镜像并进行刷机，刷机速度取决于下载速度,
推荐在空闲时段操作，在早上7、8点时大概几分钟时间刷好:</p><p><img src=/images/2022_01_25_08_29_20_554x581.jpg alt=/images/2022_01_25_08_29_20_554x581.jpg></p><p>刷机软件提示出以下界面的时候，手机将重启，这时需要耐心等待手机上的刷机进程完成写入操作，刷机过程中会有个黄色的小标志在不停转动， 而后将重启:</p><p><img src=/images/2022_01_25_08_31_21_651x492.jpg alt=/images/2022_01_25_08_31_21_651x492.jpg></p><p>经过一系列设置之后，Ubports将启动成功并进入到系统中。</p><h4 id=24-安装waydroid>2.4 安装waydroid</h4><p>确认自己安装的是开发者版本，如果是stable的话，在<code>关于</code>-><code>检查更新</code>下的配置按钮中，切换成开发者版本就可以了:</p><p><img src=/images/2022_01_25_08_47_25_478x309.jpg alt=/images/2022_01_25_08_47_25_478x309.jpg></p><p><code>waydroid</code>中也是可以使用adb命令的，使用adb命令连接到手机上后，运行waydroid的安装操作,
adb命令的一个参考如下(以下参考演示了如何连接到手机、如何从手机取回截屏):</p><pre><code>$ adb devices
List of devices attached
92UAY04L95	device

$ adb shell
phablet@ubuntu-phablet:~$ ls
Desktop  Documents  Downloads  Music  Pictures  Public  Templates  Videos
phablet@ubuntu-phablet:~$ cd Pictures/
phablet@ubuntu-phablet:~/Pictures$ ls
Screenshots
phablet@ubuntu-phablet:~/Pictures$ cd Screenshots/
phablet@ubuntu-phablet:~/Pictures/Screenshots$ ls
screenshot20220125_084411555.png
phablet@ubuntu-phablet:~/Pictures/Screenshots$ exit

$ adb pull /home/phablet/Pictures/Screenshots/screenshot20220125_084411555.png
/home/phablet/Pictures/Screenshots/screenshot20220125_084411555.png: 1 file pulled, 0 skipped. 2.7 MB/s (76661 bytes in 0.027s)
</code></pre><p>可以检查一下磁盘占用情况, 确保安装waydroid具备足够的磁盘空间:</p><pre><code>dfphablet@ubuntu-phablet:~$ df -h
Filesystem       Size  Used Avail Use% Mounted on
/dev/root        3.0G  2.2G  804M  73% /
devtmpfs         1.7G  604K  1.7G   1% /dev
tmpfs            1.8G  1.3M  1.8G   1% /run
/dev/loop0       268M  267M     0 100% /android
/dev/mmcblk0p72   49G   27M   47G   1% /userdata
none             4.0K     0  4.0K   0% /sys/fs/cgroup
cgmfs            100K     0  100K   0% /run/cgmanager/fs
tmpfs            1.8G   32K  1.8G   1% /tmp
none             5.0M     0  5.0M   0% /run/lock
none             1.8G  172K  1.8G   1% /run/shm
none             100M     0  100M   0% /run/user
tmpfs            1.8G     0  1.8G   0% /media
tmpfs            1.8G     0  1.8G   0% /var/lib/openvpn/chroot/tmp
tmpfs            1.8G     0  1.8G   0% /var/lib/sudo
/dev/mmcblk0p71  755M  512M  228M  70% /android/vendor
tmpfs            1.8G     0  1.8G   0% /mnt/vendor
/dev/mmcblk0p48   35M  3.8M   30M  12% /mnt/vendor/persist
/dev/mmcblk0p66   12M   80K   11M   1% /android/metadata
/dev/mmcblk0p22   80M   72M  8.8M  90% /android/vendor/firmware_mnt
tmpfs            356M   40K  356M   1% /run/user/32011
tmpfs            356M     0  356M   0% /run/user/0
</code></pre><p><code>adb shell</code>下输入如下命令安装<code>waydroid</code>:</p><pre><code>sudo -s
sudo mount -o remount,rw /
apt update
apt install waydroid -y
waydroid init
</code></pre><p>值得注意的是，<code>waydroid init</code>需要从sourceforge拉取700MB左右的镜像，由于众所周知的原因，国内网络一直不是很好，这一步可能会耗费很长的时间。个人建议是在网络空闲时段(例如起个大早来跑)运行该操作。当然具备动手能力的可以用全翻墙网路来跑，速度会快很多。</p><p>waydroid命令实际上是一个python脚本，理论上是可以改一下调整它的镜像初始化机制以使用本地包用于离线安装的, 有兴趣的可以更改源码。</p><pre><code>root@ubuntu-phablet:~# which waydroid
/usr/bin/waydroid
root@ubuntu-phablet:~# cd /usr/lib/waydroid/
root@ubuntu-phablet:~# grep -i &quot;http&quot; ./ -r | grep channel
./tools/config/__init__.py:    &quot;system_channel&quot;: &quot;http://ota.waydro.id/system&quot;,
./tools/config/__init__.py:    &quot;vendor_channel&quot;: &quot;http://ota.waydro.id/vendor&quot;,
</code></pre><p>waydroid初始化过程:</p><pre><code>root@ubuntu-phablet:~# waydroid init
[08:55:02] Download https://sourceforge.net/projects/waydroid/files/images/system/lineage/waydroid_arm64/lineage-17.1-20211021-VANILLA-waydroid_arm64-system.zip/download
[09:04:37] Validating system image
[09:04:38] Extracting to /var/lib/waydroid/images
[09:05:22] Download https://sourceforge.net/projects/waydroid/files/images/vendor/waydroid_arm64/lineage-16.0-20211020-HALIUM_9-waydroid_arm64-vendor.zip/download
[09:05:42] Validating vendor image
[09:05:42] Extracting to /var/lib/waydroid/images
</code></pre><p>此时需要重启手机以继续安装。</p><h4 id=25-启动waydroid>2.5 启动waydroid</h4><p>启动完毕后，首先启动waydroid容器:</p><pre><code>$ adb shell
phablet@ubuntu-phablet:~$ sudo waydroid container start
[sudo] password for phablet: 

</code></pre><p>然后在另一个adb shell中启动waydroid session，
此时第一个shell里的命令会退出，接着就可以点开waydroid了:</p><pre><code>$ waydroid session start
[09:15:30] XDG Session is not &quot;wayland&quot;
[09:15:32] Failed to start Clipboard manager service, check logs
[09:15:51] Android with user 0 is ready
</code></pre><p>接着在手机里点开<code>wayroid</code>则可以开启waydroid界面.</p><p>启动这一步一直没太搞明白应该怎样才是正确的操作。但经历以上操作后，再次关机重启后，waydroid都可以直接在ubports下直接点开</p><p>如果遇到初始化问题不成功需要重新开始的话，可以使用以下命令清零waydroid安装:</p><pre><code>apt remove waydroid
apt purge waydroid
sudo rm -rf /var/lib/waydroid /home/.waydroid ~/waydroid ~/.share/waydroid ~/.local/share/applications/*aydroid* ~/.local/share/waydroid
</code></pre><h4 id=26-体验waydroid>2.6 体验waydroid</h4><p>安装应用宝:</p><pre><code>$ adb push MobileAssistant_1.apk /home/phablet/
MobileAssistant_1.apk: 1 file pushed, 0 skipped. 6.1 MB/s (10925622 bytes in 1.720s)
$ apks adb shell
phablet@ubuntu-phablet:~$ sudo waydroid app install ~/MobileAssistant_1.apk
[sudo] password for phablet: 
</code></pre><p><img src=/images/2022_01_25_09_25_18_406x838.jpg alt=/images/2022_01_25_09_25_18_406x838.jpg>
接下来的操作就是常规的安装apk, 使用apk。</p><p>鲁大师跑快40万分:</p><p><img src=/images/2022_01_25_09_49_20_405x834.jpg alt=/images/2022_01_25_09_49_20_405x834.jpg></p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2022/01/10/linuxtips14/>LinuxTips14</a></h1><span class=post-date>Jan 10, 2022<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=1-ubuntu2004-use-python2>1. ubuntu20.04 use python2</h3><p>Via:</p><pre><code>$ sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1
</code></pre><p>this solves some aosp building issues when the aosp building tree requires python2.7 to be the default python version.</p><h3 id=2-ubports-issue>2. ubports issue</h3><p>via:</p><pre><code>B ) Manual installation

#Open Ubuntu Touch terminal (or a shell session on your host computer) and run:

sudo -s
sudo mount -o remount,rw /
apt update
apt install waydroid -y
waydroid init 
ubports-qa install xenial_-_fixwindowreopen
alternatively, to install Google Apps, replace the line

waydroid init
with:

waydroid init -s GAPPS
#For Vollaphone, add:

waydroid prop set persist.waydroid.height_padding 70
</code></pre><h3 id=3-lockunlock-bootloader>3. lock/unlock bootloader</h3><p>via:</p><pre><code>fastboot flashing lock
fastboot flashing unlock
</code></pre><h3 id=4-reflashing-pixel-3a>4. reflashing pixel 3a</h3><p>visit <code>https://flash.android.com/release/10.0.0</code>.</p><h3 id=5-flashing-kernel-module>5. flashing kernel module</h3><p>via:</p><pre><code># disable-verity on the phone
adb root
adb disable-verity
adb shell sync
adb reboot

# push module
adb root
adb remount
adb push out/android-msm-pixel-4.9/dist/*.ko /vendor/lib/modules/
# 重启设备以后可以设备正常使用 查看内核版本 的确已经是自编译的内核
adb reboot
</code></pre><h3 id=6-disable-oh-my-zsh-upgrade>6. Disable oh-my-zsh upgrade</h3><p>By adding following lines in ~/.zshrc :</p><pre><code>+ DISABLE_UPDATE_PROMPT=true
+ DISABLE_AUTO_UPDATE=true
source $ZSH/oh-my-zsh.sh
</code></pre><h3 id=7-install-chromium-on-mips64el>7. Install chromium on mips64el</h3><p>Via:</p><pre><code>wget http://okapps.oukan.online/lroapps/deb-loongson/chromium-browser-beta_82.0.4051.0-1_mips64el.deb
wget http://ftp.us.debian.org/debian/pool/main/libi/libindicator/libindicator3-7_0.5.0-4_mips64el.deb
wget http://ftp.us.debian.org/debian/pool/main/liba/libappindicator/libappindicator3-1_0.4.92-7_mips64el.deb
apt-get install -y ./libappindicator3-1_0.4.92-7_mips64el.deb ./libindicator3-7_0.5.0-4_mips64el.deb
apt-get install -y ./chromium-browser-beta_82.0.4051.0-1_mips64el.deb
</code></pre><h3 id=8-grub-configurationubuntu>8. grub configuration(Ubuntu)</h3><p>Changed back to origin kernel version:</p><pre><code># vim /etc/default/grub
GRUB_DEFAULT=&quot;Advanced options for Ubuntu&gt;Ubuntu, with Linux 5.4.0-99-generic&quot;
# update-grub2
# update-grub
# reboot
</code></pre><h3 id=9-install-docker-ce-on-arm64>9. Install docker-ce on arm64</h3><p>First remove conflict packages and import gpg:</p><pre><code>sudo apt-get remove docker docker-engine docker.io
sudo apt-get install apt-transport-https ca-certificates curl gnupg2 software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -
</code></pre><p>Then import repository and install <code>docker-ce</code>:</p><pre><code># vim /etc/apt/sources.list
....
deb [arch=arm64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable

# apt-get update &amp;&amp; apt-get install -y docker-ce
</code></pre><h3 id=10-run-redroid-with-amd>10. run redroid with amd</h3><p>Command:</p><pre><code>$ sudo docker run -itd --name redroid9 --memory-swappiness=0 --privileged   -p 5556:5555 redroid/redroid:9.0.0-latest redroid.fps=60 ro.sf.lcd_density=150 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128
$ sudo docker run -itd --name redroid12 --memory-swappiness=0 --privileged   -p 5555:5555 redroid/redroid:12.0.0-latest redroid.fps=120 ro.sf.lcd_density=240 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128
</code></pre><p>Or with virtio:</p><pre><code>sudo docker run -itd --name redroid9 --memory-swappiness=0 --privileged   -p 5555:5555 redroid/redroid:9.0.0-latest redroid.fps=120 ro.sf.lcd_density=240 redroid.width=1080 redroid.height=1920
</code></pre><h3 id=11-opengl-issue>11. opengl issue</h3><p>via virgl issue:</p><pre><code>https://archived.forum.manjaro.org/t/qemu-kvm-vm-in-virt-manager-is-running-with-a-black-screen-when-opengl-acceleration-is-turned-on/138632/8
</code></pre><h3 id=12-content-of-rpm>12. content of rpm</h3><p>via:</p><pre><code># rpm -ql {packageName}
# rpm -ql htop
# rpm -qlp /path/to/nginx.rpm
</code></pre><h3 id=13-apt-fast>13. apt-fast</h3><p>install via:</p><pre><code>sudo add-apt-repository ppa:apt-fast/stable
sudo apt-get update
sudo apt-get -y install apt-fast
</code></pre><h3 id=14-ubuntu-device-driver>14. ubuntu device driver</h3><p>Install via:</p><pre><code>$ ubuntu-drivers devices
</code></pre><h3 id=15-yum-groupremove>15. yum groupremove</h3><p>via:</p><pre><code>yum groupremove &quot;X Window System&quot;
</code></pre><h3 id=16-linux-zen>16. linux-zen</h3><p>In archlinux via:</p><pre><code># sudo pacman -S linux-zen linux-zen-headers
</code></pre><p>Then update the entry:</p><pre><code># vim /etc/default/grub
#GRUB_DEFAULT=0
GRUB_DEFAULT=&quot;Advanced options for Arch Linux&gt;Arch Linux, with Linux linux-zen&quot;
GRUB_TIMEOUT=3
# grub-mkconfig -o /boot/grub/grub.cfg
# reboot
# uname -a
Linux archsg1 5.16.14-zen1-1-zen #1 ZEN SMP PREEMPT Fri, 11 Mar 2022 17:40:33 +0000 x86_64 GNU/Linux

</code></pre><h3 id=17-build-linux-zen>17. Build linux-zen</h3><p>Steps:</p><pre><code>$ sudo pacman -S base-devel asp
$ asp checkout linux-zen
Copy to some place, and modify the config
$ makepkg --clean --syncdeps --rmdeps
</code></pre><p>gpg checksum failed, solved via:</p><pre><code>==&gt; Verifying source file signatures with gpg...
    archlinux-linux git repo ... FAILED (unknown public key 3B94A80E50A477C7)
==&gt; ERROR: One or more PGP signatures could not be verified!

# vim /etc/pacman.d/gnupg/gpg.conf
no-greeting
no-permission-warning
lock-never
keyserver-options timeout=10
keyserver-options import-clean
keyserver-options no-self-sigs-only
+ keyserver hkps://keys.openpgp.org

# curl -s https://keybase.io/heftig/pgp_keys.asc/\?fingerprint\=a2ff3a36aaa56654109064ab19802f8b0d70fc30 | gpg --import
# gpg --lsign 3B94A80E50A477C7
</code></pre><p>Rebuild the kernel and install</p><h3 id=18-change-password-in-single>18. Change password in single</h3><p><img src=/images/2022_03_18_16_40_49_526x166.jpg alt=/images/2022_03_18_16_40_49_526x166.jpg></p><h3 id=19-find-which-file-belong-to-rpm>19. find which file belong to rpm</h3><p>via:</p><pre><code>$ rpm -qf file_name
</code></pre><h3 id=20-linux-zen>20. linux-zen</h3><p>Install on ubuntu via:</p><pre><code>sudo add-apt-repository ppa:damentz/liquorix &amp;&amp; sudo apt-get update
sudo apt-get install linux-image-liquorix-amd64 linux-headers-liquorix-amd64
</code></pre><h3 id=20-arp-ignore>20. arp-ignore</h3><p>arp-ignore should be studied</p><h3 id=21-install-vmplayer>21. Install vmplayer</h3><p>On Ubuntu or other linux distribution:</p><pre><code>$ sudo apt install build-essential linux-headers-generic
$ wget --user-agent=&quot;Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0&quot; https://www.vmware.com/go/getplayer-linux
$ chmod +x getplayer-linux
$ sudo ./getplayer-linux --required --eulas-agreed

</code></pre><h3 id=22-install-mateubuntu>22. Install mate(Ubuntu)</h3><p>via:</p><pre><code># apt  install tasksel
# tasksel install ubuntu-mate-desktop
</code></pre><h3 id=16-rpm2cpio>16. rpm2cpio</h3><p>Generating the working tar.gz files Steps:</p><pre><code># cd workingdirectory/
# cp ../kmod-ukmd-4.19.112-20212.el7.centos.src.rpm .
# rpm2cpio kmod-ukmd-4.19.112-20212.el7.centos.src.rpm| cpio -idmv
#  vim kmod.spec
Change 4.19.112-&gt;4.19.12
# rm -f kmod-ukmd-4.19.112.tar.gz 
# cp /root/rpmbuild/SOURCES/kmod-ukmd-4.19.12.tar.gz .
# mv workingdirectory/ kmod-ukmd-4.19.12.cpio
# tar czvf kmod-ukmd-4.19.12.cpio.tar.gz kmod-ukmd-4.19.12.cpio
</code></pre><h3 id=17-limit-bandwidth>17. limit bandwidth</h3><p>via:</p><pre><code>https://unix.stackexchange.com/questions/34116/how-can-i-limit-the-bandwidth-used-by-a-process
</code></pre><h3 id=18-amdgpu-centos-howto5700>18. amdgpu centos howto(5700)</h3><p>Download the rpms from:</p><pre><code>https://www.amd.com/en/support/graphics/amd-radeon-5700-series/amd-radeon-rx-5700-series/amd-radeon-rx-5700
</code></pre><p>Installation Steps:</p><pre><code>yum localinstall ./amdgpu-install-21.50.2.50002-1.el7.noarch.rpm 
# change the repo definition to something like: baseurl=https://repo.radeon.com/amdgpu/21.50.2/rhel/7.9/main/x86_64
yumdownloader dkm
rpm -i --nodeps ./dkms-3.0.3-1.el7.noarch.rpm 
yum install gcc elfutils-libelf-devel
amdgpu-install -y --usecase=graphics
# Then install graphical desktop environment, then
systemctl set-default graphical.target
</code></pre><h3 id=19-virgl-on-centos>19. virgl On CentOS</h3><p>Steps:</p><pre><code># yum -y groupinstall Development --skip-broken
# rpm -ivh /mnt/Packages/systemtap-3.3-3.el7.x86_64.rpm /mnt/Packages/systemtap-client-3.3-3.el7.x86_64.rpm /mnt/Packages/systemtap-devel-3.3-3.el7.x86_64.rpm --nodeps
# yum-builddep mesa
# wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
# yum makecache 
# yum install -y meson

</code></pre><p>Then:</p><pre><code>yum-builddep libvirt
</code></pre><h3 id=20-amd-driver-in-ubuntu>20. amd driver in ubuntu</h3><p>Get the deb and Install via:</p><pre><code>sudo apt-get install ./amdgpu-install_21.50.2.50002-1_all.deb
dpkg --add-architecture i386
amdgpu-install -y --usecase=graphics
</code></pre><h3 id=21-zen-kernel-in-ubuntu>21. zen kernel in ubuntu</h3><p>Install via:</p><pre><code>sudo add-apt-repository ppa:damentz/liquorix &amp;&amp; sudo apt-get update
64-bit:
sudo apt-get install linux-image-liquorix-amd64 linux-headers-liquorix-amd64
</code></pre><h3 id=22-convert--vdi-to-img>22. convert vdi to img</h3><p>via:</p><pre><code>root@lucky:/home/dash# cd /home/dash/manjavoLinux/
root@lucky:/home/dash/manjavoLinux# VBoxManage clonehd --format RAW manjavoLinux.vdi manjaro.img
0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%
Clone medium created in format 'RAW'. UUID: 8187b47d-86bb-4156-9996-48e921a53e7
</code></pre><h3 id=23-ssh-push-to-github>23. ssh push to github</h3><p>via adding following to <code>~/.ssh/config</code>:</p><pre><code>Host github.com
        Hostname ssh.github.com
        Port 443

</code></pre><h3 id=24-disable-gdm-sleeping>24. Disable gdm sleeping</h3><p>via:</p><pre><code>sudo -u gdm dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'

</code></pre><h3 id=25-last-crash-log>25. last crash log</h3><p>via:</p><pre><code>journalctl --since=today

</code></pre><h3 id=26-check-virt-host>26. check virt host</h3><p>via:</p><pre><code># virt-host-validate qemu
  QEMU: Checking if device /dev/kvm exists                                   : PASS
  QEMU: Checking if device /dev/kvm is accessible                            : PASS
  QEMU: Checking if device /dev/vhost-net exists                             : PASS
  QEMU: Checking if device /dev/net/tun exists                               : PASS
  QEMU: Checking for cgroup 'cpu' controller support                         : PASS
  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS
  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS
  QEMU: Checking for cgroup 'memory' controller support                      : PASS
  QEMU: Checking for cgroup 'devices' controller support                     : PASS
  QEMU: Checking for cgroup 'blkio' controller support                       : PASS
WARN (Unknown if this platform has IOMMU support)
  QEMU: Checking for secure guest support                                    : WARN (Unknown if this platform has Secure Guest support)

</code></pre><h3 id=27-file-belongs-to-apk>27. file belongs to apk</h3><p>via:</p><pre><code>$ apt-file search filename
</code></pre><h3 id=28-screenshot>28. screenshot</h3><p>via:</p><pre><code>xwd -root -out screenshot.xwd
</code></pre><h3 id=29-build-ampere-kernel>29. build ampere kernel</h3><p>Steps:</p><pre><code>unzip ampere-lts-kernel-linux-5.4.y.zip 
cd ampere-lts-kernel-linux-5.4.y/
cp arch/arm64/configs/altra_5.4_defconfig .config
make olddefconfig
make menuconfig
make -j128 deb-pkg LOCALVERSION=-amp54-lts

</code></pre><p>But the kernel boot failed and let the system hang.</p><h3 id=30-virtio-gpu-on-arm>30. virtio-gpu On Arm</h3><p>Via following command:</p><pre><code>DISPLAY=:61 qemu-system-aarch64  -M virt-4.2 -machine gic-version=max -m 15192M -enable-kvm -cpu host -smp 8,sockets=1,cores=8,threads=1   \
	-netdev user,id=vnet,hostfwd=:127.0.0.1:2278-:22,hostfwd=tcp::5555-:5555,hostfwd=tcp::5556-:5556,hostfwd=tcp::5557-:5557,hostfwd=tcp::5800-:5800,hostfwd=tcp::3389-:3389,hostfwd=tcp::14000-:4000 -device virtio-net-pci,netdev=vnet \
	-drive file=ubuntu-image.img,if=none,id=drive0,cache=writeback -device virtio-blk,drive=drive0,bootindex=0 -display gtk,gl=on  \
	-drive file=ubuntu-20.04.3-live-server-arm64.iso,if=none,id=drive1,cache=writeback -device virtio-blk,drive=drive1,bootindex=1 \
	-drive file=flash0.img,format=raw,if=pflash -drive file=flash1.img,format=raw,if=pflash  -vga none -device virtio-gpu-pci,virgl=on -usb  -device usb-ehci,id=ehci -device usb-mouse -device usb-kbd
</code></pre><h3 id=31-manually-add-pool>31. Manually add pool</h3><p>Via:</p><pre><code> virsh pool-create-as --name sda --type dir --target /media/sda/images
</code></pre><h3 id=32-no-machine-issue>32. no-machine issue</h3><p>Change the configuration then restart the service, needn&rsquo;t confirm on logged session:</p><pre><code>grep DesktopAuthorization /usr/NX/etc/server.cfg
sudo /etc/NX/nxserver --restart


</code></pre><h3 id=33-centos-8-docker-installation>33. centos 8 docker installation</h3><p>via:</p><pre><code># dnf remove -y podman
# REPO=https://mirrors.aliyun.com/docker-ce
# dnf config-manager --add-repo $REPO/linux/centos/docker-ce.repo
# sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
# sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
# yum update
# dnf install --allowerasing -y containerd.io docker-ce docker-ce-cli
# docker -v
</code></pre><h3 id=34-before-build-aosp>34. before build aosp</h3><p>via:</p><pre><code>apt install openssh-server screen  git openjdk-8-jdk android-tools-adb bc bison build-essential curl flex g++-multilib gcc-multilib gnupg gperf imagemagick lib32ncurses-dev lib32readline-dev lib32z1-dev  liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc yasm zip zlib1g-dev libtinfo5 libncurses5

</code></pre><h3 id=35-install-golang-for-ubuntu2004>35. Install golang for ubuntu20.04</h3><p>via:</p><pre><code>sudo add-apt-repository ppa:longsleep/golang-backports 
sudo apt update
sudo apt install golang-go
</code></pre><h3 id=36-ubuntu-driver-install>36. Ubuntu driver install</h3><p>via:</p><pre><code>$ ubuntu-drivers devices
== /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0 ==
modalias : pci:v000010DEd00001287sv00001642sd00003F86bc03sc00i00
vendor   : NVIDIA Corporation
model    : GK208B [GeForce GT 730]
driver   : nvidia-driver-390 - distro non-free
driver   : nvidia-driver-470-server - distro non-free
driver   : nvidia-driver-450-server - distro non-free
driver   : nvidia-driver-418-server - distro non-free
driver   : nvidia-driver-470 - distro non-free recommended
driver   : xserver-xorg-video-nouveau - distro free builtin
$ sudo ubuntu-drivers autoinstall
</code></pre><h3 id=37-cuttlefish-render-mode>37. cuttlefish render mode</h3><p>via:</p><pre><code># launch_cvd --gpu-mode=drm_virgl
# launch_cvd --gpu-mode=gfxstream
</code></pre><h3 id=38-forward-to-vm>38. forward to vm</h3><p>via iptables:</p><pre><code># iptables -I FORWARD -o virbr1 -d 10.17.18.2 -j ACCEPT
# iptables -t nat -I PREROUTING -p tcp --dport 2422 -j DNAT --to 10.17.18.2:22
</code></pre><h3 id=39-recompile-ubuntu-linux>39. Recompile Ubuntu Linux</h3><p>via:</p><pre><code>Clone the repo:

 git clone git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/focal
Checkout the branch:

 cd focal
 git checkout origin/hwe-5.8
If you want to disable the nvidia driver, add this patch:

diff --git a/debian/rules b/debian/rules
index 8c3c71a..8742713 100755
--- a/debian/rules
+++ b/debian/rules
@@ -100,6 +100,8 @@ ifeq ($(do_mainline_build),true)
        skipretpoline=true
 endif
 
+do_dkms_nvidia=false
+
 # Disable tools build and packaging if do_tools != true
 ifneq ($(do_tools),true)
        do_linux_tools=
Install the build dependencies:

 sudo apt-get build-dep linux
Build the kernel:

 fakeroot debian/rules clean
 fakeroot debian/rules binary-headers binary-generic
</code></pre><h3 id=40-iptables-forbid-only-one-ip>40. iptables forbid only one ip</h3><p>only one ip to specific port running ss server via:</p><pre><code>sudo iptables -I INPUT \! --src 121.8.254.210 -m tcp -p tcp --dport 1080 -j DROP
</code></pre><h3 id=41-yarn-issue>41. yarn issue</h3><p>via:</p><pre><code>sudo apt remove cmdtest
sudo apt remove yarn
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo &quot;deb https://dl.yarnpkg.com/debian/ stable main&quot; | sudo tee /etc/apt/sources.list.d/yarn.list
sudo apt-get update
sudo apt-get install yarn -y
then

yarn install
</code></pre><h3 id=42-efi-grub-issue>42. efi grub issue</h3><p>via:</p><pre><code>#GRUB_DEFAULT=0
GRUB_DEFAULT=&quot;Advanced options for Ubuntu&gt;Ubuntu, with Linux 5.11.0-46-generic&quot;
#GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT_STYLE=menu
GRUB_TIMEOUT=10
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT=&quot;&quot;
GRUB_CMDLINE_LINUX=&quot;&quot;
</code></pre><h3 id=43-disable-auto-update-ubuntu>43. disable auto-update ubuntu</h3><p>via:</p><pre><code># vim /etc/apt/apt.conf.d/20auto-upgrades
Change content:
FROM:

APT::Periodic::Update-Package-Lists &quot;1&quot;;
APT::Periodic::Unattended-Upgrade &quot;1&quot;;
TO:

APT::Periodic::Update-Package-Lists &quot;0&quot;;
APT::Periodic::Download-Upgradeable-Packages &quot;0&quot;;
APT::Periodic::AutocleanInterval &quot;0&quot;;
APT::Periodic::Unattended-Upgrade &quot;1&quot;
</code></pre><p>Then:</p><pre><code>systemctl stop apt-daily.timer;systemctl disable apt-daily.timer ; systemctl stop apt-daily-upgrade.timer ; systemctl disable apt-daily-upgrade.timer; systemctl stop apt-daily.service;  systemctl mask apt-daily.service; systemctl daemon-reload
systemctl stop unattended-upgrades.service &amp;&amp; systemctl disable unattended-upgrades.service
</code></pre><h3 id=44-start-redroid>44. start redroid</h3><p>command:</p><pre><code>sudo docker run -itd --name redroid9 --memory-swappiness=0 --privileged   -p 5556:5555 redroid:9officialhoudini redroid.fps=120 ro.sf.lcd_density=240 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128 ro.sf.lcd_density=240 redroid.width=1080 redroid.height=1920

</code></pre><h3 id=45-upgrade-kernel>45. Upgrade Kernel</h3><p>In centos via:</p><pre><code># 查看可用内核版本及启动顺序
$ sudo awk -F\' '$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}' /boot/grub2/grub.cfg

# 查看启动顺序
$ yum install -y grub2-pc
$ grub2-editenv list

# 设置开机启动
$ grub2-set-default 0
或者
$ grub2-mkconfig -o /boot/grub2/grub.cfg

# 重启生效
$ reboot

# 重启后查看内核版本
$ uname -sr
</code></pre><h3 id=46-print-photos>46. print photos</h3><p>via:</p><p><code>https://www.phoyosystem.com/photo-booth-software/#the-id-photos-printing-tool-only</code></p><h3 id=47-untar-deb>47. untar deb</h3><p>command:</p><pre><code>mkdir tmp
dpkg-deb -R abcde.deb  tmp
</code></pre><h3 id=48-linux-zen-for-archlinux>48. linux-zen for ArchLinux</h3><p>Build via:</p><pre><code># vim trunk/config
Added something.
# makepkg --skipinteg --syncdeps
</code></pre><p>Install via:</p><pre><code># sudo pacman -U linux-zen-5.19.zen1-1-x86_64.pkg.tar.zst linux-zen-headers-5.19.zen1-1-x86_64.pkg.tar.zst linux-zen-docs-5.19.zen1-1-x86_64.pkg.tar.zst
# sudo grub-mkconfig -o /boot/grub/grub.cfg
# sudo reboot
</code></pre><p>Verify its kernel version:</p><pre><code># uname -r
</code></pre><h3 id=49-disable-gdm-sleep>49. disable gdm sleep</h3><p>via:</p><pre><code>sudo -u gdm dbus-launch gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'
</code></pre><h3 id=50-redroid-12-issue>50. redroid 12 issue</h3><p>on linux-zen kernel, 5.19, should enter the adb shell and run:</p><pre><code>setprop sys.use_memfd 1
</code></pre><h3 id=51-archlinux-configuration-ip>51. ArchLinux Configuration IP</h3><p>via:</p><pre><code>ip addr add 10.17.18.3/24 dev enp1s0
ip link set enp1s0 up
ip route add default via 10.17.18.1 dev enp1s0
Then set resolv.conf
</code></pre><h3 id=52-ubuntu-install-zen-kernel>52. ubuntu install zen kernel</h3><p>via:</p><pre><code>sudo add-apt-repository ppa:damentz/liquorix &amp;&amp; sudo apt-get update
sudo apt-get install linux-image-liquorix-amd64 linux-headers-liquorix-amd64
</code></pre><h3 id=53-ipmi-reset-lan>53. ipmi reset lan</h3><p>via:</p><pre><code>ipmitool raw 0x32 0x76 0x08
</code></pre><h3 id=53-efi-grub-recover>53. efi grub recover</h3><p>Type <code>normal</code> after you insert following commands:</p><p><img src=/images/2022_08_18_09_26_33_688x238.jpg alt=/images/2022_08_18_09_26_33_688x238.jpg></p><p>normal boot will get you into the normal boot:</p><p><img src=/images/2022_08_18_09_27_08_815x579.jpg alt=/images/2022_08_18_09_27_08_815x579.jpg></p><h3 id=54-ubuntu-vfio-sg1>54. Ubuntu vfio sg1</h3><p>commands:</p><pre><code>docker run -itd --name redroidkkk --memory-swappiness=0 --privileged   -p 5555:5555 redroid12:latest redroid.fps=120 ro.sf.lcd_density=240 redroid.width=1080 redroid.height=1920 redroid.gpu.mode=host redroid.gpu.node=/dev/dri/renderD128 androidboot.use_memfd=1

</code></pre><p>Upgrade ubuntu mesa drivers:</p><pre><code>sudo add-apt-repository ppa:oibaf/graphics-drivers
sudo apt update
sudo apt upgrade
</code></pre><h3 id=55-build-linux-zen>55. Build linux-zen</h3><p>via:</p><pre><code>sudo INSTALL_MOD_STRIP=1 CONCURRENCY_LEVEL=X fakeroot make-kpkg --initrd kernel_image kernel_headers -j 16
</code></pre><h3 id=56-find-pkg-in-archlinux>56. find pkg in archlinux</h3><p>via:</p><pre><code># pacman -Fy
# pacman -F genfstab(get the pkg which provides genfstab)
</code></pre><h3 id=57-qemu-nbd>57. qemu-nbd</h3><p>via:</p><pre><code>modprobe nbd max_part=8

Step 2 - Connect the QCOW2 as a network block device

qemu-nbd --connect=/dev/nbd0 /var/lib/vz/images/100/vm-100-disk-1.qcow2
Step 3 - List partitions inside the QCOW2

fdisk /dev/nbd0 -l
Step 4 - Mount the partition from the VM

mount /dev/nbd0p1 /mnt/somepoint/
You can also mount the filesystem with normal user permissions, ie. non-root:

mount /dev/nbd0p1 /mnt/somepoint -o uid=$UID,gid=$(id -g)
Step 5 - After you're done, unmount and disconnect

umount /mnt/somepoint/
qemu-nbd --disconnect /dev/nbd0
rmmod nbd
</code></pre><h3 id=58-arm64-mesa-upgrade>58. arm64 mesa upgrade</h3><p>checked via:</p><pre><code># dpkg -l | grep -i mesa
ii  libegl-mesa0:arm64                            21.2.6-0ubuntu0.1~20.04.2             arm64        free implementation of the EGL API -- Mesa vendor library
ii  libgl1-mesa-dri:arm64                         21.2.6-0ubuntu0.1~20.04.2             arm64        free implementation of the OpenGL API -- DRI modules
ii  libglapi-mesa:arm64                           21.2.6-0ubuntu0.1~20.04.2             arm64        free implementation of the GL API -- shared library
ii  libglu1-mesa:arm64                            9.0.1-1build1                         arm64        Mesa OpenGL utility library (GLU)
ii  libglx-mesa0:arm64                            21.2.6-0ubuntu0.1~20.04.2             arm64        free implementation of the OpenGL API -- GLX vendor library
ii  mesa-utils                                    8.4.0-1build1                         arm64        Miscellaneous Mesa GL utilities
ii  mesa-va-drivers:arm64                         21.2.6-0ubuntu0.1~20.04.2             arm64        Mesa VA-API video acceleration drivers
ii  mesa-vdpau-drivers:arm64                      21.2.6-0ubuntu0.1~20.04.2             arm64        Mesa VDPAU video acceleration drivers
ii  mesa-vulkan-drivers:arm64                     21.2.6-0ubuntu0.1~20.04.2             arm64        Mesa Vulkan graphics drivers

</code></pre><p>Upgrade to <code>oibaf</code>:</p><h3 id=59-print-message-of-last-boot>59. print message of last boot</h3><p>via:</p><pre><code> journalctl --boot=-1
</code></pre><h3 id=60-new-xorg-configure>60. new xorg configure</h3><p>via:</p><pre><code>Xorg -configure
cat /root/xorg.conf.new | grep -i busid
</code></pre><h3 id=61-build-glmark2-on-centos7>61. build glmark2 on centos7</h3><p>Steps:</p><pre><code>$ git clone https://github.com/glmark2/glmark2.git

$  INSTALL_APP =&quot;epel-release centos-release-scl hwdata libX11 libX11-common libXau libXdamage libudev-devel \
libXext libXfixes libXxf86vm libdrm libjpeg-turbo libpciaccess libpng12 libxcb libxshmfence mesa-libEGL \
mesa-libGL mesa-libGLES mesa-libgbm mesa-libglapi libXmu-devel libXi-devel libGL-devel libjpeg-turbo-devel \
libpng12-devel mesa-libEGL-devel mesa-libGLES mesa-libgbm-devel mesa-libGLES-devel mesa-dri-drivers \
devtoolset-4-toolchain&quot;

$  flag=1; for pkg in $INSTALL_APP; do echo &quot;INFO: installing $flag package $pkg ...&quot;; yum install -y &quot;$pkg&quot; &amp;&gt; /dev/null || echo -e &quot;\tERROR: cannot install $pkg ....&quot;; flag=$((flag+1)); done
$ PATH=&quot;/opt/rh/devtoolset-4/root/bin:$PATH&quot;
$  ./waf configure --with-flavors=&quot;drm-gl,drm-glesv2,x11-gl,x11-glesv2&quot;
$ ./waf  -v
$ ./waf install

$ glmark2
=======================================================
    glmark2 2017.07
=======================================================
    OpenGL Information
    GL_VENDOR:     Intel Open Source Technology Center
    GL_RENDERER:   Mesa DRI Intel(R) Haswell Mobile 
    GL_VERSION:    3.0 Mesa 17.0.1
=======================================================
[build] use-vbo=false: FPS: 2567 FrameTime: 0.390 ms
=======================================================
                                  glmark2 Score: 2567 
=======================================================
</code></pre><p>change the <code>devtoolset-4</code> to <code>devtoolsset-8</code>.</p><h3 id=62-nvidia-smi-slow-on-ampere-1804>62. nvidia-smi slow on ampere 1804</h3><p>solved via:</p><pre><code>sudo nvidia-persistenced --persistence-mode

</code></pre><h3 id=63-minimum-xorg>63. minimum xorg</h3><p>installed via:</p><pre><code>apt install -y xserver-xorg-core
</code></pre><h3 id=64-repo-init-aosp_master>64. repo init aosp_master</h3><p>via:</p><pre><code>repo init -u git://mirrors.ustc.edu.cn/aosp/platform/manifest -b master
repo sync -j4
</code></pre><h3 id=65-git-search>65. git search</h3><p>search the commit via somebody:</p><pre><code>git log --author='intel.com' --all --grep='SRIOV'

</code></pre><h3 id=66-lspci-tree-view>66. lspci tree view</h3><p>via:</p><pre><code>$ lspci -tvv
</code></pre><h3 id=67-disable-lock-in-gnome>67. disable lock in gnome</h3><p>via:</p><pre><code>Found couple of ways finally.
First method : is to run in terminal the command

gsettings set org.gnome.desktop.lockdown disable-lock-screen true
That should remove the lock option from the tray. And it can be re-ebabled using reset instead of set in the same command and removing true attribute

gsettings reset org.gnome.desktop.lockdown disable-lock-screen
</code></pre><h3 id=68-android-sdk-on-aarch64>68. android sdk on aarch64</h3><p>Steps:</p><pre><code>docker run -d -p 5901:5901 -p 2222:22 android-sdk:latest
c38e2d3b3a730b34dc40dc632aa5fa7c6cd32f0631c18d3a965671f1d8115aa1
root@feiteng:/home/ctctest# docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED         STATUS        PORTS                                                                                        NAMES
c38e2d3b3a73   android-sdk:latest   &quot;/usr/bin/supervisord&quot;   2 seconds ago   Up 1 second   5037/tcp, 0.0.0.0:5901-&gt;5901/tcp, :::5901-&gt;5901/tcp, 0.0.0.0:2222-&gt;22/tcp, :::2222-&gt;22/tcp   mystifying_sammet
root@feiteng:/home/ctctest# docker exec -it c38e2d3b3a73 bash
root@c38e2d3b3a73:/# JAVA_HOME=/usr/lib/jvm/java-1
java-1.11.0-openjdk-arm64/ java-11-openjdk-arm64/     
root@c38e2d3b3a73:/# JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64/
root@c38e2d3b3a73:/# sdkmanager
[=======================================] 100% Computing updates...             
root@c38e2d3b3a73:/# cd /opt/
android-sdk/         gradle/              kotlinc/             license_accepter.sh  
root@c38e2d3b3a73:/# cd /opt/android-sdk/
root@c38e2d3b3a73:/opt/android-sdk# ls
cmdline-tools  licenses
root@c38e2d3b3a73:/opt/android-sdk# sdkmanager  &quot;platform-tools&quot;
[=======================================] 100% Unzipping... platform-tools/lib64
root@c38e2d3b3a73:/opt/android-sdk# sdkmanager &quot;platforms;android-31&quot;
[=======================================] 100% Unzipping... android-12/framework

Copy from host to docker:  

root@feiteng:/home/ctctest/20220915# docker cp arm64-v8a c38e2d3b3a73:/opt/android-sdk/system-images/android-31/default &amp;&amp; docker cp emulator c38e2d3b3a73:/opt/android-sdk/
</code></pre><p>More readable:</p><pre><code>root@feiteng:/home/ctctest# docker run --name emukvm -d -p 5901:5901 -p 2222:22  --privileged android-sdk:latest
16369be79d70267f1546d0937dd23c1693339f88cc4562624fe5d38b63ead65b
root@feiteng:/home/ctctest# docker exec -it emukvm bash
root@16369be79d70:/# JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64/
root@16369be79d70:/# sdkmanager  &quot;platform-tools&quot;; sdkmanager &quot;platforms;android-31&quot;
[=======================================] 100% Unzipping... platform-tools/lib64
[=======================================] 100% Unzipping... android-12/framework
root@16369be79d70:/# mkdir -p /opt/android-sdk/system-images/android-31/default

宿主机拷贝相关文件到sdk目录下
docker cp arm64-v8a emukvm:/opt/android-sdk/system-images/android-31/default &amp;&amp; docker cp emulator emukvm:/opt/android-sdk


root@16369be79d70:/#  emulator @test -no-audio -no-boot-anim -no-window -gpu swiftshader_indirect -qemu -cpu max -machine gic-version=max

root@16369be79d70:/#  adb shell

emulator64_arm64:/ $ getprop | grep boot | grep com                                                      
[dev.bootcomplete]: [1]
[sys.boot_completed]: [1]
[sys.bootstat.first_boot_completed]: [1]

</code></pre><p>For demo:</p><pre><code>$ sudo docker load&lt;android-sdk-vnc-preinstalled.tar
af52716c484c: Loading layer [==================================================&gt;]   68.1MB/68.1MB
6deb56f0ac41: Loading layer [==================================================&gt;]  6.656kB/6.656kB
2a1d4f03ee1e: Loading layer [==================================================&gt;]  837.8MB/837.8MB
1e7efcf3f6fb: Loading layer [==================================================&gt;]  128.8MB/128.8MB
8a505bac510d: Loading layer [==================================================&gt;]   77.7MB/77.7MB
b9e87b8a4eac: Loading layer [==================================================&gt;]  119.8MB/119.8MB
d51220053622: Loading layer [==================================================&gt;]  4.096kB/4.096kB
59258b7d9f06: Loading layer [==================================================&gt;]  5.632kB/5.632kB
4004735b3e24: Loading layer [==================================================&gt;]  3.072kB/3.072kB
44761079232a: Loading layer [==================================================&gt;]  4.096kB/4.096kB
e70a6e71fc4d: Loading layer [==================================================&gt;]  10.75kB/10.75kB
57a11ab28048: Loading layer [==================================================&gt;]  3.584kB/3.584kB
102d57c5928f: Loading layer [==================================================&gt;]   2.56kB/2.56kB
ea5ffb5cc89c: Loading layer [==================================================&gt;]  40.02MB/40.02MB
d6f2e48784b2: Loading layer [==================================================&gt;]  3.584kB/3.584kB
6751e3b147f7: Loading layer [==================================================&gt;]   2.56kB/2.56kB
28c073eff8d4: Loading layer [==================================================&gt;]  3.584kB/3.584kB
6b084044ff11: Loading layer [==================================================&gt;]  3.584kB/3.584kB
b35e2fb65592: Loading layer [==================================================&gt;]  137.5MB/137.5MB
9fef29544a2a: Loading layer [==================================================&gt;]  9.602GB/9.602GB
Loaded image: android-sdk-vnc-preinstalled:latest
$ sudo docker run --name emukvm -d -p 5901:5901 -p 2222:22  --privileged android-sdk-vnc-preinstalled:latest
5699cd1823fbf54457b844513f2a2a77e7f252afbd1e15bea2fda4cb50ca3d2a
$ sudo docker ps

</code></pre><h3 id=69-remount-in-single-user>69. remount in single user</h3><p>via:</p><pre><code>mount -o ro,remount /
Then you could do passwd or other staffs. 

</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2021/12/29/workingtipsonandroiddocker2/>WorkingTipsOnAndroidDocker2</a></h1><span class=post-date>Dec 29, 2021<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=目的>目的</h3><p>记录aosp avd 11上启动容器的操作事项.</p><h3 id=步骤>步骤</h3><p>因为内核经过修改，故启动的时候需要点击<code>ok</code>后进入系统:</p><p><img src=/images/2021_12_29_11_56_51_356x415.jpg alt=/images/2021_12_29_11_56_51_356x415.jpg></p><p>确保wifi连接:</p><p><img src=/images/2021_12_29_11_58_07_347x482.jpg alt=/images/2021_12_29_11_58_07_347x482.jpg></p><p>进入到adb shell:</p><pre><code>$ adb root
restarting adbd as root
$ adb shell
generic_x86_64:/ # ip addr
</code></pre><p>添加路由规则:</p><pre><code>ip rule add pref 1 from all lookup main
ip rule add pref 2 from all lookup default
ip route add default via 192.168.91.254 dev wlan0
ip rule add from all lookup main pref 30000
</code></pre><p>启动dockerd进程:</p><pre><code>dockerd  --dns=223.5.5.5 --data-root=/data/var/ --ip=192.168.89.153 &amp; &gt;/data/dockerd-logfile 2&gt;&amp;1
</code></pre><p>启动docker:</p><pre><code># docker run -d --privileged -p 8888:5555 redroid/redroid:8.1.0-latest
# docker run -d --privileged -p 8888:5555 redroid/redroid:9.0.0-latest
# docker run -d --privileged -p 8888:5555 redroid/redroid:10.0.0-latest
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2021/12/23/androidinaosp11avdworkingtips/>AndroidInAosp11AVDWorkingTips</a></h1><span class=post-date>Dec 23, 2021<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=0-目的>0. 目的</h3><p>本文目的是为了记录如何在基于aosp11的avd开启redroid容器实例。</p><h3 id=1-准备aosp源码并运行avd>1. 准备aosp源码并运行avd</h3><p>下载tsinghua的repo用于同步代码, 由于repo需要使用python3来同步代码，故需要安装<code>python-is-python3</code>包:</p><pre><code>$ curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
$ chmod a+x repo
$ sudo apt-get install -y python-is-python3
</code></pre><p>repo的运行过程中会尝试访问官方的git源更新自己，指定使用tuna的镜像源进行更新:</p><pre><code>$ vim ~/.bashrc
export REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo'
</code></pre><p>创建目录并开始同步代码(具体时间取决于网络状态), 如果需要同步别的分支的源码，可以参考这里(<code>https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds</code>):</p><pre><code>$ mkdir aosp11
$ cd aosp11
$ repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-11.0.0_r48
$ repo sync -j8
</code></pre><p>安装需要的依赖:</p><pre><code>$ sudo apt-get install -y libncurses5
$ sudo apt-get install openjdk-8-jdk
$ sudo apt-get install git-core gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache libgl1-mesa-dev libxml2-utils xsltproc unzip
</code></pre><p>更改aosp11源代码，在<code>build/target/product/AndroidProducts.mk</code>中加入关于编译时<code>lunch</code>的选项并开始编译:</p><pre><code>COMMON_LUNCH_CHOICES := \
.......
     sdk_phone_x86_64-userdebug \
</code></pre><p>开始编译源码:</p><pre><code>$ m -j120
</code></pre><p>看到下面类似的画面代表编译成功:</p><p><img src=/images/2021_12_24_09_47_41_564x156.jpg alt=/images/2021_12_24_09_47_41_564x156.jpg></p><p>在当前目录下运行<code>emulator</code>可以直接打开模拟器:</p><p><img src=/images/2021_12_24_09_50_39_527x644.jpg alt=/images/2021_12_24_09_50_39_527x644.jpg></p><p>指定分区大小及内存大小:</p><pre><code>$ emulator -partition-size 61240 -qemu -cpu host -m 16535M
</code></pre><p>登入模拟器shell的方法:</p><pre><code>$ adb root
$ adb shell
generic_x86_64:/ # exit
</code></pre><h3 id=2-编译aosp-11内核并集成至avd>2. 编译aosp 11内核并集成至avd</h3><p>上传内核参数检测脚本以获取当前内核运行docker缺失参数：</p><pre><code>$ adb push check-config.sh /data
check-config.sh: 1 file pushed. 1.4 MB/s (11990 bytes in 0.008s)
$ adb shell
generic_x86_64:/ # chmod 777 /data/check-config.sh
generic_x86_64:/ # /data/check-config.sh
</code></pre><p>类似如下:</p><p><img src=/images/2021_12_24_14_26_49_358x314.jpg alt=/images/2021_12_24_14_26_49_358x314.jpg></p><p>主机上获取内核树:</p><pre><code>$BRANCH=common-android11-5.4-lts
$ROOTDIR=AVD-kernel-$BRANCH
$mkdir $ROOTDIR &amp;&amp; cd $ROOTDIR
$which repo
$repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b $BRANCH &amp;&amp; repo sync --force-sync --no-clone-bundle --no-tags -j$(nproc)
$ ls
build  common  common-modules  hikey-modules  kernel  prebuilts  prebuilts-master  repo  tools
</code></pre><p>配置内核:</p><pre><code>$ BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
FRAGMENT_CONFIG=common/arch/x86/configs/gki_defconfig \
build/config.sh
</code></pre><p>将出现以下界面:</p><p><img src=/images/2021_12_24_14_43_28_555x562.jpg alt=/images/2021_12_24_14_43_28_555x562.jpg></p><p>按照前面内核检测时docker所缺失参数的情况，依次打开所需开启的内核选项.</p><pre><code>Generic setup -&gt; POSIX Message Queues
Generic setup -&gt; Controller Group support -&gt; PIDs controller
Generic setup -&gt; Controller Group support -&gt; Device controller
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; Group sheduling for SCHED_OTHER
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; CPU bandwidth provisioning for FAIR-GROUP_SCHED
Generic setup -&gt; Controller Group support -&gt; CPU controller -&gt; Group sheduling for SCHED_RR/FIFO
Generic setup -&gt; Controller Group support -&gt; Perf controller
Generic setup -&gt; Namespaces support -&gt; User namespace
Generic setup -&gt; Namespaces support -&gt; PID namespace
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Bridged IP/ARP packets fiiltering
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; IP virtual server support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;addrtype&quot; address type match support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;control group&quot; address type match support
Networking support -&gt; Networking options -&gt; Network packet filtering framework (Netfilter) -&gt; Core Netfilter configuration -&gt;  &quot;control group&quot; address type match support
File Systems -&gt; Overlay filesystem support
</code></pre><p>其中<code>Overlay filesystems suppport</code>的配置如下:</p><p><img src=/images/2021_12_24_15_02_04_681x191.jpg alt=/images/2021_12_24_15_02_04_681x191.jpg></p><p>编译内核:</p><pre><code>$ BUILD_CONFIG=common-modules/virtual-device/build.config.goldfish.x86_64 \
build/build.sh -j$(nproc)
</code></pre><p>拷贝内核及内核模块至安卓源码树下并重新编译安卓镜像:</p><pre><code>$ cd prebuilts/qemu-kernel/x86_64/
$ mv 5.4 5.4back
$ mkdir -p 5.4/ko
$ cp /media/sdb/aosp11kernel/AVD-kernel-common-android11-5.4-lts/out/android11-5.4/dist/bzImage kernel-qemu2
$ cp /media/sdb/aosp11kernel/AVD-kernel-common-android11-5.4-lts/out/android11-5.4/dist/*.ko ./ko
$ cd ../../../../
$ m -j80
$ emulator
</code></pre><p>重新启动后的界面中启动会出现报错，点OK忽略:</p><p><img src=/images/2021_12_24_15_12_39_335x346.jpg alt=/images/2021_12_24_15_12_39_335x346.jpg></p><p>重新检测后，大部分参数会就绪，cgroupv2下的某些参数会显示红色，但不妨碍使用:</p><p><img src=/images/2021_12_24_15_14_13_304x219.jpg alt=/images/2021_12_24_15_14_13_304x219.jpg></p><h3 id=3-aosp11更改合并docker>3. aosp11更改/合并docker</h3><p>下载<code>docker-20.10.8</code>二进制版本并解压到aosp源码下:</p><pre><code>$ wget https://download.docker.com/linux/static/stable/x86_64/docker-20.10.8.tgz
// 切换到安卓源码下
$ cd prebuilts
$ tar xzvf ~/docker-20.10.8.tgz -C .
</code></pre><p>添加docker打包到system.img中的方式如下，将docker二进制文件添加到<code>/system/bin</code>中以便开箱即用:</p><pre><code>$ vim  ./build/make/target/board/generic_x86_64/device.mk
// 文件末尾添加
PRODUCT_COPY_FILES += \
    prebuilts/docker/containerd:system/bin/containerd \
    prebuilts/docker/containerd-shim:system/bin/containerd-shim \
    prebuilts/docker/containerd-shim-runc-v2:system/bin/containerd-shim-runc-v2 \
    prebuilts/docker/ctr:system/bin/ctr \
    prebuilts/docker/docker:system/bin/docker \
    prebuilts/docker/dockerd:system/bin/dockerd \
    prebuilts/docker/docker-init:system/bin/docker-init \
    prebuilts/docker/docker-proxy:system/bin/docker-proxy \
    prebuilts/docker/runc:system/bin/runc \
$ vim build/target/product/sdk_phone_x86_64.mk
// 文件末尾添加
PRODUCT_ARTIFACT_PATH_REQUIREMENT_ALLOWED_LIST := \
    system/bin/containerd \
    system/bin/containerd-shim \
    system/bin/containerd-shim-runc-v2 \
    system/bin/ctr \
    system/bin/docker \
    system/bin/dockerd \
    system/bin/docker-init \
    system/bin/docker-proxy \
    system/bin/runc \
</code></pre><p>更改sepolicy权限以创建docker运行时需要的路径:</p><pre><code>$ vim system/sepolicy/prebuilts/api/30.0/private/file_contexts
// 在# Symlinks下添加关于/var, /run, /system/etc/docker软链接定义
# Symlinks
/bin                u:object_r:rootfs:s0
/bugreports         u:object_r:rootfs:s0
/charger            u:object_r:rootfs:s0
/d                  u:object_r:rootfs:s0
/etc                u:object_r:rootfs:s0
/sdcard             u:object_r:rootfs:s0
/var                u:object_r:rootfs:s0
/run                u:object_r:rootfs:s0
/system/etc/docker                u:object_r:system_file:s0
$ vim system/sepolicy/private/file_contexts
// 约42行处: 
 42 /sdcard             u:object_r:rootfs:s0
 43 /var             u:object_r:rootfs:s0
 44 /run             u:object_r:rootfs:s0
 45 /system/etc/docker             u:object_r:system_file:s0
 46 
 47 # SELinux policy files
$ vim system/core/rootdir/Android.mk
// 约84行处:
83     ln -sf /system/etc $(TARGET_ROOT_OUT)/etc; \
 84     ln -sf /data/var $(TARGET_ROOT_OUT)/var; \
 85     ln -sf /data/run $(TARGET_ROOT_OUT)/run; \
 86     ln -sf /data/user_de/0/com.android.shell/files/bugreports $(TARGET_ROOT_OUT)/bugreports; 
// 约143行处:
144 # Since init.environ.rc is required for init and satisfies that requirement, we hijack it to create the symlink.
145 LOCAL_POST_INSTALL_CMD += ; ln -sf /system/bin/init $(TARGET_ROOT_OUT)/init
146 LOCAL_POST_INSTALL_CMD += ; ln -sf /data/docker $(TARGET_OUT)/etc/
147 LOCAL_POST_INSTALL_CMD += ; ln -sf /data/resolv.conf $(TARGET_OUT)/etc/resolv.conf
</code></pre><p><code>m -j 50</code>重新编译aosp镜像后，手动生成<code>/data</code>目录下所需预创建的文件后，重新生成userdataimage:</p><pre><code>$ mkdir -p out/target/product/generic_x86_64/data/run
$ mkdir -p out/target/product/generic_x86_64/data/var
$ mkdir -p out/target/product/generic_x86_64/data/docker
$ echo &quot;nameserver 223.5.5.5&quot; &gt; out/target/product/generic_x86_64/data/resolv.conf
$ make userdataimage -j50
</code></pre><p>重新启动emulator后，此时docker已经就绪了。</p><h3 id=4-启动redroid容器实例>4. 启动redroid容器实例</h3><p>手动启动dockerd进程:</p><pre><code>$ adb root
$ adb shell
# dockerd --iptables=false --dns=223.5.5.5 --data-root=/data/var/
</code></pre><p>如果需要无Log输出（后台运行模式)，可以使用以下命令:</p><pre><code># dockerd --iptables=false --dns=223.5.5.5 --data-root=/data/var/ &amp;&gt; /data/dockerd-logfile &amp;
</code></pre><p>在另一个adb shell进程里，运行以下命令, 可以看到docker正常运行:</p><pre><code># docker version
</code></pre><p>启动redroid 9版本的容器实例并检查运行情况:</p><pre><code># docker run -d --privileged  -p 15589:5555 --memory-swappiness=0 redroid/redroid:9.0.0-latest
# docker ps
CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS         PORTS                                         NAMES
a900b38c0fb1   redroid/redroid:9.0.0-latest   &quot;/init qemu=1 androi…&quot;   12 seconds ago   Up 9 seconds   0.0.0.0:15589-&gt;5555/tcp, :::15589-&gt;5555/tcp   gallant_mcclintock
# docker exec -it a900b38c0fb1 sh
# getprop | grep boot | grep complete                                         
[dev.bootcomplete]: [1]
[sys.boot_completed]: [1]
[sys.logbootcomplete]: [1]
</code></pre><h3 id=5-配置网络>5. 配置网络</h3><p>主机上配置tap0设备并桥接到br0(<code>tunctl</code> is installed via <code>apt-get install -y uml-utilities</code>):</p><pre><code>$ sudo tunctl -u intel
$ sudo brctl addif br0 tap0
$ sudo ip link set dev tap0 up
</code></pre><p>启动avd的时候使用以下参数:</p><pre><code>$ emulator -show-kernel -partition-size 61240 -net-tap tap0 -qemu -cpu host -m32768
</code></pre><p>在avd中，手动设置wifi的地址为br0同网段固态IP地址,
而后可以直接Ping通该设置的地址。</p><p>Docker启动的命令需更改为:</p><pre><code>$ dockerd --iptables=false --dns=223.5.5.5 --data-root=/data/var/ --ip=192.168.xx.xxx &amp; &gt;/data/dockerd-logfile 2&gt;&amp;1
</code></pre><p>此时接近于成功，但是仍然无法与容器实例通过转发后的adbd端口通信并截图。</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2021/12/03/usingnetworkmanagertogetherwithawesome/>UsingNetworkManagerTogetherWithAwesome</a></h1><span class=post-date>Dec 3, 2021<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=steps>Steps</h3><p>用于在Ubuntu20.04上开启awesome, 并使用NetworkManager管理网络.</p><p>安装必要的包:</p><pre><code>$ sudo apt-get install -y awesome sddm net-tools vim network-manager network-manager-gnome ifupdown
</code></pre><p>配置awesome:</p><pre><code>$ sudo cp /etc/xdg/awesome/rc.lua ~/.config/awesome/rc.lua
$ vim ~/.config/awesome/rc.lua
..........
modkey = &quot;Mod4&quot;

--- Just Run Once Programs.
function run_once(cmd)
  findme = cmd
  firstspace = cmd:find(&quot; &quot;)
  if firstspace then
    findme = cmd:sub(0, firstspace-1)
  end
  awful.util.spawn_with_shell(&quot;pgrep -u $USER -x &quot; .. findme .. &quot; &gt; /dev/null || (&quot; .. cmd .. &quot;)&quot;)
end

run_once(&quot;nm-applet &amp;&quot;)
.............
</code></pre><p>配置NetworkManager:</p><pre><code>$ sudo vim /etc/NetworkManager/NetworkManager.conf
..........
[ifupdown]
managed=true
.........
</code></pre><p>更改netplan renderer方式:</p><pre><code>$ sudo vim /etc/netplan/00-installer-config.yaml
# This is the network config written by 'subiquity'
network:
  version: 2
  renderer: NetworkManager
</code></pre><p>现在重启物理机后， 手工配置NetworkManager:</p><p><img src=/images/2021_12_03_09_18_42_276x236.jpg alt=/images/2021_12_03_09_18_42_276x236.jpg></p><p><img src=/images/2021_12_03_09_19_03_606x170.jpg alt=/images/2021_12_03_09_19_03_606x170.jpg></p><p><img src=/images/2021_12_03_09_19_29_771x342.jpg alt=/images/2021_12_03_09_19_29_771x342.jpg></p><p>检查可看到配置生效。</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/32/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/32/>32</a></li><li class="page-item active"><a class=page-link href=/page/33/>33</a></li><li class=page-item><a class=page-link href=/page/34/>34</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/245/>245</a></li><li class=page-item><a href=/page/34/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/245/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>