<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.64.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Dash &#183; Dash</title><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/poole-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-overrides.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/hyde-a.css?ref=abc124"><link rel=stylesheet href="https://purplepalmdash.github.io/css/custom-additions.css?ref=abc124"><link rel=stylesheet href=https://purplepalmdash.github.io/css/highlight/googlecode.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/docco.min.css><script type=text/javascript src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script type=text/javascript src=/js/html2canvas.js></script><script type=text/javascript>function genPostShot(){var rightNow=new Date();var imageName=rightNow.toISOString().slice(0,16).replace(/(-)|(:)|(T)/g,"");imageName+='.jpg'
html2canvas(document.getElementsByClassName('post'),{background:'#FFFFFF',onrendered:function(canvas){$('#test').attr('href',canvas.toDataURL("image/jpeg"));$('#test').attr('download',imageName);$('#test')[0].click();}});};</script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=apple-touch-icon-precomposed sizes=144x144 href="http://purplepalmdash.github.io/touch-icon-144-precomposed.png?ref=abc124"><link href="http://purplepalmdash.github.io/favicon.png?ref=abc124" rel=icon><link href=%7balternate%20%7bRSS%20application/rss+xml%20%20index%20alternate%20%20false%20false%20true%20false%20false%200%7d%20/index.xml%20http://purplepalmdash.github.io/index.xml%7d rel=alternate type=application/rss+xml title="Dash &#183; Dash"><meta name=description content><meta name=keywords content="unix,virtualization,embedded,linux"></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><img src=http://purplepalmdash.github.io/images/mylogo.jpeg alt=gravatar><h1><a href=http://purplepalmdash.github.io/>很惭愧，就做了一点微小的工作</a></h1><a href=http://purplepalmdash.github.io/><p>Dash</p></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/post/>All Posts</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/technology/>Technology</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/life/>Life</a></li><li class=sidebar-nav-item><a href=http://purplepalmdash.github.io/categories/linuxtips/>LinuxTips</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/purplepalmdash><i class="fa fa-github-square fa-3x"></i></a><a href=https://cn.linkedin.com/in/yang-feipeng-1b909319><i class="fa fa-linkedin-square fa-3x"></i></a><a href=https://plus.google.com/u/0/106572959364703833986><i class="fa fa-google-plus-square fa-3x"></i></a><a href=https://www.facebook.com/yang.feipeng><i class="fa fa-facebook-square fa-3x"></i></a><a href=https://twitter.com/dashwillfly><i class="fa fa-twitter-square fa-3x"></i></a></li></ul></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2019/03/14/usbnetworkcard/>UsbNetworkCard</a></h1><span class=post-date>Mar 14, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>Using systemd-networkd for configurating the usb network card,</p><pre><code># vim /etc/systemd/nework/10-ethusb1.link
[Match]
MACAddress=00:xx:xx:.....

[Link]
Description=USB to Ethernet Adapter
Name=ethusb1
</code></pre><p>Then configurating the ethusb1 ip address:</p><pre><code># vim /etc/systemd/network/10-ethusb1.network 
[Match]
Name=ethusb1

[Network]
Address=192.168.0.33
</code></pre><p>Reboot the computer then you could see the ethusb1 available.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2019/03/11/megacliforpartition/>MegaCliForPartition</a></h1><span class=post-date>Mar 11, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=目的>目的</h3><p>分区，以便虚拟化场合.</p><p>硬件:24块硬盘，前两块做成系统盘，其他的则是单独配置:</p><p><img src=/images/2019_03_11_09_13_41_447x495.jpg alt=/images/2019_03_11_09_13_41_447x495.jpg></p><h3 id=查看现有分区>查看现有分区</h3><p>使用以下命令查看当前分区的情况:</p><pre><code># ./MegaCli64 -PDList -aAll | more
</code></pre><p>注意记录下有关磁盘情形，如:</p><p><img src=/images/2019_03_11_09_20_11_473x516.jpg alt=/images/2019_03_11_09_20_11_473x516.jpg></p><p>Slot
Number应该是升序的，0-23是SATA盘，38/39是SAS盘，记录下这一组数值，因为后面我们会针对这些值来分区。Slot Number是0</p><p>查看raid信息:</p><pre><code># ./MegaCli64 -LDInfo -Lall -aAll
</code></pre><p><img src=/images/2019_03_11_09_47_56_721x783.jpg alt=/images/2019_03_11_09_47_56_721x783.jpg></p><p>除了virtual driver 0, 其他的都需要被删除。</p><p>貌似是有问题的，先装proxmox再操作。</p><h3 id=raid卡配置>Raid卡配置</h3><p>F2, 弹出配置:</p><p><img src=/images/2019_03_11_10_01_08_684x418.jpg alt=/images/2019_03_11_10_01_08_684x418.jpg></p><p>Delete Drive Group:</p><p><img src=/images/2019_03_11_10_01_32_466x309.jpg alt=/images/2019_03_11_10_01_32_466x309.jpg></p><p>最后情况:</p><p><img src=/images/2019_03_11_10_03_06_597x376.jpg alt=/images/2019_03_11_10_03_06_597x376.jpg></p><h3 id=分区>分区</h3><p>脚本如下， 4组，而后为热备4个：</p><pre><code>./MegaCli64 -CfgLdAdd -r5 [0:0,0:1,0:2,0:3,0:4] WB Direct -a0
./MegaCli64 -CfgLdAdd -r5 [0:5,0:6,0:7,0:8,0:9] WB Direct -a0
./MegaCli64 -CfgLdAdd -r5 [0:10,0:11,0:12,0:13,0:14] WB Direct -a0
./MegaCli64 -CfgLdAdd -r5 [0:15,0:16,0:17,0:18,0:19] WB Direct -a0
./MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[0:20] -a0
./MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[0:21] -a0
./MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[0:22] -a0
./MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[0:23] -a0
</code></pre></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2019/03/08/bootupsequence/>BootUpSequence</a></h1><span class=post-date>Mar 8, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>服务器配置:</p><p><img src=/images/2019_03_08_10_46_27_657x334.jpg alt=/images/2019_03_08_10_46_27_657x334.jpg></p><p>按del键进入BIOS，更改启动顺序:</p><p><img src=/images/2019_03_08_10_46_52_404x161.jpg alt=/images/2019_03_08_10_46_52_404x161.jpg></p><p>插入ISO盘:</p><p><img src=/images/2019_03_08_10_47_11_600x196.jpg alt=/images/2019_03_08_10_47_11_600x196.jpg></p><p>选择English，进入安装界面:</p><p><img src=/images/2019_03_08_10_47_37_437x464.jpg alt=/images/2019_03_08_10_47_37_437x464.jpg></p><p>手动分区:</p><p><img src=/images/2019_03_08_10_48_04_651x401.jpg alt=/images/2019_03_08_10_48_04_651x401.jpg></p><p>原有分区, sda:</p><p><img src=/images/2019_03_08_10_48_24_498x336.jpg alt=/images/2019_03_08_10_48_24_498x336.jpg></p><p>删除后创建逻辑卷:</p><p><img src=/images/2019_03_08_10_48_52_527x249.jpg alt=/images/2019_03_08_10_48_52_527x249.jpg></p><p><img src=/images/2019_03_08_10_48_04_651x401.jpg alt=/images/2019_03_08_10_48_04_651x401.jpg></p><p>原有分区, sda:</p><p><img src=/images/2019_03_08_10_48_24_498x336.jpg alt=/images/2019_03_08_10_48_24_498x336.jpg></p><p>删除后创建逻辑卷:</p><p><img src=/images/2019_03_08_10_48_52_527x249.jpg alt=/images/2019_03_08_10_48_52_527x249.jpg></p><p>挂载到根分区:</p><p><img src=/images/2019_03_08_10_49_53_625x256.jpg alt=/images/2019_03_08_10_49_53_625x256.jpg></p><p>磁盘布局最后检查：</p><p><img src=/images/2019_03_08_10_50_08_528x210.jpg alt=/images/2019_03_08_10_50_08_528x210.jpg></p><p>Install continue。。。。</p><p>Grub配置，手动选择/dev/sda:</p><p><img src=/images/2019_03_08_10_50_41_565x297.jpg alt=/images/2019_03_08_10_50_41_565x297.jpg></p><p>重新启动，弹出光盘：</p><p>![/images/2019_03_08_10_51_09_450x162.jpg](/images/2019_03_08_10_51_09
Install continue。。。。</p><p>Grub配置，手动选择/dev/sda:</p><p><img src=/images/2019_03_08_10_50_41_565x297.jpg alt=/images/2019_03_08_10_50_41_565x297.jpg></p><p>重新启动，弹出光盘：</p><p><img src=/images/2019_03_08_10_51_09_450x162.jpg alt=/images/2019_03_08_10_51_09_450x162.jpg></p><p>System boot:</p><p><img src=/images/2019_03_08_10_51_36_583x410.jpg alt=/images/2019_03_08_10_51_36_583x410.jpg></p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2019/02/20/buildingpwkcd/>BuildingPWKCD</a></h1><span class=post-date>Feb 20, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><h3 id=makeiso-server>MakeISO Server</h3><p>Configure via:</p><pre><code># apt-get update -y 
# apt-get install -y vim openssh-server
</code></pre><p>Install cubic via:</p><pre><code># apt-add-repository ppa:cubic-wizard/release
# apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6494C6D6997C215E
# apt-get update -y &amp;&amp; apt-get install -y cubic
</code></pre><h3 id=cubic-make-iso>cubic make iso</h3><p>Start cubic via:</p><p><img src=/images/2019_02_20_16_20_41_429x333.jpg alt=/images/2019_02_20_16_20_41_429x333.jpg></p><p>Create the iso project folder:</p><pre><code># mkdir ~/isoproject
</code></pre><p>Slect the original disk image to customize:</p><p><img src=/images/2019_02_20_16_28_24_516x413.jpg alt=/images/2019_02_20_16_28_24_516x413.jpg></p><p>Cubic will copy the content from the origin folder to remote folder, this will
takes for some time:</p><p><img src=/images/2019_02_20_16_29_11_495x357.jpg alt=/images/2019_02_20_16_29_11_495x357.jpg></p><p>In chroot terminal you could custom the cd:</p><p><img src=/images/2019_02_20_16_32_14_516x207.jpg alt=/images/2019_02_20_16_32_14_516x207.jpg></p><h3 id=cd-customize>CD customize</h3><p>Install docker/docker-compose</p><pre><code># vim /etc/apt/sources.list(Changes to 163.com)
# apt-get install -y python-pip &amp;&amp; pip install docker-compose
# ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
# apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

# curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

# apt-key fingerprint 0EBFCD88
# add-apt-repository \
   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) \
   stable&quot;
# apt-get install docker-ce docker-ce-cli containerd.io
# docker version
</code></pre><p>The current Version is :</p><p><img src=/images/2019_02_20_16_52_47_505x133.jpg alt=/images/2019_02_20_16_52_47_505x133.jpg></p><p>Cause we are under chroot, we don&rsquo;t have server running.</p><p>We fetch the pwk ready machine&rsquo;s <code>/var/lib/docker</code>, transfer them into our
chroot env:</p><p><img src=/images/2019_02_20_17_06_27_549x122.jpg alt=/images/2019_02_20_17_06_27_549x122.jpg></p><p>We also need golang for running the pwk environment:</p><pre><code># apt-get install -y golang
# vim /root/.bashrc

</code></pre><p>Transfer the golang environment from the pwk ready machine:</p><pre><code># ls /root
 go/ Code/
</code></pre><p>systemd file:</p><pre><code>root@test-Standard-PC-Q35-ICH9-2009:/etc/systemd/system# cat mynginx.service 
[Unit]
Description=mynginx
Requires=docker.service
After=docker.service

[Service]
Restart=always
ExecStart=/usr/bin/docker start -a docker-nginx
ExecStop=/usr/bin/docker stop -t 2 docker-nginx

[Install]
WantedBy=multi-user.target

root@test-Standard-PC-Q35-ICH9-2009:/etc/systemd/system# cat playwithdockerblog.service 
[Unit]
Description=playwithdockerblog
After=docker.service
Requires=docker.service

[Service]
ExecStart=/usr/bin/docker-compose -f /root/Code/play-with-kubernetes.github.io/docker-compose.yml up -d

[Install]
WantedBy=multi-user.target
root@test-Standard-PC-Q35-ICH9-2009:/etc/systemd/system# cat playwithdocker.service 
[Unit]
Description=playwithdocker
After=docker.service
Requires=docker.service

[Service]
Environment=GOPATH=/root/go/
WorkingDirectory=/root/go/src/github.com/play-with-docker/play-with-docker
Type=idle
# Remove old container items
ExecStartPre=/usr/bin/docker-compose -f /root/go/src/github.com/play-with-docker/play-with-docker/docker-compose.yml down
# Compose up
ExecStart=/usr/bin/docker-compose -f /root/go/src/github.com/play-with-docker/play-with-docker/docker-compose.yml up -d

[Install]
WantedBy=multi-user.target
</code></pre><p>ToBeContinue, later I will change the static website content, and k8s image
offline, then do the iso-build.</p></div><div class=post><h1 class=post-title><a href=http://purplepalmdash.github.io/blog/2019/02/19/notesonplaywithk8s/>NotesOnPlayWithK8s</a></h1><span class=post-date>Feb 19, 2019<br><a class=a_cat href=http://purplepalmdash.github.io/categories/technology>Technology</a></span><p>早先在2018年做了一个离线版本的playwithk8s, 主要参考了:</p><p><a href=https://labs.play-with-k8s.com/>https://labs.play-with-k8s.com/</a></p><p>以及</p><p><a href=https://training.play-with-kubernetes.com/kubernetes-workshop/>https://training.play-with-kubernetes.com/kubernetes-workshop/</a></p><p>当时还写了一系列教程并形成了一个离线部署的ISO。那个ISO前几天有同事用，反映跑不起来。看了下问题，总结如下.</p><h3 id=dns问题>dns问题</h3><p>安装完的系统中，dnsmasq不能使用，需要通过以下步骤来修正:</p><pre><code># vim /etc/systemd/resolved.conf
DNSStubListener=no
# systemctl disable systemd-resolved.service
# systemctl stop systemd-resolved.service
# echo nameserver 192.168.0.15&gt;/etc/resolv.conf
# apt-get install -y dnsmasq
# systemctl enable dnsmasq
# vim /etc/dnsmasq.conf
address=/192.168.122.151/192.168.122.151
address=/localhost/127.0.0.1
# chattr +i /etc/resolv.conf
# chattr -e /etc/resolv.conf
# ufw disable
# docker swarm leave
# docker swarm init
</code></pre><p>这样下来可以访问到界面，</p><p><img src=/images/2019_02_19_15_05_45_1065x630.jpg alt=/images/2019_02_19_15_05_45_1065x630.jpg></p><h3 id=kubeadm卡顿>kubeadm卡顿</h3><p>卡在init的时候，现象见上图。</p><p>问题分析，在docker版本为17.12.1-ce的系统上可正常运行。</p><p>ISO安装出来的docker版本为18.06.0-ce.</p><p>是否是docker版本与kubeadm不兼容?</p><p>kubeadm生成的文件(/etc/kubernetes):</p><p><img src=/images/2019_02_19_15_08_49_565x229.jpg alt=/images/2019_02_19_15_08_49_565x229.jpg></p><p>对比kube-apiserver.yaml, 发现imagePullPolicy的不同:</p><p><img src=/images/2019_02_19_15_10_09_1106x395.jpg alt=/images/2019_02_19_15_10_09_1106x395.jpg></p><p>这点也是很让人奇怪的，为什么同样的容器镜像版本,
franela/k8s:latest会有如此的不同呢？
一样的容器镜像派生出来的实例，应该说其内置的kubeadm生成的yaml编排文件是一样的，但是在我们的系统上，更新版本的docker下生成的yaml文件未带IfNotPresent的选项，导致kubeadm认为镜像不存在，报了超时错误。</p><h3 id=解决途径>解决途径</h3><p>最近没有时间来做这个事情，所以只能先写下自己的思路。</p><ol><li><p>用一个registry缓存所有的包(去掉docker
load的环节），直接从cache里取回gcr.io的包。docker在启动的时候从cache里取东西回来。但是我不是很确定gcr.io是否可以像registry-1.docker.io一样被缓存下来。</p></li><li></li></ol><p>伪造gcr.io的签名，指向内部的registry仓库。这个可以仿照我的kubespray框架中的做法，骗过dind。</p><p>离线情况下玩docker，真是没事找事，一波三折啊！！！</p><h3 id=更新>更新</h3><p>最近没心思做别的事情，还是把这个PWK的离线给做了，记录一下步骤：</p><p>更新到新的play-with-kubernetes:</p><pre><code># git clone https://github.com/play-with-docker/play-with-kubernetes.github.io
</code></pre><p>当然在这里我们要做适配，以允许其离线化 。</p><p>采用的franela/k8s版本大约是2018年年底的版本，</p><pre><code># franela/k8s              latest              c7038cbdbc5d        2 months ago        733MB
</code></pre><p>因为这个容器镜像中的kubeadm版本已经升级到比较新的版本，需要重新下载镜像:</p><pre><code>k8s.gcr.io/kube-proxy-amd64                v1.11.7             e9a1134ab5aa        4 weeks ago         98.1MB
k8s.gcr.io/kube-apiserver-amd64            v1.11.7             d82b2643a56a        4 weeks ago         187MB
k8s.gcr.io/kube-controller-manager-amd64   v1.11.7             93fb4304c50c        4 weeks ago         155MB
k8s.gcr.io/kube-scheduler-amd64            v1.11.7             52ea1e0a3e60        4 weeks ago         56.9MB
weaveworks/weave-npc                       2.5.1               789b7f496034        4 weeks ago         49.6MB
weaveworks/weave-kube                      2.5.1               1f394ae9e226        4 weeks ago         148MB
k8s.gcr.io/coredns                         1.1.3               b3b94275d97c        9 months ago        45.6MB
k8s.gcr.io/etcd-amd64                      3.2.18              b8df3b177be2        10 months ago       219MB
k8s.gcr.io/pause                           3.1                 da86e6ba6ca1        14 months ago       742kB
nginx                                      latest              05a60462f8ba        2 years ago         181MB
</code></pre><p>同时需要更改kubeadm init的参数为:</p><pre><code># kubeadm init --apiserver-advertise-address $(hostname -i) --kubernetes-version=v1.11.7
</code></pre><p>在多节点章节中，kubeaadm
1.11.7与原先的calico3.1冲突，因而我们更新到了更新的3.5版本,
因为docker-in-docker配备了两个网络，我们在calico.yaml中也需要指定IP范围，以确保BGP隧道建立在正确的网络接口上:</p><pre><code>            - name: CALICO_IPV4POOL_CIDR
              value: &quot;192.168.0.0/16&quot;
            - name: IP_AUTODETECTION_METHOD
              value: &quot;interface=eth0.*&quot;

</code></pre><p>到此，则新版本的playwithk8s更新完毕，总共花了5天时间。虽然有点磨人，但想起来这5天还是值得的。</p></div><ul class=pagination><li class=page-item><a href=/ class=page-link aria-label=First><span aria-hidden=true>&#171;&#171;</span></a></li><li class=page-item><a href=/page/58/ class=page-link aria-label=Previous><span aria-hidden=true>&#171;</span></a></li><li class=page-item><a class=page-link href=/>1</a></li><li class=page-item><a class=page-link href=/page/2/>2</a></li><li class=page-item><a class=page-link href=/page/3/>3</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/58/>58</a></li><li class="page-item active"><a class=page-link href=/page/59/>59</a></li><li class=page-item><a class=page-link href=/page/60/>60</a></li><li class="page-item disabled"><span aria-hidden=true>&nbsp;&mldr;&nbsp;</span></li><li class=page-item><a class=page-link href=/page/235/>235</a></li><li class=page-item><a href=/page/60/ class=page-link aria-label=Next><span aria-hidden=true>&#187;</span></a></li><li class=page-item><a href=/page/235/ class=page-link aria-label=Last><span aria-hidden=true>&#187;&#187;</span></a></li></ul></div></div><script src=http://purplepalmdash.github.io/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>